{% extends 'base.html' %}
{% load static %}
{% load extras %}

{% block css %}
    <link href="{% static 'css/filepond.css' %}" rel="stylesheet">
    <style>
        #page-viewer-div {
            max-height: calc(100vh - 160px);
            overflow-y: scroll;
        }

        .page-card {
            min-width: calc(40vw - 20px);
            margin-bottom: 20px !important;
        }

        .page-card.selected {
            min-width: calc(90vw - 20px);
        }

        .page-image {
            cursor: pointer
        }

        .page-card .card-body {
            background-color: #F7F7F7;
            border-top: solid 1px #BFC0C0;
        }

        .page-number {
            display: inline-block;
        }

        .list-group-item {
            max-height: 500px;
            overflow-y: scroll;
        }

        #doc-provenance-div {
            max-height: 200px;
            overflow: auto;
            -ms-overflow-style: -ms-autohiding-scrollbar;
        }

        #job-report-div {
            max-height: calc(80vh);
            overflow-y: scroll;
            overflow-x: auto;
            white-space: pre-wrap;
            white-space: -moz-pre-wrap;
            white-space: -pre-wrap;
            white-space: -o-pre-wrap;
            word-wrap: break-word;
        }
    </style>
{% endblock %}

{% block modals %}
    <!-- UPLOAD DOCUMENT FILES MODAL -->
    <div class="modal fade" id="file-upload-modal" tabindex="-1" role="dialog" aria-labelledby="file-upload-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="file-upload-modal-label">Import Document File(s)</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="import-document-files-form" method="post">
                        {% csrf_token %}
                        <input type="hidden" id="import-document-files" name="import-document-files"/>
                    </form>
                    <div>
                        <input type="file" class="filepond" id="import-document-filepond">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" id="file-upload-reset-button" class="btn btn-secondary">Reset</button>
                    <button type="button" id="file-upload-import-button" class="btn btn-primary" disabled>Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Pages Modal -->
    <div class="modal fade" id="import-pages-modal" tabindex="-1" role="dialog" aria-labelledby="import-pages-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="import-pages-form" method="post">
                    {% csrf_token %}
                    <input type="hidden" id="import-pages-files" name="import-pages-files" value="[]" />
                    <div class="modal-header">
                        <h5 class="modal-title" id="import-pages-modal-label">Import Pages</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="import-pages-type" id="import-pages-type-pdf" value="pdf" checked>
                            <label class="form-check-label" for="import-pages-type-pdf">Import pages from PDF file</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="import-pages-type" id="import-pages-type-images" value="images">
                            <label class="form-check-label" for="import-pages-type-images">Import pages from multiple image files</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="import-pages-type" id="import-pages-type-zip" value="zip">
                            <label class="form-check-label" for="import-pages-type-zip">Import pages from zip file containing multiple images</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="import-pages-type" id="import-pages-type-iiif" value="iiif">
                            <label class="form-check-label" for="import-pages-type-iiif">Import pages from external IIIF server</label>
                        </div>
                        <div id="import-pages-options" class="mt-1">
                            <div class="form-group pdf-option">
                                <label for="import-pages-options-dpi">Image DPI</label>
                                <select id="import-pages-options-dpi" class="form-control" name="import-pages-image-dpi">
                                    <option value="300">300</option>
                                    <option value="150">150</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="import-pages-options-split">Split Images in Half Vertically?*</label>
                                <select id="import-pages-options-split" class="form-control" name="import-pages-split">
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                                <div class="text-muted">* Useful for double-paged scans.</div>
                            </div>
                            <div class="form-group pdf-option">
                                <label for="import-pages-options-extract-text">Extract Embedded Text?</label>
                                <select id="import-pages-options-extract-text" class="form-control" name="import-pages-extract-text">
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="import-pages-options-primary">Make Primary Witness?*</label>
                                <select id="import-pages-options-primary" class="form-control" name="import-pages-primary">
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                                <div class="text-muted">* If you have not yet imported any page images, or if you'd like to replace existing images as the primary witness for this document, this should remain set to 'Yes.'</div>
                            </div>
                        </div>
                        <div class="form-group import-pages-pdf-source-options">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="import-pages-pdf-source" id="import-pages-pdf-source-upload" value="upload" checked>
                                <label class="form-check-label" for="impport-pages-pdf-source-upload">Upload New PDF</label>
                            </div>
                        </div>
                        <div id="import-pages-filepond-div" class="form-group">
                            <input id="import-pages-filepond" class="filepond" type="file">
                        </div>
                        <div id="import-pages-iiif-ids-div" class="form-group d-none">
                            <label for="import-pages-iiif-ids-box">IIIF Identifiers<br /><span class="text-muted">One per line in page order</span></label>
                            <textarea id="import-pages-iiif-ids-box" class="form-control" rows="5" name="import-pages-iiif-ids"></textarea>
                        </div>
                        <div class="form-group import-pages-pdf-source-options">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="import-pages-pdf-source" id="import-pages-pdf-source-existing" value="existing">
                                <label class="form-check-label" for="import-pages-pdf-source-existing">Use Existing Document File</label>
                            </div>
                        </div>
                        <div class="form-group import-pages-pdf-source-options">
                            <select id="import-pages-pdf-existing-file" class="form-control" name="import-pages-pdf-existing-file">
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="import-pages-submit-button" disabled>Import</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- PageSet Modal -->
    <div class="modal fade" id="pageset-modal" tabindex="-1" role="dialog" aria-labelledby="pageset-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="pageset-form" method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="pageset-modal-label">New Page Set</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="pageset-name-box">Name</label>
                            <input type="text" class="form-control" id="pageset-name-box" name="pageset-name" />
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <div class="form-group">
                                    <label for="pageset-start-box">Starting Page</label>
                                    <input type="text" class="form-control" id="pageset-start-box" name="pageset-start" />
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-group">
                                    <label for="pageset-end-box">Ending Page</label>
                                    <input type="text" class="form-control" id="pageset-end-box" name="pageset-end" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Transcription Modal -->
    <div class="modal fade" id="trans-modal" tabindex="-1" role="dialog" aria-labelledby="trans-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="trans-form" method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="trans-modal-label">Transcribe</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="trans-project-group" class="form-group">
                            <label for="trans-project-selector">Transcription Project</label>
                            <select id="trans-project-selector" class="form-control" name="trans-project">
                                {% if response.scholar.is_admin or role == 'Editor' %}<option value="new">New project...</option>{% endif %}
                            </select>
                        </div>

                        <div id="trans-new-project-div" class="d-none">
                            <div class="form-group">
                                <label for="trans-name-box">Transcription Project Name</label>
                                <input type="text" class="form-control" id="trans-name-box" name="trans-name" />
                            </div>
                            <div class="form-group">
                                <label for="trans-pageset-selector">Page Set</label>
                                <select id="trans-pageset-selector" class="form-control" name="trans-pageset">
                                    <option value="all">All Pages</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="trans-image-pfc-selector">Image Collection</label>
                                <select id="trans-image-pfc-selector" class="form-control" name="trans-image-pfc">
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="trans-ocr-pfc-selector">OCR Collection</label>
                                <select id="trans-ocr-pfc-selector" class="form-control" name="trans-ocr-pfc">
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="trans-plain-text-selector">Plain Text Transcription</label>
                                <select id="trans-plain-text-selector" class="form-control" name="trans-plain-text">
                                    <option value="none">None</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="trans-level-selector">Granularity</label>
                                <select id="trans-level-selector" class="form-control" name="trans-level">
                                    <option value="line">Lines</option>
                                    <option value="paragraph">Paragraphs</option>
                                    <option value="arbitrary">Arbitrary</option>
                                </select>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="trans-markup" id="trans-markup-checkbox" checked>
                                <label class="form-check-label" for="trans-markup-checkbox">Allow Markup?</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button id="trans-go-button" type="submit" class="btn btn-primary">Start</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Job Finished Modal -->
    <div class="modal fade" id="job-finished-modal" tabindex="-1" role="dialog" aria-labelledby="job-finished-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="job-finished-modal-label">Job Completed</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        One or more jobs have completed for this document. Click the "Refresh" button below to view results.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="window.location = window.location.href;">Refresh</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block main %}
    <div class="container-fluid">
        <ul id="content-nav-tabs" class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="metadata-tab" data-toggle="tab" href="#metadata" role="tab" aria-controls="metadata" aria-selected="true">Document</a>
            </li>
            {% if not popup %}
                <li class="nav-item" role="presentation">
                    <a class="nav-link disabled" id="explore-tab" data-toggle="tab" href="#explore" role="tab" aria-controls="explore" aria-selected="false">Explore</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="associated-tab" data-toggle="tab" href="#associated" role="tab" aria-controls="associated" aria-selected="false">Associated Content</a>
                </li>
            {% endif %}
        </ul>
        <div class="tab-content h-100 {% if popup %}p-0 m-0{% else %}p-3{% endif %}">
            <div class="tab-pane fade show active" id="metadata" role="tabpanel" aria-labelledby="metadata-tab">

                <div class="row">

                    <!-- METADATA -->
                    <div class="col-sm-12 col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h4 class="float-left">Metadata</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="list-group" id="doc-metadata-list">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- JOBS -->
                    <div class="col-sm-12 col-md-6">
                        <div class="row">
                            <div class="col-12">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <h4>Running Jobs</h4>
                                            <span>
                                                {% if response.scholar.is_admin or role == 'Editor' %}
                                                    <button id="run-job-button" class="btn btn-primary rounded" type="button">Run Job</button>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    <div id="jobs-container" class="card-body">
                                        <!-- populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h4>Provenance</h4>
                                    </div>
                                    <div class="card-body">
                                        <div id="doc-provenance-div">
                                            <div class="alert alert-info">
                                                No jobs have been completed for this document.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="row">

                    <!-- PAGES -->
                    <div class="col-12">
                        <div id="pages-card" class="card mb-3">
                            <div class="card-header" style="border-bottom: none;">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h4 id="pages-title">Pages</h4>
                                    <span id="page-action-buttons-span">
                                {% if response.scholar.is_admin or role == 'Editor' %}
                                    <button id="import-pages-button" class="btn btn-primary rounded" type="button">Import</button>
                                {% else %}
                                    &nbsp
                                {% endif %}
                                    </span>
                                </div>
                            </div>
                            <div id="page-viewer-control-div" class="d-flex w-100 justify-content-between align-items-center p-2 control-div">
                                <div class="form-inline">
                                    <button id="go-prev-page-button" type="button" class="btn btn-primary rounded" disabled><span class="fas fa-caret-left"></span></button>
                                    <input id="go-page-box" type="text" class="form-control" style="width: 60px;" value="1">
                                    <button id="go-next-page-button" type="button" class="btn btn-primary rounded"><span class="fas fa-caret-right"></span></button>
                                </div>

                                <ul id="page-viewer-controls" class="nav nav-pills">
                                    <li class="nav-item dropleft">
                                        <a class="nav-link dropdown-toggle active" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" style="padding-top: 5px; padding-bottom: 5px;">Image Collection</a>
                                        <div class="dropdown-menu" id="page-viewer-left-options">
                                        </div>
                                    </li>

                                    <li class="nav-item dropleft ml-2 d-none" style="padding-top: 5px; padding-bottom: 5px;">
                                        <a class="nav-link dropdown-toggle active" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" style="padding-top: 5px; padding-bottom: 5px;">Witness</a>
                                        <div class="dropdown-menu" id="page-viewer-right-options">
                                            <a class="dropdown-item" href="javascript: set_collection('right', '');">None</a>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <div id="page-viewer-div">
                                    <div class="col-12 alert alert-info">
                                        There are currently no pages for this document. Click the "Import" button above to import pages from image files or a PDF.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">

                    <!-- DOCUMENT FILES -->
                    <div class="col-12">
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h4>Document Files</h4>
                                    {% if response.scholar.is_admin or role == 'Editor' %}
                                        <button id="import-document-files-button" class="btn btn-primary rounded" type="button">Import</button>
                                    {% else %}
                                        <span>&nbsp;</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-body" id="doc-files-div">
                                <div class="alert alert-info">
                                    There are currently no files for this document.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">

                    <!-- PAGE SETS -->
                    <div class="col-12">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h4>Page Sets</h4>
                            </div>
                            <div class="card-body" id="doc-pageset-div">
                                <div class="alert alert-info">
                                    No page sets defined for this document.
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="row">

                    <!-- PAGE FILE COLLECTIONS -->
                    <div class="col-12">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h4>Page File Collections</h4>
                            </div>
                            <div class="card-body" id="doc-pfc-div">

                            </div>
                        </div>
                    </div>

                </div>
            </div>
            {% if not popup %}
                <div class="tab-pane fade" id="explore" role="tabpanel" aria-labelledby="explore-tab" style="height: 825px;">
                    <div id="explore-legend" class="d-inline-flex align-items-center"></div>
                    <div id="explore-div" style="height: 800px;"></div>
                </div>
                <div class="tab-pane fade" id="associated" role="tabpanel" aria-labelledby="associated-tab">
                    <!-- ASSOCIATED CONTENT -->
                    <div class="row">
                        <div class="col-12">
                            <div id="associated-content-div">
                                <div class="alert alert-info">
                                    There is no content associated with this document.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block js %}
    <script src="{% static 'js/filepond.js' %}"></script>
    <script src="{% static 'js/ace/ace.js' %}"></script>
    <script src="{% static 'js/vis-network.js' %}"></script>
    <script type="application/javascript">
        let corpus_id = '{{ corpus_id }}'
        let corpus = null

        let document_id = '{{ document_id }}'
        let document_uri = `/corpus/${corpus_id}/Document/${document_id}`
        let doc = null
        let network = null

        let role = '{{ role }}'
        let popup = {% if popup %}true{% else %}false{% endif %}

        let file_upload_path = ''
        let file_uploads = []
        let import_files = []

        let import_pages_files = []
        let job_manager = null
        let jobsites = []
        let local_jobsite_id = null
        let job_report_timer = null
        let tasks = []
        let bbox_collections = []
        let pfc_setting = {
            left: null,
            right: null
        }
        let ref_no = 1
        let page_observer = null

        // CREATE FILE POND FOR IMPORT PAGES MODAL
        const import_pages_pond = FilePond.create(document.querySelector('#import-pages-filepond'), {
            allowMultiple: true,
            allowRevert: true,
            chunkUploads: true,
            chunkSize: 500000,
            credits: false,
            server: {
                url: '/fp',
                process: '/process/',
                patch: '/patch/',
                revert: '/revert/',
                fetch: '/fetch/?target=',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            }
        })
        import_pages_pond.on('processfile', (error, file) => {
            if(!error) {
                $("#import-pages-submit-button").attr('disabled', false)
                import_pages_files.push(file.serverId)
            }
        })

        // CREATE FILE POND FOR IMPORT DOCUMENT FILES (SELECT FILE) MODAL
        const import_document_file_pond = FilePond.create(document.querySelector('#import-document-filepond'), {
            allowMultiple: true,
            allowRevert: true,
            chunkUploads: true,
            chunkSize: 500000,
            credits: false,
            server: {
                url: '/fp',
                process: '/process/',
                patch: '/patch/',
                revert: '/revert/',
                fetch: '/fetch/?target=',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            }
        })
        import_document_file_pond.on('processfile', (error, file) => {
            if(!error) {
                import_files.push(file.serverId)
                let import_button = $('#file-upload-import-button')
                import_button.attr('disabled', false)
            }
        })

        $('#page-carousel').on('slide.bs.carousel', function(ev) {
            let lazy
            lazy = $(ev.relatedTarget).find("img[data-src]")
            lazy.attr("src", lazy.data('src'))
            lazy.removeAttr("data-src")
        })

        $(document).ready(function() {
            corpora.get_jobsites(function(jobsites_data) {
                jobsites = jobsites_data
                for (let x = 0; x < jobsites.length; x++) {
                    if (jobsites[x].name === 'Local') {
                        local_jobsite_id = jobsites[x].id
                    }
                }

                corpora.get_tasks('Document', function(tasks_data) {
                    tasks = tasks_data

                    corpora.get_corpus(corpus_id, function(corpus_data) {
                        corpus = corpus_data
                        add_breadcrumb(corpus.name, `/corpus/${corpus_id}/`)

                        // ------------------------
                        // SETUP DOCUMENT
                        // ------------------------
                        corpora.get_content(corpus_id, 'Document', document_id, function (document_data) {
                            doc = document_data
                            add_breadcrumb(doc.label, document_uri)

                            let page_title = $('#page-title')
                            page_title.html(doc.label)
                            if (corpora.scholar_has_privilege('Contributor', corpus.scholar_role)) {
                                page_title.append(`
                                    <a href="/corpus/${corpus_id}/Document/${doc.id}/edit/">
                                        <span class="fas fa-edit"></span>
                                    </a>
                                `)
                            }

                            // LOAD DOCUMENT METADATA
                            let doc_metadata_list = $('#doc-metadata-list')
                            corpus.content_types.Document.fields.forEach( field => {
                                if (field.multiple) {
                                    if (doc[field.name].length) {
                                        let field_values = []

                                        if (['text', 'large_text', 'keyword', 'number'].includes(field.type)) {
                                            field_values = doc[field.name]
                                        } else if (field.type === "cross_reference") {
                                            doc[field.name].map(field_value => {
                                                field_values.push(`<a href="${field_value.uri}/">${field_value.label}</a>`)
                                            })
                                        }

                                        doc_metadata_list.append(`
                                            <div class="list-group-item">
                                                <h5>${field.label}</h5>
                                                ${field_values.join('<br />')}
                                            </div>
                                        `)
                                    }
                                } else {
                                    if (doc[field.name]) {
                                        if (['text', 'large_text', 'keyword', 'number'].includes(field.type)) {
                                            doc_metadata_list.append(`
                                                <div class="list-group-item">
                                                    <h5>${field.label}</h5>
                                                    ${doc[field.name]}
                                                </div>
                                            `)
                                        } else if (field.type === "cross_reference") {
                                            doc_metadata_list.append(`
                                                <div class="list-group-item">
                                                    <h5>${field.label}</h5>
                                                    <a href="${doc[field.name].uri}/">${doc[field.name].label}</a>
                                                </div>
                                            `)
                                        }
                                    }
                                }
                            })

                            // LOAD DOCUMENT FILES
                            let doc_files_div = $('#doc-files-div')
                            if (Object.keys(doc.files).length > 0) {
                                doc_files_div.html(`
                                    <table class="table table-striped">
                                        <thead class="thead-dark">
                                            <th scope="col">
                                                File
                                            </th>
                                            <th scope="col">
                                                Description
                                            </th>
                                            <th scope="col">
                                                Extension
                                            </th>
                                            <th scope="col">
                                                Size (bytes)
                                            </th>
                                        </thead>
                                        <tbody id="doc-files-table-body">
                                        </tbody>
                                    </table>
                                `)

                                let doc_files_tbody = $('#doc-files-table-body')
                                for (let file_key in doc.files) {
                                    let file = doc.files[file_key]

                                    let file_url = corpora.file_url(file.uri)
                                    if (file.is_image) {
                                        file_url = corpora.image_url(file.uri)
                                    }

                                    let open_mode = 'target="_blank"'
                                    if (file.extension === 'zip') {
                                        open_mode = `download="${file.basename}"`
                                    }

                                    doc_files_tbody.append(`
                                        <tr>
                                            <td>
                                                <a href="${file_url}" target="_blank">${file.basename}</a>
                                            </td>
                                            <td>
                                                ${file.description}
                                            </td>
                                            <td>
                                                ${file.extension}
                                            </td>
                                            <td>
                                                ${file.byte_size}
                                            </td>
                                        </tr>
                                    `)
                                }

                                if (doc.has_primary_text) {
                                    doc_files_div.append(`
                                        <a href="${document_uri}/tei-skeleton" class="btn btn-primary ml-1" download>Download TEI XML Skeleton</a>
                                    `)
                                }
                            }

                            // SETUP DOCUMENT FILE IMPORTS
                            $('#import-document-files-button').click(function() {
                                $('#file-upload-modal').modal()
                            })
                            $('#file-upload-import-button').click(function() {
                                $('#import-document-files').val(JSON.stringify(import_files))
                                $('#import-document-files-form').submit()
                            })

                            // LOAD DOCUMENT PAGESETS
                            let doc_pageset_div = $('#doc-pageset-div')
                            if (Object.keys(doc.page_sets).length > 0) {
                                doc_pageset_div.html('')
                                doc_pageset_div.append(`
                                    <table class="table table-striped">
                                        <thead class="thead-dark">
                                            <th scope="col">
                                                Name
                                            </th>
                                            <th scope="col">
                                                Starting Page
                                            </th>
                                            <th scope="col">
                                                Ending Page
                                            </th>
                                            <th scope="col">
                                                Actions
                                            </th>
                                        </thead>
                                        <tbody id="doc-pageset-tbody">
                                    </table>
                                `)

                                let doc_pageset_tbody = $('#doc-pageset-tbody')
                                let tei_buttons = ""
                                for (let ps_key in doc.page_sets) {
                                    if (doc.has_primary_text) {
                                        tei_buttons = `
                                            <a href="${document_uri}/tei-skeleton?pageset=${ps_key}" class="btn btn-primary ml-1" download>Download TEI XML Skeleton</a>
                                        `
                                    }

                                    doc_pageset_tbody.append(`
                                        <tr>
                                            <td>
                                                ${doc.page_sets[ps_key].label}
                                            </td>
                                            <td>
                                                ${doc.page_sets[ps_key].starting_ref_no}
                                            </td>
                                            <td>
                                                ${doc.page_sets[ps_key].ending_ref_no}
                                            </td>
                                            <td>
                                                ${tei_buttons}
                                            </td>
                                        </tr>
                                    `)
                                }
                            }

                            // LOAD PAGE FILE COLLECTIONS
                            let doc_pfc_div = $('#doc-pfc-div')
                            let page_viewer_left_options = $('#page-viewer-left-options')
                            let page_viewer_right_options = $('#page-viewer-right-options')
                            if (Object.keys(doc.page_file_collections).length > 0) {
                                doc_pfc_div.html('<div class="list-group" id="doc-pfc-group"></div>')
                                let doc_pfc_group = $('#doc-pfc-group')
                                let pfc_counter = 0
                                for (let slug in doc.page_file_collections) {
                                    let pfc = doc.page_file_collections[slug]
                                    let label = pfc.label
                                    let text_consolidation_form = ''

                                    if (label.includes('GCV TextAnnotation Object') || label.includes('HOCR')) {
                                        bbox_collections.push(slug)
                                    } else if (label.includes('Image')) {
                                        page_viewer_left_options.append(`
                                            <a class="dropdown-item" href="javascript: set_collection('left', '${slug}');">${label}</a>
                                        `)
                                    } else if (label.includes('Plain Text') && (role === 'Editor' || role === 'Admin')) {
                                        text_consolidation_form = `
                                            <form method="post">
                                                <input type="hidden" name="csrfmiddlewaretoken" value="${corpora.csrf_token}">
                                                <input type="hidden" name="collection" value="${slug}"/>
                                                <input type="hidden" name="consolidate-files" value="y"/>
                                                <button type="submit" class="btn btn-primary mr-2">Create a Consolidated Text File</button>
                                            </form>
                                        `
                                        page_viewer_right_options.append(`
                                            <a class="dropdown-item" href="javascript: set_collection('right', '${slug}');">${label}</a>
                                        `)
                                    } else if (label.includes('HTML')) {
                                        page_viewer_right_options.append(`
                                            <a class="dropdown-item" href="javascript: set_collection('right', '${slug}');">${label}</a>
                                        `)
                                    }

                                    let zip_file_form = ''
                                    if (local_jobsite_id) {
                                        let zip_page_file_task_id = ''
                                        for (let x = 0; x < tasks.length; x++) {
                                            if (tasks[x].name === "Zip Page File Collection") {
                                                zip_page_file_task_id = tasks[x].id
                                            }
                                        }

                                        if (role === 'Editor' || role === 'Admin') {
                                            zip_file_form = `
                                                <form method="post">
                                                    <input type="hidden" name="csrfmiddlewaretoken" value="${corpora.csrf_token}">
                                                    <input type="hidden" name="collection" value="${slug}"/>
                                                    <input type="hidden" name="jobsite" value="${local_jobsite_id}"/>
                                                    <input type="hidden" name="task" value="${zip_page_file_task_id}"/>
                                                    <button type="submit" class="btn btn-primary">Create a .zip File</button>
                                                </form>
                                            `
                                        }
                                    }

                                    doc_pfc_group.append(`
                                        <div id="page-file-collection-${pfc_counter}-container" class="list-group-item">
                                        <h5>
                                            <button class="btn btn-link" data-toggle="collapse" data-target="#page-file-collection-${pfc_counter}" aria-expanded="false" aria-controls="page-file-collection-${pfc_counter}">
                                                <span id="page-file-collection-${pfc_counter}-indicator" class="fas fa-caret-right"></span>
                                                ${label}
                                            </button>
                                        </h5>
                                        <div id="page-file-collection-${pfc_counter}" class="alert alert-info collapse" aria-labelledby="page-file-collection-${pfc_counter}-container" data-parent="#page-file-collection-group">
                                            <div class="mb-2 w-100 form-inline">
                                                ${text_consolidation_form}
                                                ${zip_file_form}
                                            </div>
                                            <table class="table table-striped">
                                                <thead class="thead-dark">
                                                    <th scope="col">
                                                        Page #
                                                    </th>
                                                    <th scope="col">
                                                        Link
                                                    </th>
                                                    <th scope="col">
                                                        Size (bytes)
                                                    </th>
                                                    <th scope="col">
                                                        Action
                                                    </th>
                                                </thead>
                                                <tbody id="doc-pfc-${pfc_counter}-tbody">
                                                </tbody>
                                            </table>
                                        </div>
                                    `)

                                    let doc_pfc_div = $(`#page-file-collection-${pfc_counter}`)
                                    let doc_pfc_indicator = $(`#page-file-collection-${pfc_counter}-indicator`)
                                    doc_pfc_div.on('shown.bs.collapse', function() {
                                        doc_pfc_indicator.removeClass('fa-caret-right')
                                        doc_pfc_indicator.addClass('fa-caret-down')
                                    })
                                    doc_pfc_div.on('hidden.bs.collapse', function() {
                                        doc_pfc_indicator.removeClass('fa-caret-down')
                                        doc_pfc_indicator.addClass('fa-caret-right')
                                    })

                                    let doc_pfc_tbody = $(`#doc-pfc-${pfc_counter}-tbody`)
                                    for (let ref_no in pfc.page_files) {
                                        let file = pfc.page_files[ref_no]

                                        let mode = 'target="_blank"'
                                        if (label.includes('Object')) { mode = 'download'; }

                                        let link = `<a href="${corpora.file_url(file.uri)}" ${mode}>${file.basename}</a>`
                                        if (label.includes('Image')) {
                                            link = `<a href="${corpora.image_url(file.uri)}" ${mode}>${file.basename}</a>`
                                        }

                                        let actions = ''
                                        if (label.includes('HOCR') || label.includes('GCV TextAnnotation')) {
                                            actions = `<a href="${document_uri}/draw-page-regions/${ref_no}/?ocrfile=${file.path}" target="_blank" class="btn btn-primary ml-1">Fix OCR Regions</a>`
                                        }

                                        doc_pfc_tbody.append(`
                                            <tr>
                                                <td>
                                                    ${ref_no}
                                                </td>
                                                <td>
                                                    ${link}
                                                </td>
                                                <td>
                                                    ${file.byte_size}
                                                </td>
                                                <td>
                                                    ${actions}
                                                </td>
                                            </tr>
                                        `)
                                    }

                                    pfc_counter += 1
                                }
                            }

                            // LOAD PAGE VIEWER USER PREFERENCES
                            corpora.get_preference(
                                'Document',
                                document_uri,
                                'page_viewer_left_collection',
                                function (left_pref) {
                                    pfc_setting.left = left_pref
                                }
                            )

                            corpora.get_preference(
                                'Document',
                                document_uri,
                                'page_viewer_right_collection',
                                function (right_pref) {
                                    pfc_setting.right = right_pref
                                    $('#page-viewer-control-div').removeClass('d-none')
                                    //show_page()
                                    load_pages()
                                }
                            )

                            // SETUP PAGE TASK BUTTONS
                            if(corpora.scholar_has_privilege('Contributor', corpus.scholar_role)) {
                                let custom_job_parameter_types = {
                                    document_transcription_project: function(param_name, param) {
                                        let select_options = ''
                                        $('option.transcription-project').each(function() {
                                            let trans_project = $(this)
                                            select_options += `<option value="${trans_project.attr('value')}">${trans_project.html()}</option>`
                                        })

                                        return `
                                            <div class="form-group">
                                                <label for="${param_name}-trans-project-selector">${param.label}</label>
                                                <select id="${param_name}-trans-project-selector" class="form-control job-parameter-value" name="${param_name}">
                                                    ${select_options}
                                                </select>
                                                ${param.note ? `<span class='text-muted'>${param.note}</span>` : ''}
                                            </div>
                                        `
                                    }
                                }

                                if (corpora.scholar_has_privilege('Editor', corpus.scholar_role)) {
                                    custom_job_parameter_types.page_file_collection = function(param_name, param) {
                                        let select_options = ''
                                        for (let slug in doc.page_file_collections) {
                                            select_options += `<option value="${slug}">${doc.page_file_collections[slug].label}</option>\n`
                                        }

                                        return `
                                            <div class="form-group">
                                                <label for="${param_name}-collection-selector">${param.label}</label>
                                                <select id="${param_name}-collection-selector" class="form-control job-parameter-value" name="${param_name}">
                                                    ${select_options}
                                                </select>
                                                ${param.note ? `<span class='text-muted'>${param.note}</span>` : ''}
                                            </div>
                                        `
                                    }
                                    custom_job_parameter_types.document_pageset = function(param_name, param) {
                                        let select_options = ''
                                        Object.keys(doc.page_sets).forEach(ps_key => {
                                            select_options += `<option value="${ps_key}">${doc.page_sets[ps_key].label}</option>`
                                        })

                                        return `
                                            <div class="form-group">
                                                <label for="${param_name}-ps-selector">${param.label}</label>
                                                <select id="${param_name}-ps-selector" class="form-control job-parameter-value" name="${param_name}">
                                                    <option value="none">All Pages</option>
                                                    ${select_options}
                                                </select>
                                                ${param.note ? `<span class='text-muted'>${param.note}</span>` : ''}
                                            </div>
                                        `
                                    }
                                    custom_job_parameter_types.document_file = function(param_name, param) {
                                        let select_options = ''
                                        Object.keys(doc.files).forEach(file_key => {
                                            select_options += `<option value="${file_key}">${doc.files[file_key].basename}</option>`
                                        })

                                        return `
                                            <div class="form-group">
                                                <label for="${param_name}-file-selector">${param.label}</label>
                                                <select id="${param_name}-file-selector" class="form-control job-parameter-value" name="${param_name}">
                                                    ${select_options}
                                                </select>
                                                ${param.note ? `<span class='text-muted'>${param.note}</span>` : ''}
                                            </div>
                                        `
                                    }
                                }

                                // -----------------
                                // SETUP JOB MANAGER
                                // -----------------
                                job_manager = new JobManager({
                                    jobs_container: 'jobs-container',
                                    provenance_container: 'doc-provenance-div',
                                    provenance: doc.provenance,
                                    corpora: corpora,
                                    corpus: corpus,
                                    content_type: 'Document',
                                    content_id: document_id,
                                    scholar_id: scholar_id,
                                    custom_parameter_types: custom_job_parameter_types
                                })

                                setTimeout(function() {
                                    $('#job-modal').on('show.bs.modal', function() {
                                        let tasks_to_remove = []
                                        $('.job-task').each(function() {
                                            let task_name = $(this).html()
                                            if (task_name.includes("Import Document Pages")) {
                                                tasks_to_remove.push(this)
                                            }
                                        })
                                        tasks_to_remove.forEach(t => {
                                            $(t).remove()
                                        })
                                    })
                                }, 3000)

                                if (corpora.scholar_has_privilege('Editor', corpus.scholar_role)) {
                                    $('#page-action-buttons-span').append(`
                                        <button id="create-pageset-button" class="btn btn-primary rounded ml-1" type="button">Create Page Set</button>
                                    `)

                                    $("#create-pageset-button").click(function() {
                                        $("#pageset-modal").modal()
                                    })

                                    $("#run-job-button").click(function() {
                                        job_manager.new_job('Document', document_id)
                                    })
                                }

                                $('#page-action-buttons-span').append(`
                                    <button id="transcribe-button" class="btn btn-primary rounded ml-1" type="button">Transcribe</button>
                                `)

                                // -------------------
                                // SETUP TRANSCRIBE MODAL
                                // -------------------
                                let trans_project_selector = $('#trans-project-selector')
                                let trans_pageset_selector = $('#trans-pageset-selector')
                                let trans_image_pfc_selector = $('#trans-image-pfc-selector')
                                let trans_ocr_pfc_selector = $('#trans-ocr-pfc-selector')
                                let trans_plain_text_selector = $('#trans-plain-text-selector')
                                let trans_go_button = $('#trans-go-button')

                                // project selector
                                let trans_project_search = {
                                    'f_document.id': document_id,
                                    's_name': 'asc'
                                }
                                corpora.list_content(corpus_id, 'TranscriptionProject', trans_project_search, function(data) {
                                    if (data && data.hasOwnProperty('meta') && data.hasOwnProperty('records') && data.records.length) {
                                        let trans_projects = ''
                                        data.records.map(trans_project => {
                                            trans_projects += `
                                                <option class='transcription-project' value='${trans_project.id}' ${trans_projects ? '' : 'selected'}>${trans_project.name}</option>
                                            `
                                        })
                                        trans_project_selector.prepend(trans_projects)
                                        trans_go_button.html('Continue')
                                    } else {
                                        $('#trans-project-group').addClass('d-none')
                                        if (corpora.scholar_has_privilege('Editor', corpus.scholar_role))
                                            $('#trans-new-project-div').removeClass('d-none')
                                        else
                                            $('#transcribe-button').prop('disabled', true)
                                    }
                                }, true)
                                trans_project_selector.change(function() {
                                    if (trans_project_selector.val() === 'new') {
                                        $('#trans-new-project-div').removeClass('d-none')
                                        trans_go_button.html('Start')
                                    } else {
                                        $('#trans-new-project-div').addClass('d-none')
                                        trans_go_button.html('Continue')
                                    }
                                })

                                // page set selector
                                for (let ps_key in doc.page_sets) {
                                    trans_pageset_selector.append(`
                                        <option value="${ps_key}">${doc.page_sets[ps_key].label}</option>
                                    `)
                                }

                                // image/ocr collection selector
                                for (let pfc_key in doc.page_file_collections) {
                                    if (pfc_key.includes('image')) {
                                        trans_image_pfc_selector.append(`
                                            <option value="${pfc_key}">${doc.page_file_collections[pfc_key].label}</option>
                                        `)
                                    } else if (pfc_key.includes('hocr') || pfc_key.includes('json')) {
                                        trans_ocr_pfc_selector.append(`
                                            <option value="${pfc_key}">${doc.page_file_collections[pfc_key].label}</option>
                                        `)
                                    }
                                }
                                trans_ocr_pfc_selector.append(`<option value="none">None</option>`)

                                // plain text selector
                                Object.keys(doc.files).forEach(file_key => {
                                    if (doc.files[file_key].extension === 'txt')
                                        trans_plain_text_selector.append(`<option value="${file_key}">${doc.files[file_key].basename}</option>`)
                                })

                                $('#transcribe-button').click(function() {
                                    $('#trans-modal').modal()
                                })
                            }

                            if (!popup) {
                                // INITIAL EXPLORE VIZ LOAD
                                let explore_container_width = $('#content-nav-tabs').innerWidth()
                                $('#explore-div').css("width", `${explore_container_width}px`)
                                network = new ContentGraph(
                                    corpora,
                                    corpus_data,
                                    "explore-div",
                                    "explore-legend",
                                    {
                                        'seeds': [document_uri],
                                        'per_type_limit': 5,
                                        'width': explore_container_width,
                                        'height': 800
                                    }
                                )
                                $('#explore-tab').removeClass('disabled')

                                $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                                    if (e.target.id === 'explore-tab') {
                                        network.network.fit({nodes: [document_uri]})
                                    }
                                })

                                // ASSOCIATED CONTENT
                                let associated_cts = {}
                                for (let content_type in corpus.content_types) {
                                    let ct = corpus.content_types[content_type]
                                    ct.fields.map(field => {
                                        if (field.type === 'cross_reference' && field.cross_reference_type === 'Document') {
                                            associated_cts[ct.name] = field.name
                                        }
                                    })
                                }

                                if (associated_cts) {
                                    $('#associated-content-div').html('')
                                    for (let ct_name in associated_cts) {
                                        let associated_search = {
                                            page: 1,
                                            'page-size': 5,
                                        }
                                        associated_search[`f_${associated_cts[ct_name]}.id`] = document_id

                                        let ct_table = new ContentTable({
                                            container_id: 'associated-content-div',
                                            corpora: corpora,
                                            corpus: corpus,
                                            content_type: ct_name,
                                            search: associated_search
                                        })
                                    }
                                }
                            }

                            hide_loading_overlay()
                        })
                    }, true)
                })
            })

            // ------------------------
            // SETUP COLLAPSIBLE PAGE FILE COLLECTIONS
            // ------------------------
            $('.collapse').on('show.bs.collapse', function (event) {
                let indicator_id = event.target.id + "-indicator"
                $("#" + indicator_id).removeClass("fa-caret-right")
                $("#" + indicator_id).addClass("fa-caret-down")
            })

            $('.collapse').on('hidden.bs.collapse', function (event) {
                let indicator_id = event.target.id + "-indicator"
                $("#" + indicator_id).removeClass("fa-caret-down")
                $("#" + indicator_id).addClass("fa-caret-right")
            })

            // ------------------------
            // SETUP PAGE VIEWER CONTROLS
            // ------------------------
            $("#go-prev-page-button").click(function() {
                ref_no = parseInt($('#go-page-box').val())
                ref_no -= 1
                show_page()
            })
            $("#go-next-page-button").click(function() {
                ref_no = parseInt($('#go-page-box').val())
                ref_no += 1
                show_page()
            })
            $("#go-page-box").keypress(function(e){
                let key = e.which
                if (key == 13) {
                    ref_no = parseInt($("#go-page-box").val())
                    if (isNaN(ref_no)) { ref_no = 1; }
                    show_page()
                }
            })

            if (role === 'Editor' || role === 'Admin') {
                // ------------------------
                // SETUP IMPORT PAGES MODAL
                // ------------------------
                $("#import-pages-button").click(function () {
                    $("#import-pages-submit-button").attr('disabled', true)

                    // SETUP PDF SOURCE OPTIONS
                    $('#import-pages-pdf-source-upload').prop('checked', true)
                    $('#import-pages-pdf-source-existing').prop('checked', false)

                    let has_pdf_file = false
                    let pdf_source_options = $('.import-pages-pdf-source-options')
                    let existing_pdf_selector = $('#import-pages-pdf-existing-file')
                    Object.keys(doc.files).forEach(file_key => {
                        if (doc.files[file_key].basename.toLowerCase().endsWith('.pdf')) {
                            existing_pdf_selector.append(`<option value="${file_key}">${doc.files[file_key].basename}</option>`)
                            has_pdf_file = true
                        }
                    })
                    if (has_pdf_file) {
                        pdf_source_options.removeClass('d-none')
                    } else {
                        pdf_source_options.addClass('d-none')
                    }

                    $("#import-pages-modal").modal()
                })

                $("input[type=radio][name=import-pages-type]").change(function () {
                    let pdf_options = $(".pdf-option")
                    let pdf_source_options = $('.import-pages-pdf-source-options')
                    let has_pdf_file = $('#import-pages-pdf-existing-file').children().length > 0
                    let file_pond = $('#import-pages-filepond-div')
                    let iiif_ids = $('#import-pages-iiif-ids-div')

                    pdf_options.addClass('d-none')
                    pdf_source_options.addClass('d-none')
                    iiif_ids.addClass('d-none')
                    file_pond.addClass('d-none')

                    if (this.value === 'pdf') {
                        file_pond.removeClass('d-none')
                        pdf_options.removeClass("d-none")
                        if (has_pdf_file) {
                            pdf_source_options.removeClass('d-none')
                        }
                    } else if (['images', 'zip'].includes(this.value)) {
                        file_pond.removeClass('d-none')
                    } else if (this.value === 'iiif') {
                        iiif_ids.removeClass('d-none')
                    }
                })

                $("input[type=radio][name=import-pages-pdf-source]").change(function () {
                    let import_pages_submit_button = $("#import-pages-submit-button")

                    if (this.value === 'existing' || import_pages_files.length > 0) {
                        import_pages_submit_button.attr('disabled', false)
                    } else {
                        import_pages_submit_button.attr('disabled', true)
                    }
                })

                $("#import-pages-iiif-ids-box").keyup(function() {
                    if ($("#import-pages-iiif-ids-box").val() && $("input[type=radio][name=import-pages-type]:checked").val() === 'iiif') {
                        $("#import-pages-submit-button").attr('disabled', false)
                    }
                })

                $("#import-pages-submit-button").click(function () {
                    $("#import-pages-files").val(JSON.stringify(import_pages_files))
                    $("#import-pages-form").submit()
                })
            }
        })

        function get_page(collection, ref_no) {
            let page = false
            if (collection && collection in doc.page_file_collections && ref_no.toString() in doc.page_file_collections[collection].page_files) {
                page = doc.page_file_collections[collection].page_files[ref_no.toString()]
            }
            return page
        }

        function load_pages() {
            let page_div = $('#page-viewer-div')
            let num_pages = Object.keys(doc.pages).length

            if (num_pages) {
                $('#pages-title').html(`${num_pages} Pages`)

                page_observer = new IntersectionObserver(function(entries) {
                    let first_page_processed = false
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            let page_card = $(`#${entry.target.id}`)
                            ref_no = page_card.data('refno')
                            if (!first_page_processed) {
                                $('#go-page-box').val(ref_no)
                                first_page_processed = true
                            }

                            if (!page_card.data('loaded')) {
                                let page_img = $(`#page-${ref_no}-img`)
                                let file_key = page_img.data('file_key')
                                let iiif_id = page_img.data('iiif_id')
                                let iiif_region = page_img.data('iiif_region')
                                let iiif_width = page_img.data('iiif_max_width')

                                if (iiif_id) {
                                    if (page_img.width() < iiif_width) iiif_width = parseInt(page_img.width())
                                    page_img.attr('src', corpora.iiif_url(iiif_id, {}, iiif_region, `${iiif_width},`))
                                } else if (file_key) {
                                    page_img.attr('src', corpora.image_url(`${document_uri}/page/${ref_no}/file/${file_key}`))
                                }
                                page_card.data('loaded', 'true')
                            }
                        }
                    })
                }, { threshold: [0] })

                if (!pfc_setting.left) {
                    for(let slug in doc.page_file_collections) {
                        if (slug.includes('primary') && slug.includes('image')) {
                            pfc_setting.left = slug
                            break
                        }
                    }
                }

                page_div.html('')
                page_div.addClass('card-deck')
                for (let refno = 1; refno < num_pages + 1; refno++) {
                    let page = get_page(pfc_setting.left, refno)
                    let data_attrs = `data-refno="${refno}"`

                    if (page) {
                        data_attrs += ` data-file_key="${page['key']}"`
                        if (Object.keys(page.iiif_info).length) {
                            data_attrs += ` data-iiif_id="${page.path}"`
                            data_attrs += ` data-iiif_max_width="${page.width}"`
                            if (page.iiif_info.hasOwnProperty('fixed_region'))
                                data_attrs += ` data-iiif_region="${page.iiif_info.fixed_region.x},${page.iiif_info.fixed_region.y},${page.iiif_info.fixed_region.w},${page.iiif_info.fixed_region.h}"`
                            else
                                data_attrs += ` data-iiif_region="full"`
                        }
                    }

                    page_div.append(`
                        <div id="page-${refno}-card" class="card page-card" data-refno="${refno}" data-loaded="false">
                            <img id="page-${refno}-img" class="card-img-top page-image" src="{% static 'img/page.png' %}" ${data_attrs}>
                            <div class="card-body">
                                <button id="page-files-${refno}-toggler" class="btn btn-link" data-toggle="collapse" data-target="#page-files-${refno}" aria-expanded="false" aria-controls="page-files-${refno}">
                                    <span id="page-files-${refno}-indicator" class="fas fa-caret-right"></span>
                                    Files
                                </button>

                                <div id="page-files-${refno}" class="alert alert-info collapse page-files" aria-labelledby="page-files-${refno}-toggler" data-refno="${refno}">
                                </div>

                                <h5 class="page-number float-right">${refno}</h5>
                            </div>
                        </div>
                    `)
                }

                $('.page-card').each(function() {
                  page_observer.observe(this)
                })


                $('.page-image').click(function() {
                    ref_no = parseInt($(this).data('refno'))
                    show_page()
                })

                $('.page-files').on('shown.bs.collapse', function(e) {
                    let page_file_div = $(e.target)
                    let refno = page_file_div.data('refno')
                    let indicator = $(`#page-files-${refno}-indicator`)
                    indicator.removeClass('fa-caret-right')
                    indicator.addClass('fa-caret-down')

                    let file_rows = ''
                    if (refno in doc.pages) {
                        for (let file_key in doc.pages[refno].files) {
                            let file = doc.pages[refno].files[file_key]
                            let label = file.collection_label
                            let mode = 'target="_blank"'
                            if (label.includes('Object')) { mode = 'download'; }

                            let link = `<a href="${corpora.file_url(file.uri)}" ${mode}>${file.basename}</a>`
                            if (label.includes('Image')) {
                                link = `<a href="${corpora.image_url(file.uri)}" ${mode}>${file.basename}</a>`
                            }

                            file_rows += `
                                <tr>
                                    <td>
                                        ${link}
                                    </td>
                                    <td>
                                        ${file.byte_size}
                                    </td>
                                </tr>
                            `
                        }
                    }

                    page_file_div.html(`
                        <table class="table table-striped">
                            <thead class="thead-dark">
                                <th scope="col">
                                    File
                                </th>
                                <th scope="col">
                                    Size (bytes)
                                </th>
                            </thead>
                            <tbody>
                                ${file_rows}
                            </tbody>
                        </table>
                    `)
                })
                $('.page-files').on('hidden.bs.collapse', function(e) {
                    let page_file_div = $(e.target)
                    let refno = page_file_div.data('refno')
                    let indicator = $(`#page-files-${refno}-indicator`)
                    indicator.removeClass('fa-caret-down')
                    indicator.addClass('fa-caret-right')
                })
            }
        }

        function show_page() {
            let num_pages = Object.keys(doc.pages).length
            if(ref_no < 1) { ref_no = 1; }
            if(ref_no > num_pages) { ref_no = num_pages; }
            if(ref_no == 1) { $('#go-prev-page-button').attr('disabled', true); }
            if(ref_no == num_pages) { $('#go-next-page-button').attr('disabled', true); }
            if(ref_no > 1) { $('#go-prev-page-button').attr('disabled', false); }
            if(ref_no < num_pages) { $('#go-next-page-button').attr('disabled', false); }

            $('.page-card.selected').each(function() {
                $(this).removeClass('selected')
            })

            let page_card = $(`#page-${ref_no}-card`)
            let page_image = $(`#page-${ref_no}-img`)
            if (page_card.length && page_image.length) {
                page_card.addClass('selected')
                page_card[0].scrollIntoView()
                setTimeout(function() {
                    let page_card = $(`#page-${ref_no}-card`)
                    page_card[0].scrollIntoView({behavior: 'smooth'})
                    $('#pages-card')[0].scrollIntoView()
                    $('#go-page-box').val(ref_no)

                    if (page_image.data('iiif_id')) {
                        let iiif_id = page_image.data('iiif_id')
                        let iiif_region = page_image.data('iiif_region')
                        let iiif_width = page_image.data('iiif_max_width')
                        if (page_image.width() < iiif_width) iiif_width = parseInt(page_image.width())
                        page_image.attr('src', corpora.iiif_url(iiif_id, {}, iiif_region, `${iiif_width},`))
                    }
                }, 300)
            }
        }

        function set_collection(side, collection) {
            corpora.set_preference(
                'Document',
                `/corpus/{{ corpus_id }}/Document/{{ document_id }}`,
                `page_viewer_${side}_collection`,
                collection,
                function(pref) {
                    pfc_setting[side] = pref

                    $('#page-viewer-control-div').removeClass('d-none')
                    load_pages()
                }
            )
        }
    </script>
{% endblock %}