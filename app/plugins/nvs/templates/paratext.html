{% extends 'nvs_base.html' %}
{% load static %}

{% block headrefs %}

<style>
    .paratext {
        font-family: "Halyard Text", sans-serif;
    }
    .paratext h1,
    .paratext h2,
    .paratext h3,
    .paratext h4,
    .paratext h5,
    .paratext h6 {
        font-weight: 500;
        margin-top: 10px;
        margin-bottom: 10px;
        line-height: 22px;
    }
    .paratext h1 {
        font-family: "Halyard Text", sans-serif;
        font-size: 24px;
        text-transform: none;
        color: red;
        letter-spacing: 0;
    }
    .paratext h2 {
        font-size: 22px;
        margin-top: 40px;
    }
    .paratext h3 {
        font-size: 20px;
        margin-top: 40px;
    }
    /*Stop the title at the top of the page from getting the margin top*/
    .paratext h2:nth-child(2),
    .paratext h3:nth-child(2) {
        margin-top: 0;
    }

    .paratext h4,
    .paratext .large {
        font-size: 18px;
    }
    .paratext h5,
    .paratext h6,
    .paratext p {
        font-size: 16px;
    }

    h2.level-1 {
        font-size: 24pt;
    }

    .paratext p {
        margin-top: 10px;
        margin-bottom: 10px;
        text-align: left;
        hyphens: auto;
        line-height: 22px;
    }
    .paratext .justify {
        text-align: justify;
    }
    .paratext table {
        font-size: 15px;
        margin: 5px 40px;
        line-height: 2;
    }
    .paratext td {
        vertical-align: top;
        padding: 5px;
    }

    .pt_textual_note {
        margin: 10px 0 10px 30px;
        font-size: 15px;
        line-height: 20px;
        text-align: left;
        padding-left: 120px;
        position: relative;
    }
    .pt_textual_note > .ref-lb:first-child {
        position: absolute;
        top: 0;
        left: 0;
    }
    .ref-lb,
    .ref {
        color: var(--blue);
        text-decoration: underline;
        font-family: "Roboto Condensed", sans-serif;
        font-weight: 700;
    }
    .ref-bibl {
        color: var(--blue);
        text-decoration: underline;
        font-weight: 700;
    }
    .ref-siglum {
        color: var(--orange);
        text-decoration: underline;
        font-weight: 700;
        font-variant-numeric: normal;
        font-size: 14px;
    }
    .witness-list {
        margin: 20px 0;
    }

    .witness {
        margin: 10px 0 10px 10px;
        display: grid;
        grid-template-columns: 1fr 4fr 1fr;
        align-items: start;
        grid-gap: 5px;
        font-size: 15px;
        line-height: 22px;
    }
    @media ( min-width: 992px ) {
        .witness {
            margin-left: 40px;
            grid-template-columns: 80px 4fr 80px;
            grid-gap: 10px;
        }
    }
    .witness .ref-siglum {
        text-decoration: none;
    }

    .name, .author, .editor {
        color: var(--blue);
        font-weight: 700;
    }
    .date {
        font-weight: 700;
    }

    .title.level_m, .title.level_j {
        font-style: italic;
    }
    .title.level_m .title.level_m {
        font-style: normal;
    }

    .title.level_a {
        quotes: "“" "”" "‘" "’";
    }
    .title.level_a::before {
        content: open-quote;
    }
    .title.level_a::after {
        content: close-quote;
    }

    .quote {
        quotes: "‘" "’";
    }
    .quote::before {
        content: open-quote;
    }
    .quote::after {
        content: close-quote;
    }

    .bibl-list {
        margin: 20px 0;
    }

    .bibl {
        margin: 10px 0 10px 40px;
        font-size: 15px;
        line-height: 22px;
        display: block;
        text-indent: -1em;
    }

    .witness .bibl {
        margin: 0;
    }

    .paratext ul {
        list-style: none;
        padding-left: 40px;
        margin: 10px 0;
    }
    .paratext li {
        margin: 10px 0;
    }
    dt, dd {
        display: inline-block;
        margin: 0;
    }
    .paratext li > dt:first-child {
      min-width: 100px;
    }

    .speech {
        margin-left: 40px;
    }
    .speaker {
        font-style: italic;
    }
    .figure {
        margin-left: 40px;
    }

    q.rend-block {
        quotes: none;
        display: block;
        margin: 10px 0 10px 40px;
    }
    q.rend-no_qmarks:before { display: none; }
    q.rend-no_qmarks:after { display: none; }

    /* Rend styles */
    .rend-indent1em { margin-left: 10px; }
    .rend-indent2em { margin-left: 20px; }
    .rend-indent7em { margin-left: 70px; }
    .rend-indent8em { margin-left: 80px; }
    .rend-indent10em { margin-left: 100px; }
    .rend-indent15em { margin-left: 150px; }
    .rend-italic { font-style: italic; }
    .rend-bold { font-weight: 700; }
    .rend-aligncenter, .rend-aligncenter p { text-align: center !important; }
    .rend-alignleft, .rend-alignleft p { text-align: left !important; }
    .rend-alignright, .rend-alignright p { text-align: right !important; }
    .rend-allcaps { text-transform: uppercase; }

    .floating-text,
    .floating-text h3,
    .floating-text h4,
    .floating-text h5,
    .floating-text h6,
    .floating-text p {
        font-size: 15px;
        line-height: 20px;
    }
    .floating-text .type-main,
    .floating-text .type-sub {
        font-size: 16px;
        font-weight: bold;
    }
    .floating-text {
        margin: 0 40px 80px 40px;
    }
    .floating-text p {
        text-align: justify;
    }

    .paratext ul.type-ordered {
        margin-top: 20px;
        margin-bottom: 20px;
        padding-left: 60px;
    }
    .paratext ul.type-ordered li {
        padding-left: 60px;
        position: relative;
    }
    .paratext ul.type-ordered li .label {
        position: absolute;
        top: 0;
        left: 0;
    }

    p.digital-nvs-comment {
        padding: 10px;
        background-color: #EBF4FC;
    }

    /* -----------------------------
    || STYLES IMPORTED FROM PLAYVIEWER TO SUPPORT REF MODALS
    || -------------------------- */

    @font-face {
        font-family: "HalyardTextBook";
        src: url("/static/proprietary/font/HalyardTextBook.woff2") format('woff2'), url("/static/proprietary/font/HalyardTextBook.woff") format('woff');
    }

    @font-face {
        font-family: "HalyardTextSemiBold";
        src: url("/static/proprietary/font/HalyardTextSemBd.woff2") format('woff2'), url("/static/proprietary/font/HalyardTextSemBd.woff") format('woff');
    }

    @font-face {
        font-family: "HalyardTextMedium";
        src: url("/static/proprietary/font/HalyardTextMed.woff2") format('woff2'), url("/static/proprietary/font/HalyardTextMed.woff") format('woff');
    }

    @font-face {
        font-family: "Baskerville";
        src: url("/static/proprietary/font/Baskerville10Pro.woff") format('woff');
    }

    @font-face {
        font-family: "Baskerville";
        src: url("/static/proprietary/font/Baskerville10Pro-Bold.woff") format('woff');
        font-weight: bold;
    }

    @font-face {
        font-family: "Baskerville";
        src: url("/static/proprietary/font/Baskerville10Pro-Italic.woff") format('woff');
        font-style: italic;
    }

    @font-face {
        font-family: "Baskerville";
        src: url("/static/proprietary/font/Baskerville10Pro-BoldItalic.woff") format('woff');
        font-weight: bold;
        font-style: italic;
    }

    .d-flex {
        display: flex !important;
    }

    .justify-content-between {
        -webkit-box-pack: justify!important;
        -ms-flex-pack: justify!important;
        justify-content: space-between!important;
    }

    .justify-content-center {
        -webkit-box-pack: center!important;
        -ms-flex-pack: center!important;
        justify-content: center!important;
    }

    .row {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
        margin-right: -15px;
        margin-left: -15px;
    }

    .no-gutters {
        margin-right: 0;
        margin-left: 0;
    }

    .p-0 {
        padding: 0!important;
    }
    .m-0 {
        margin: 0!important;
    }

    .w-100 {
        width: 100%!important;
    }

    .col-sm-10 {
        position: relative;
        width: 100%;
        min-height: 1px;
        -webkit-box-flex: 0;
        -ms-flex: 0 0 83.333333%;
        flex: 0 0 83.333333%;
        max-width: 83.333333%;
    }

    .col-sm-1 {
        -webkit-box-flex: 0;
        -ms-flex: 0 0 8.333333%;
        flex: 0 0 8.333333%;
        max-width: 8.333333%;
    }

    .ref-modal {
        position: absolute;
        max-width: calc(40vw);
        z-index: 500;
    }

    .arrow-right, .arrow-left {
        background-color: #FFFFFF;
        position: relative;
        box-sizing: border-box;
        border: 1px solid #828282;
        box-shadow: 0px 3px 3px 0 rgba(0, 0, 0, 0.4);
    }

    .arrow-right {
        float: left;
    }

    .arrow-left {
        float: right;
    }

    .arrow-right:after, .arrow-right:before, .arrow-left:after, .arrow-left:before {
        content: " ";
        width: 0;
        height: 0;
        position: absolute;
        left: -15px;
        top: 10%;
    }

    .arrow-right:after, .arrow-right:before {
        left: 100%;
    }

    .arrow-right:after {
        border-top: 15px solid transparent;
        border-right: none;
        border-left: 15px solid white;
        border-bottom: 15px solid transparent;
    }

    .arrow-right:before {
        border-top: 17px solid transparent;
        border-right: none;
        border-left: 16px solid #828282;
        border-bottom: 16px solid transparent;
        margin-top: -2px;
    }

    .arrow-left:after {
        border-top: 15px solid transparent;
        border-left: none;
        border-right: 15px solid white;
        border-bottom: 15px solid transparent;
    }

    .arrow-left:before {
        border-top: 17px solid transparent;
        border-left: none;
        border-right: 16px solid #828282;
        border-bottom: 16px solid transparent;
        margin-top: -2px;
        margin-left: -1px;
    }

    .ref-modal-header {
        font-family: 'Roboto Condensed', sans-serif;
        font-weight: bold;
        text-transform: uppercase;
        color: #000000;
        padding: 10px;
        cursor: move;
    }

    .ref-subtitle-marker {
        background-color: #2a69a1;
        width: 13px;
        height: 13px;
        display: inline-block;
        margin-right: 3px;
        position: relative;
        top: 5px;
    }

    .ref-modal-control {
        cursor: pointer;
        height: 20px;
        margin-left: 5px;
    }

    .ref-modal-content {
        padding: 10px;
        font-family: 'HalyardTextBook';
        max-height: calc(40vh);
        overflow-y: scroll;
    }

    .ref-row {
        width: calc(40vw);
        border-top: solid 1px #cfcfcf;
    }

    .ref-row:last-child {
        border-bottom: solid 1px #cfcfcf;
    }

    .play-words {
        padding-top: 10px;
        padding-bottom: 5px;
        padding-left: 0px;
        font-family: 'Baskerville', serif;
        font-variant-numeric: oldstyle-nums;
        font-size: clamp(1.125rem, 1.2vw, 1.5rem);
        color: #070707;
        background-color: white;
        -webkit-box-align: center!important;
        -ms-flex-align: center!important;
        align-items: center!important;
        display: -webkit-box!important;
        display: -ms-flexbox!important;
        display: flex!important;
    }

    .play-label {
        background-color: white;
        color: #828282;
        border: none;
        border-left: solid 1px #cfcfcf;
        border-right: solid 1px #cfcfcf;
        font-family: 'Roboto Condensed', sans-serif;
        font-size: 12px;
        -webkit-box-align: center!important;
        -ms-flex-align: center!important;
        align-items: center!important;
        display: -webkit-box!important;
        display: -ms-flexbox!important;
    }

    .actscene-indicator {
        color: #828282;
        font-size: 12px;
        cursor: pointer;
        background-color: #F2F2F2;
        -webkit-box-align: center!important;
        -ms-flex-align: center!important;
        align-items: center!important;
        display: -webkit-box!important;
        display: -ms-flexbox!important;
    }

    .comm-heading {
        background-color: #F0E438;
        font-family: 'Baskerville', serif;
        font-variant-numeric: oldstyle-nums;
        cursor: pointer;
        color: #000000;
    }

    .comm-block {
        color: #000000;
        font-family: 'HalyardTextBook';
        font-size: clamp(13px,1.2vw,16px);
        margin-bottom: 20px;
        font-variant-numeric: oldstyle-nums;
    }

    .comm-block a {
        color: #2a69a1;
    }

    .graphic {
        display: block;
        width: 90%;
        margin-left: auto;
        margin-right: auto;
    }
</style>

{% endblock %}

{% block main %}

<div class="page-title">
  <h1 class="edition-header">
    {{ play.title }} {% include 'svg/arrow.svg' %} <span class="edition-header--title">{{ section }}</span>
  </h1>
</div>

<div class="page-holder is-white">
  <div class="container">
    <div class="page-holder--inner has-max-width">
      <div class="anchor-links--holder">
        <button class="anchor-links--toggle link roboto-uppercase">page navigation</button>
        <ul class="anchor-links--inner">
            {{ toc|safe }}
        </ul>
      </div>
      <div>
        <div class="paratext">
            {{ html|safe }}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<script src="{% static 'js/jquery-3.3.1.min.js' %}"></script>
<script src="{% static 'js/corpora.js' %}"></script>
<script type="application/javascript">
    let corpora;
    let corpus_id = "{{ corpus_id }}";
    let corpora_url = "{{ corpora_url }}";
    let play_prefix = "{{ play.prefix }}";
    let play_id = "{{ play.id }}";
    let witnesses = {{ witnesses|safe }};
    let playviewer_url = {% if site_request %}`/edition/${play_prefix}/`{% else %}`/corpus/${corpus_id}/play-viewer/${play_prefix}/`{% endif %};
    let paratext_prefix = {% if site_request %}''{% else %}`/corpus/${corpus_id}/paratext-viewer/${play_prefix}/`{% endif %};
    let lines_endpoint = {% if site_request %}`${window.location.protocol}//${window.location.host}/lines/${play_prefix}/`{% else %}`/api/corpus/${corpus_id}/nvs-lines/${play_prefix}/`{% endif %};
    let ref_modal_counter = 0;

    let nav_map = {
        'lb': {
            'content_type': 'PlayLine',
            'xml_id_field': 'xml_id',
            'content_field': 'rendered_html',
            'title': 'LINE',
            'title_plural': 'LINES',
            'scroll_anchor': false,
            'filter_play': true,
        },
        'bibl': {
            'content_type': 'Reference',
            'xml_id_field': 'document.siglum',
            'content_field': 'bibliographic_entry',
            'title': "BIBLIOGRAPHY",
            'title_plural': "BIBLIOGRAPHY",
            'scroll_anchor': false,
            'filter_play': false,
        },
        'siglum': {
            'content_type': 'Reference',
            'xml_id_field': 'document.siglum',
            'content_field': 'bibliographic_entry',
            'title': "COLLATED EDITION",
            'title_plural': "COLLATED EDITIONS",
            'scroll_anchor': false,
            'filter_play': false,
        },
        'note_cn': {
            'content_type': 'Commentary',
            'xml_id_field': 'xml_id',
            'content_field': 'contents',
            'title': "COMMENTARY",
            'title_plural': "COMMENTARY",
            'scroll_anchor': false,
            'filter_play': true,
        },
        'anchor': {
            'content_type': 'ParaText',
            'xml_id_field': 'child_xml_ids',
            'content_field': 'html_content',
            'title': "APPENDIX",
            'title_plural': "APPENDIX",
            'scroll_anchor': true,
            'filter_play': true,
        }
    };

    $(document).ready(function() {
        corpora = new Corpora({'csrf_token': "{{ csrf_token }}"{% if site_request %},'host': '{{ corpora_url }}'{% endif %}});

        // Place statement about digital edition of NVS before textual note section
        let textual_note_explanation = $('#textual_note_explanation_start');
        if (textual_note_explanation.length) {
            textual_note_explanation.prepend(`
                <p class="digital-nvs-comment">
                    <b>Note</b>: In the section below you will find the original explanation for reading textual notes
                    as they appear throughout the
                    <a href="{% if site_request %}/print-editions/{% else %}/corpus/{{ corpus_id }}/print/{% endif %}" target="_blank">print edition</a>
                    of this volume. For the present, digital edition of this
                    volume, textual notes for the play text have been re-envisioned so as to provide a line-by-line,
                    aggregated view of change over time throughout collated editions (or witnesses) in the form of a
                    histogram. These visualizations can be expanded to show how the variant line appears in given
                    witnesses. For more information about how to read textual notes in the digital version of this
                    volume, watch our
                    <a href="{% if site_request %}/how-to/{% else %}/corpus/{{ corpus_id }}/how-to/{% endif %}#textual-notes-search" target="_blank">video tutorial</a>.
                    The original, print convention for textual notes is still used, however, in the
                    <a href="{% if site_request %}/appendix/${play_prefix}/{% else %}/corpus/{{ corpus_id }}/paratext-viewer/${play_prefix}/Appendix/{% endif %}" target="_blank">Appendix</a>
                    of this digital edition, particularly in the "Irregular, Doubtful, and Emended Accidentals" and
                    "Unadopted Conjectures" sections.
                </p>
            `);
        }

        // Add credit to the MLA at end of Credits section
        let section_headers = $('h2.level-1');
        let found_credits = false;
        section_headers.each(function() {
            let header = $(this);
            if (header.html() === 'Credits') found_credits = true;
            else if (found_credits) {
                let notice = document.createElement('p');
                notice.innerHTML = `With founding sponsorship from the Modern Language Association of America, exclusive publisher of the NVS, 1936-2019.`;
                $(notice).insertBefore(header);
                found_credits = false;
            }
        });

        $('img.graphic').each(function() {
            let graphic = $(this);
            let repo_name = graphic.data('repo-name');
            let path = graphic.data('path');
            let src = `${corpora_url}/repo-file/${corpus_id}/${repo_name}/?path=${path}`;
            graphic.attr('src', src);
        });

        $('.author.display_bookldash').each(function() {
            let span = $(this);
            span.html(`&mdash;&mdash;${span.html().endsWith('.') ? '.' : ''}`);
        });
    })

    function romanize (num) {
        if (isNaN(num))
            return num;
        let digits = String(+num).split(""),
            key = ["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM",
                "","X","XX","XXX","XL","L","LX","LXX","LXXX","XC",
                "","I","II","III","IV","V","VI","VII","VIII","IX"],
            roman = "",
            i = 3;
        while (i--)
            roman = (key[+digits.pop() + (i * 10)] || "") + roman;
        return Array(+digits.join("") + 1).join("M") + roman;
    }

    function navigate_to(nav_type, xml_id, link=null) {
        xml_id = xml_id.replace(/#/g, '');
        if (nav_type === 'lb') {
            let start_id = xml_id;
            let end_id = null;
            if (start_id.includes(' ')) {
                let id_parts = start_id.split(' ');
                start_id = id_parts[0];
                end_id = id_parts[1];
            }

            let line_endpoint_suffix = `${start_id}/`;
            if (end_id) { line_endpoint_suffix += `${end_id}/` }

            corpora.make_request(
                lines_endpoint + line_endpoint_suffix,
                'GET',
                {},
                function(data) {
                    if (data.length) {
                        let lines_label = data.length === 1 ? `Line ${data[0].line_label}` : `Lines ${data[0].line_label}-${data[data.length - 1].line_label}`;
                        let lines_html = '';
                        let line_template = (line) =>
                            `<div class="row no-gutters ref-row">
                                <div class="col-sm-10 m-0 p-0 play-words">
                                    ${line.text}
                                </div>
                                <div class="col-sm-1 m-0 p-1 play-label d-flex justify-content-center">
                                    ${line.line_label}
                                </div>
                                <div class="col-sm-1 m-0 p-1 bg-nvs-lightest-gray actscene-indicator d-flex justify-content-center">
                                    ${romanize(line.act)},${line.scene}
                                </div>
                            </div>`;
                        data.map(line => { lines_html += line_template(line); });

                        let controls = `
                            <a href="${playviewer_url}#${start_id}-row" target="_blank"><img src="{% static 'img/controls/Modal-NEWTAB.svg' %}"
                                class="ref-modal-control"
                                border="0"
                            ></a>`;
                        display_nav_modal(lines_label, lines_html, link, controls);
                    }
                }
            );
        } else {
            if (nav_type === 'siglum'){
                if (!xml_id.startsWith('s_')) xml_id = `s_${xml_id.toLowerCase()}`;

                if (xml_id in witnesses) {
                    let title = 'Collated Edition';
                    if (witnesses[xml_id].bibliographic_entry.includes('<br /><br />')) title += 's';
                    display_nav_modal(title, witnesses[xml_id].bibliographic_entry, link);
                }
            } else {
                if (!nav_map.hasOwnProperty(nav_type)) nav_type = 'anchor';

                let xml_ids = xml_id.split(' ');
                let search_params = {
                    page: 1,
                    'page-size': xml_ids.length,
                    only: 'id',
                    operator: xml_ids.length > 1 ? 'or' : 'and'
                };

                if (nav_map[nav_type]['filter_play']) {
                    search_params['f_play.id'] = play_id;
                }

                let content_type = nav_map[nav_type]['content_type'];
                let search_field = nav_map[nav_type]['xml_id_field'];
                search_params[`t_${search_field}`] = xml_ids.join('__');
                corpora.list_content(corpus_id, content_type, search_params, function (search_data) {
                    if (search_data.hasOwnProperty('records') && search_data.records.length === xml_ids.length) {
                        let ids = search_data.records.map(record => record.id);
                        populate_nav_contents(nav_type, ids, [], xml_ids[0], link);
                    }
                });
            }
        }
    }

    function populate_nav_contents(nav_type, ids, contents=[], first_xml_id=null, link=null) {
        if (ids.length > 0) {
            let content_type = nav_map[nav_type]['content_type'];

            corpora.get_content(corpus_id, content_type, ids[0], function(content_data) {
                contents.push(content_data);
                ids.shift();

                if (ids.length > 0) {
                    populate_nav_contents(nav_type, ids, contents, first_xml_id, link);
                } else {
                    let nav_title = nav_map[nav_type]['title'];
                    let controls = '';
                    if (contents.length > 1) { nav_title = nav_map[nav_type]['title_plural']; }

                    let nav_content = '';
                    contents.map(content => {
                        if (nav_content === '') nav_content += '<a name="nav-content-start"></a>';
                        else nav_content += '<br><br>';

                        if (nav_type === 'note_cn') {
                            nav_content += `
                                <div class="comm-heading">
                                    n. ${content.line_label}: ${content.subject_matter}
                                </div>
                            `;
                        } else if (nav_type === 'anchor') {
                            nav_title = `<span>${content.section}<br/><div class="ref-subtitle-marker">&nbsp;</div><span class="text-nvs-dark-blue">${content.title}</span></span>`;

                            let paratext_url = ''
                            let paratext_section_map = {
                                'Front Matter': 'front',
                                'Appendix': 'appendix',
                                'Bibliography': 'bibliography'
                            }

                            if (paratext_prefix.length) {
                                paratext_url = `${paratext_prefix}${content.section}/`;
                            } else {
                                paratext_url = `/${paratext_section_map[content.section]}/${play_prefix}/`;
                            }
                            paratext_url += `#paratext-${content.id}`;

                            controls = `
                                <a href="${paratext_url}" target="_blank">
                                    <img src="{% static 'img/nav-external.png' %}"
                                        class="ref-modal-control"
                                        border="0">
                                </a>
                            `;
                        }

                        nav_content += content[nav_map[nav_type]['content_field']];
                    });

                    let modal_id = display_nav_modal(nav_title, nav_content, link, controls);
                    if (nav_map[nav_type].scroll_anchor) {
                        setTimeout(delayed_scroll.bind(null, first_xml_id, true, modal_id), 2000)
                    }
                }
            });
        }
    }

    function display_nav_modal(title, content, link, controls='') {
        let modal_id = '';
        let modal_el = null;

        if (link) {
            modal_id = `ref-modal-${ref_modal_counter}`;
            let link_rect = link.getBoundingClientRect();
            let arrow_side = 'right';
            if (link_rect.x <= window.innerWidth / 2) {
                arrow_side = 'left'
            }
            $('body').append(`
                <div
                    id="${modal_id}"
                    class="ref-modal"
                >
                    <div class="arrow-${arrow_side}">
                        <div class="ref-modal-header d-flex justify-content-between">
                            <span id="${modal_id}-header" class="w-100">
                                ${title}
                            </span>
                            <span style="white-space: nowrap;">
                                ${controls}
                                <img src="{% static 'img/controls/Modal-CLOSE.svg' %}" id="${modal_id}-close-button" class="ref-modal-control" data-modal-id="${modal_id}" aria-label="Close" />
                            </span>
                        </div>
                        <div class="ref-modal-content">${content}</div>
                    </div>
                </div>
            `);
            modal_el = $(`#${modal_id}`);
            if (arrow_side === 'right') {
                modal_el.css('top', `${link_rect.top + window.pageYOffset - 20}px`);
                modal_el.css('left', `${link_rect.left - (modal_el.width() + 20)}px`);
            } else {
                modal_el.css('top', `${link_rect.top + window.pageYOffset - 20}px`);
                modal_el.css('left', `${link_rect.right + 20}px`);
            }

            $(`#${modal_id}-close-button`).click(function() {
                let close_modal_id = $(this).data('modal-id');
                $(`#${close_modal_id}`).remove();
            });

            make_draggable(modal_el[0]);
            ref_modal_counter += 1;
        }
        else {
            $('#nav-modal-label').html(title);
            $('#nav-modal-body').html(content);
            $('#nav-modal').modal();
        }

        return modal_id;
    }

    function make_draggable(elmnt) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        if (document.getElementById(elmnt.id + "-header")) {
            // if present, the header is where you move the DIV from:
            document.getElementById(elmnt.id + "-header").onmousedown = dragMouseDown;
            document.getElementById(elmnt.id + "-header").ontouchstart = dragMouseDown;
        } else {
            // otherwise, move the DIV from anywhere inside the DIV:
            elmnt.onmousedown = dragMouseDown;
            elmnt.ontouchstart = dragMouseDown;
        }

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();

            // get the mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.ontouchend = closeDragElement;
            // call a function whenever the cursor moves:
            document.onmousemove = elementDrag;
            document.ontouchmove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            if (e.type === "touchmove") {
                pos1 = pos3 - e.touches[0].clientX;
                pos2 = pos4 - e.touches[0].clientY;
                pos3 = e.touches[0].clientX;
                pos4 = e.touches[0].clientY;
            } else {
                e.preventDefault();
                // calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
            }

            // set the element's new position:
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            // stop moving when mouse button is released:
            document.onmouseup = null;
            document.onmousemove = null;
            document.ontouchend = null;
            document.ontouchmove = null;
        }
    }

    function delayed_scroll(anchor, smooth=true, parent=null) {
        let scroll_opts = {behavior: 'smooth'};
        if (!smooth) scroll_opts = null;

        let id_selector = `${parent ? '#' + parent + ' ' : ''}#${anchor}`;
        let anchor_selector = `${parent ? '#' + parent + ' ' : ''}a[name=${anchor}]`;

        if ($(id_selector).length) {
            $(id_selector)[0].scrollIntoView(scroll_opts);
        }
        else $(anchor_selector)[0].scrollIntoView(scroll_opts);
    }
</script>
{% endblock %}