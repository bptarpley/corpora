{% load static %}
{% load extras %}
<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="apple-touch-icon" sizes="180x180" href="/static/img/icon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/static/img/icon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/static/img/icon/favicon-16x16.png">
        <link rel="manifest" href="/static/img/icon/site.webmanifest">
        <link rel="mask-icon" href="/static/img/icon/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">

        <!-- CSS -->
        <link href="{% static 'css/fontawesome.min.css' %}" rel="stylesheet">
        <link href="{% static 'css/regular.min.css' %}" rel="stylesheet">
        <link href="{% static 'css/solid.min.css' %}" rel="stylesheet">
        <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
        <!--<link href="{% static 'css/nvs.css' %}" rel="stylesheet">-->

        <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital@0;1&display=swap" rel="stylesheet">
        <style title="main-sheet">
            :root {
                --scrollbarURL: url("/corpus/{{ corpus_id }}/play-minimap/{{ play.prefix }}/?width=40&height=1000");
            }

            body {
                background-color: #FFFFFF;
            }

            canvas {
                display: block;
            }

            .heading-row {
                background-color: #FFFFFF;
                z-index: 20;
                height: 100px;
            }

            .heading-label {
                font-family: 'Roboto', sans-serif;
                font-size: 14px;
                font-weight: bold;
            }

            .heading-button {
                font-family: 'Roboto', sans-serif;
                font-size: 10px;
                font-weight: bold;
                text-align: center;
                vertical-align: center;
                padding-top: 5px;
                padding-bottom: 5px;
                border-left: solid 2px #FFFFFF;
                border-right: solid 2px #FFFFFF;
                color: #FFFFFF;
                background-color: #cfcfcf;
            }

            .heading-buton-active {
                background-color: #f0a962 !important;
            }

            #main-col {
                overflow-y: scroll;
                max-height: calc(100vh - 100px);
            }

            #main-col::-webkit-scrollbar {
                width: 40px;
            }

            #main-col::-webkit-scrollbar-track {
                background-image: var(--scrollbarURL);
                background-size: contain;
                background-repeat: no-repeat;
            }

            #main-col::-webkit-scrollbar-thumb {
                background-color: rgba(247, 155, 86, .5);
            }

            #witness-header-col {
                padding: 0px;
                margin: 0px;
            }

            #line-col {
                min-height: unset;
            }

            .play-row {
                border-bottom: solid 4px #fbeee0;
            }

            .play-label {
                background-color: #fbf5f1;
                font-family: 'Roboto', sans-serif;
                font-size: 1.2vw;
                border: none;
                -webkit-box-align: center!important;
                -ms-flex-align: center!important;
                align-items: center!important;
                display: -webkit-box!important;
                display: -ms-flexbox!important;
                display: flex!important;
            }

            .play-label-highlighted {
                background-color: #e9702b;
                color: white;
            }

            .play-words, .play-words-seen {
                padding-top: 10px;
                padding-bottom: 5px;
                font-family: 'Libre Baskerville', serif;
                font-size: 1.4vw;
                color: #070707;
                -webkit-box-align: center!important;
                -ms-flex-align: center!important;
                align-items: center!important;
                display: -webkit-box!important;
                display: -ms-flexbox!important;
                display: flex!important;
            }

            span.castlist {
                margin-left: 10px;
            }

            span.castgroup {
                margin-left: 10px;
            }

            span.role {
                font-weight: bold;
            }

            span.roledesc {
                font-style: italic;
                display: inline-block;
                margin-bottom: 15px;
            }

            span.stage {
                font-style: italic;
            }

            span.speaker-abbreviation {
                font-style: italic;
                display: inline-block;
                margin-right: 10px;
                margin-top: 15px;
                margin-left: 15px;
            }

            .witness-meter {
                padding-top: 4px;
                padding-bottom: 4px;
                padding-left: 0px;
                padding-right: 0px;
                margin: 0px;
            }

            .variant-toggler, .variant-toggler:hover {
                text-decoration: none;
                color: #9A9A99;
            }

            .variant-toggler.active {
                color: #f99b4e;
            }

            .variant-row {
                /*background-color: #efefef;*/
                background-color: rgba(154, 154, 153, 0.1);
                border-bottom: solid 4px #fbeee0;
            }

            .witness-formula {
                color: #f99b4e;
                font-family: 'Roboto', sans-serif;
                font-size: 12px;
                text-transform: uppercase;
            }

            .variant-play-label {
                background-color: #f2f2f2;
            }

            .variant-words {
                font-family: 'Libre Baskerville', serif;
                color: #949494;
                padding-left: 37px;
                padding-top: 10px;
                padding-bottom: 5px;
            }

            .variant-note {
                color: #070707;
            }

            h3.heading {
                margin-top: 15px;
            }

            span.difference {
                color: #e9702b;
                background-color: #d8d8d8;
            }

            comspan {
                background-color: rgba(144, 188, 226, .3);
                border-bottom: solid 1px rgb(144, 188, 226);
                cursor: pointer;
            }

            .hidden {
                display: none;
            }
        </style>

        <title>Winter's Tale</title>
    </head>
    <body>
        <div id="main-container" class="container-fluid m-0 p-0">
            <div id="main-header" class="row no-gutters sticky-top heading-row">
                <div class="col-sm-9 p-0 m-0">
                    <div class="row no-gutters" style="padding-right: 40px;">
                        <!-- WITNESS HEADING -->
                        <div class="col-sm-4 p-0 m-0">
                            <div class="heading-label">
                                TEXTUAL VARIANTS
                            </div>
                            <div class="row no-gutters">
                                <div class="col-sm-4 p-0 m-0 heading-button heading-button-active">
                                    COLLAPSE
                                </div>
                                <div class="col-sm-4 p-0 m-0 heading-button">
                                    EXPAND
                                </div>
                                <div class="col-sm-4 p-0 m-0 heading-button">
                                    OFF
                                </div>
                            </div>
                            <div class="row no-gutters">
                                <div id="witness-header-col" class="col-sm-12 p-0 m-0">
                                    <canvas id="witness-header-canvas"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- PLAYTEXT HEADING -->
                        <div class="col-sm-8 p-0 m-0">
                            <div class="row no-gutters">
                                <div class="col-sm-3 m-0 p-0">
                                    <img src="{% static 'img/nvs-logo.png' %}" style="max-height: 90px; width: auto;" />
                                </div>
                                <div class="col-sm-9 m-0 p-0 display-4" style="font-family: 'Libre Baskerville', serif; margin-top: 15px;">
                                    Prototype
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- COMMENTARY HEADING -->
                <div class="col-sm-3 p-0 m-0">
                    <div class="heading-label">
                        COMMENTARY NOTES
                    </div>
                </div>
            </div>
            <div class="row no-gutters">
                <!-- VARIANTS, LINE INFO, PLAYTEXT -->
                <div id="main-col" class="col-sm-9 m-0 p-0">
                    {% for line in lines %}
                        <div id="{{ line.xml_id }}-row"
                             class="row no-gutters play-row"
                             data-xml_id="{{ line.xml_id }}"
                             data-line_number="{{ line.line_number }}"
                             data-words="{{ line.words|join:" " }}"
                             data-word-length="{{ line.words|length }}"
                             data-witness_indicators="{{ line.witness_meter }}"
                        >
                            <div id="{{ line.xml_id }}-witness-col" class="col-sm-4 m-0 p-0 witness-meter">
                                <canvas id="{{ line.xml_id }}-witness-meter" class="hide-me hidden"></canvas>
                            </div>
                            <div id="{{ line.xml_id }}-number-col" class="col-sm-1 m-0 p-0 play-label">
                                <a id="{{ line.xml_id }}-variant-toggler"
                                       class="variant-toggler mx-1"
                                       data-toggle="collapse"
                                       href="#{{ line.xml_id }}-variant-div"
                                       role="button"
                                       aria-expanded="false"
                                       aria-controls="{{ line.xml_id }}-variant-div"
                                    >
                                    <i id="{{ line.xml_id }}-variant-toggle" class="fas fa-chevron-circle-right"></i>
                                </a>
                                {{ line.line_label }}
                            </div>
                            <div id="{{ line.xml_id }}-words-col" class="col-sm-7 m-0 p-0 play-words">
                                {{ line.rendered_html|safe }}
                            </div>

                        </div>
                        <div class="collapse" class="hide-me hidden" id="{{ line.xml_id }}-variant-div"></div>
                    {% endfor %}
                </div>

                <!-- COMMENTARY -->
                <div class="col-sm-3">
                    <div style="height: 100%; width: calc(25% - 5px); position: fixed;">
                        <iframe id="commentary-frame" width="100%" height="100%" frameborder="0" src="/corpus/{{ corpus_id }}/commentary-viewer/{{ play.prefix }}/"></iframe>
                    </div>
                </div>
            </div>
        </div>
        <canvas id="witness-background-canvas"></canvas>

        <script src="{% static 'js/jquery-3.3.1.min.js' %}"></script>
        <script src="{% static 'js/popper.min.js' %}"></script>
        <script src="{% static 'js/bootstrap.min.js' %}"></script>
        <script src="{% static 'js/in-view.min.js' %}"></script>
        <script src="{% static 'js/corpora.js' %}"></script>
        <script type="application/javascript">
    var corpora;
    var corpus_id = "{{ corpus_id }}";
    var play_prefix = "{{ play.prefix }}";
    var play_id = "{{ play.id }}";
    var corpus;
    var screen_size = 'large';
    var meter_height = () => Math.round(window.innerHeight / (100 / 3)) + 'px';

    var witnesses;
    var lines = {};
    var notes = {};

    var witnesses_loaded = false;
    var notes_loaded = false;
    var loading_timer = null;
    var redraw_timer = null;
    var show_queue = {};
    var hide_queue = {};

    var max_line_no = -1;
    var min_line_no = -1;

    var note_search = {
        s_line_number: 'asc',
        s_xml_id: 'asc',
        page: 1,
        'page-size': 1000
    };

    var line_col = $('#line-col');

    $(document).ready(function() {
        corpora = new Corpora({'csrf_token': "{{ csrf_token }}"});
        screen_size = determine_screen_size(window.innerWidth);
        $(":root").css("--scrollbarURL", `url(/corpus/${corpus_id}/play-minimap/${play_prefix}/?width=40&height=${parseInt($("#main-col").height())})`);

        corpora.list_content(
            corpus_id,
            'Document',
            {q_nvs_doc_type: 'witness', s_pub_date: 'asc', 'page-size': 1000},
            function(witness_data) {
                witnesses = witness_data.records;
                witnesses_loaded = true;
                draw_witness_header_and_background();
            }
        );

        corpora.list_content(
            corpus_id,
            'TextualNote',
            Object.assign({only: 'xml_id,variants,lines.xml_id'}, note_search),
            function(note_data) {
                note_data.records.map(note => {
                    notes[note.xml_id] = note;
                    notes[note.xml_id].populated = false;
                    note.lines.map(tn_line => {
                        if (!lines.hasOwnProperty(tn_line.xml_id)) {
                            lines[tn_line.xml_id] = {
                                notes: [],
                                populated: false
                            }
                        }
                        lines[tn_line.xml_id].notes.push(note.xml_id);
                    });
                });
                notes_loaded = true;
            },
            true
        );

        setTimeout(wait_for_load, 500);
    });

    function determine_screen_size(width) {
        if (width < 768) { return 'small'; }
        else if (width < 992) { return 'medium'; }
        return 'large';
    }

    function wait_for_load() {
        if (witnesses_loaded && notes_loaded) {
            inView.offset(-1000);
            inView('.play-row')
                .on('enter', el => {
                    let line_id = el.id.replace('-row', '');
                    delete hide_queue[line_id];
                    show_queue[line_id] = true;
                    clearTimeout(redraw_timer);
                    redraw_timer = setTimeout(flush_visibility_queue, 800);
                })
                .on('exit', el => {
                    let line_id = el.id.replace('-row', '');
                    delete show_queue[line_id];
                    hide_queue[line_id] = true; });

            // Handle clicking on commentary lemma
            $('comspan').click(function(e) {
                let comm_frame = $('#commentary-frame');
                let comm_id = this.className.replace('commentary-lemma-', '');
                comm_frame.contents().find(`#commentary-note-${comm_id}`)[0].scrollIntoView();
                e.stopPropagation();
            });

            $('#main-col').scroll(function() {
                inView('.play-row').check();
                clearTimeout(redraw_timer);
                redraw_timer = setTimeout(flush_visibility_queue, 800);
            });
        } else {
            setTimeout(wait_for_load, 500);
        }
    }

    function flush_visibility_queue() {
        let lines_to_hide = Object.keys(hide_queue);
        lines_to_hide.map(line_id => { delete hide_queue[line_id]; hide_notes(line_id); });
        let lines_to_show = Object.keys(show_queue);
        lines_to_show.map(line_id => { delete show_queue[line_id]; show_notes(line_id); });
    }

    function show_notes(line_id) {
        if (!lines.hasOwnProperty(line_id)) {
            lines[line_id] = {
                notes: [],
                populated: false
            }
        }

        let line_row = $(`#${line_id}-row`);
        let line_words_col = $(`#${line_id}-words-col`);
        let line_variant_div = $(`#${line_id}-variant-div`);
        let line_witness_col = $(`#${line_id}-witness-col`);
        let line_witness_meter = $(`#${line_id}-witness-meter`);
        let meter_height = line_witness_col.innerHeight();

        line_variant_div.removeClass('hidden');
        line_witness_meter.removeClass('hidden');

        if (!lines[line_id].populated) {
            draw_witness_meter(
                line_row.attr('data-witness_indicators'),
                `${line_id}-witness-meter`,
                line_witness_col.innerWidth(),
                meter_height
            );

            // make note/variant elements
            lines[line_id].notes.map(note_id => {
                if(!notes[note_id].populated) {
                    notes[note_id].variants.map(variant => {
                        let variant_words = variant.variant;
                        if (!variant_words) {
                            if (variant.description === null) {
                                variant_words = `Error with variant transform: <a href='${notes[note_id].uri}/' target='_blank'>Note</a> <a href='${variant.uri}/' target='_blank'>Variant</a>`;
                            } else {
                                variant_words = `<span class="variant-note">${variant.description}</span>`;
                            }
                        }

                        notes[note_id].lines.map(line => {
                            $(`#${line.xml_id}-variant-div`).append(`
                                <div class="row no-gutters variant-row">
                                    <div class="col-sm-4 p-0 m-0">
                                        <div class="row no-gutters">
                                            <div id="variant-${variant.id}" class="col-sm-12 p-0 m-0 witness-meter">
                                                <canvas id="${line.xml_id}-${variant.id}-witness-meter"></canvas>
                                            </div>
                                        </div>
                                        <div class="row no-gutters">
                                            <div class="col-sm-12 witness-formula">
                                                ${variant.witness_formula}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-1 p-0 m-0 variant-play-label">&nbsp;</div>
                                    <div class="col-sm-7 p-0 m-0 variant-words">${variant_words}</div>
                                </div>
                            `);

                            $(`#${line.xml_id}-variant-toggler`).addClass('active');
                            $(`#${line.xml_id}-variant-div`).on('shown.bs.collapse', function (event) {
                                let indicator = $(`#${event.target.id.replace('-div', '-toggle')}`);
                                indicator.removeClass('fa-chevron-circle-right');
                                indicator.addClass('fa-chevron-circle-down');
                            });

                            $(`#${line.xml_id}-variant-div`).on('hidden.bs.collapse', function (event) {
                                let indicator = $(`#${event.target.id.replace('-div', '-toggle')}`);
                                indicator.removeClass('fa-chevron-circle-down');
                                indicator.addClass('fa-chevron-circle-right');
                            });

                            let variant_col = $(`#${line.xml_id}-witness-col`);
                            draw_witness_meter(
                                variant.witness_meter,
                                `${line.xml_id}-${variant.id}-witness-meter`,
                                variant_col.outerWidth(),
                                25,
                                "#FFFFFF"
                            );
                        });
                    });
                    notes[note_id].populated = true;
                }
            });

            lines[line_id].populated = true;
        }
    }

    function hide_notes(line_id) {
        let line_variant_toggler = $(`#${line_id}-variant-toggler`);
        let line_variant_div = $(`#${line_id}-variant-div`);
        let line_witness_meter = $(`#${line_id}-witness-meter`);

        line_variant_div.addClass('hidden');
        line_witness_meter.addClass('hidden');
    }

    function draw_witness_header_and_background() {
        let witness_centuries = {};
        witnesses.map(wit => {
            let century = wit.pub_date[0] + wit.pub_date[1] + "00";
            if (!witness_centuries.hasOwnProperty(century)) {
                witness_centuries[century] = 1;
            } else {
                witness_centuries[century] += 1;
            }
        });

        let width = $('#witness-header-col').width();
        let witness_width = width / witnesses.length;
        let header_height = 50;

        let header_canvas = $('#witness-header-canvas');
        header_canvas.attr('width', `${width}px`);
        header_canvas.attr('height', `${header_height}px`);
        let header_context = header_canvas[0].getContext('2d');
        let font_size = 15;
        header_context.font = `${font_size}px Roboto`;
        header_context.fillStyle = "#a7a7a7";
        header_context.textAlign = "left";
        header_context.textBaseline = "bottom";

        let background_canvas = $('#witness-background-canvas');
        let background_height = $('#main-container').innerHeight();
        background_canvas.css('position', 'absolute');
        background_canvas.css('top', 0);
        background_canvas.css('left', 0);
        background_canvas.attr('height', `${background_height}px`);
        background_canvas.attr('width', `${width}px`);
        background_canvas.css('z-index', '-1');
        let background_context = background_canvas[0].getContext('2d');

        let century_cursor = 0;
        let width_cursor = 0;
        for (let century in witness_centuries) {
            let century_width = witness_centuries[century] * witness_width;

            if (century_cursor % 2 === 0) {
                header_context.beginPath();
                header_context.fillStyle = "#f4f4f4";
                header_context.fillRect(width_cursor, 0, century_width, header_height);

                background_context.beginPath();
                background_context.fillStyle = "#f4f4f4";
                background_context.fillRect(width_cursor, 0, century_width, background_height);
            }

            header_context.save();
            header_context.fillStyle = "#a7a7a7";
            header_context.translate(width_cursor + 5, header_height - 5);
            header_context.rotate(-Math.PI / 2);
            header_context.fillText(century, 0, font_size);
            header_context.restore();

            century_cursor += 1;
            width_cursor += century_width;
        }
    }

    function draw_witness_meter(witness_meter, canvas_id, width, height, inactive_color="#9A9A99") {
        let color_map = {
            '0': inactive_color,
            '1': '#f7bb78',
            '2': '#faae63',
            '3': '#f99b4e',
            '4': '#ef8537',
            '5': '#d87b48',
            '6': '#de6d4b',
            '7': '#bd5822',
            '8': '#a84f1f',
            '9': '#8f2d13',
        };

        let wm_canvas = $(`#${canvas_id}`);
        wm_canvas.attr('width', width);
        wm_canvas.attr('height', height);
        let wm_context = wm_canvas[0].getContext('2d');
        // line below turns on transparency
        // wm_context.globalAlpha = 0.7;
        let witness_width = width / witnesses.length;

        for (let meter_index = 0; meter_index < witness_meter.length; meter_index++) {
            wm_context.beginPath();
            wm_context.fillStyle = color_map[witness_meter[meter_index]];

            wm_context.fillRect(
                meter_index * witness_width,
                0,
                witness_width - 1,
                height
            );

        }
    }

    </script>
    </body>
</html>