{% load static %}
{% load extras %}
<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="apple-touch-icon" sizes="180x180" href="/static/img/icon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/static/img/icon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/static/img/icon/favicon-16x16.png">
        <link rel="manifest" href="/static/img/icon/site.webmanifest">
        <link rel="mask-icon" href="/static/img/icon/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">

        <!-- CSS -->
        <link href="{% static 'css/fontawesome.min.css' %}" rel="stylesheet">
        <link href="{% static 'css/regular.min.css' %}" rel="stylesheet">
        <link href="{% static 'css/solid.min.css' %}" rel="stylesheet">
        <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
        <!--<link href="{% static 'css/nvs.css' %}" rel="stylesheet">-->

        <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital@0;1&display=swap" rel="stylesheet">
        <style title="main-sheet">
            /* -----------------------------
            || MAIN CSS VARIABLES
            || -------------------------- */
            :root {
                {% if site_request %}
                --scrollbarURL: url("/minimap/{{ play.prefix }}/?width=60&height=1000");
                {% else %}
                --scrollbarURL: url("/corpus/{{ corpus_id }}/play-minimap/{{ play.prefix }}/?width=60&height=1000");
                {% endif %}
                --nvs-form-control-height: 35px;
                --nvs-play-row-min-height: 40px;
                --nvs-form-control-font-size: 12px;
                --nvs-background-color: #FFFFFF;
                --nvs-lightest-gray: #F2F2F2;
                --nvs-lighter-gray: #C4C4C4;
                --nvs-mid-gray: #828282;
                --nvs-dark-blue: #085294;
                --nvs-primary-orange: #CC5F38;
                --nvs-secondary-orange: #F1B06E;
                --nvs-light-beige: #FBF5F1;
                --nvs-dark-beige: #EBE4DD;
            }

            body {
                background-color: #FFFFFF;
            }

            canvas {
                display: block;
            }

            @font-face {
                font-family: "FormulaSerial";
                src: url("{% static 'font/FormulaSerial.woff2' %}") format('woff2'), url("{% static 'font/FormulaSerial.woff' %}") format('woff');
            }

            /* -----------------------------
            || HEADERS AND CONTROLS
            || -------------------------- */

            .bg-nvs-lightest-gray {
                background-color: var(--nvs-lightest-gray);
            }

            .heading-section-label {
                font-family: 'Roboto', sans-serif;
                color: var(--nvs-dark-blue);
                font-size: 14px;
                font-weight: bold;
            }

            .heading-label {
                font-family: 'Roboto', sans-serif;
                color: var(--nvs-mid-gray);
                font-size: 14px;
                font-weight: bold;
            }

            .view-col {
                border-left: solid 5px var(--nvs-background-color);
                border-right: solid 5px var(--nvs-background-color);
            }

            .nvs-selection {
                position: relative;
            }

            .nvs-selection:after {
                content: '\f0d7';
                font-family: "Font Awesome 5 Free";
                font-weight: 900;
                font-size: 25px;
                color: var(--nvs-lighter-gray);
                right: 10px;
                top: 4px;
                height: 35px;
                position: absolute;
                pointer-events: none;
            }

            select::-ms-expand {
                display: none;
            }

            .nvs-search, .nvs-selection select, input[type=text], input[type=button] {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                /* Add some styling */

                display: block;
                width: 100%;
                height: var(--nvs-form-control-height);
                float: right;
                margin: 2.5px 0px;
                padding: 0px 10px;
                font-size: var(--nvs-form-control-font-size);
                line-height: 1;
                color: #333;
                background-color: #ffffff;
                background-image: none;
                border: 1px solid var(--nvs-lighter-gray);
                -ms-word-break: normal;
                word-break: normal;
            }

            .nvs-selection select {
                font-size: 16px;
            }

            .nvs-search {
                position: relative;
                height: unset;
                min-height: var(--nvs-form-control-height);
                padding: 10px;
                max-height: 150px;
                overflow-x: hidden;
                overflow-y: auto;
            }

            .nvs-search:empty:before{
                content: attr(placeholder);
                color: var(--nvs-mid-gray);
                pointer-events: none;
                display: block;
            }

            .nvs-search:empty:after {
                content: '\f002';
                font-family: "Font Awesome 5 Free";
                font-weight: 900;
                font-size: 18px;
                color: var(--nvs-lighter-gray);
                right: 10px;
                top: 6px;
                height: 35px;
                position: absolute;
                pointer-events: none;
            }

            input[type=button] {
                cursor: pointer;
                background-color: var(--nvs-primary-orange);
                color: var(--nvs-background-color);
            }

            input.nvs-secondary-button {
                background-color: var(--nvs-secondary-orange);
            }

            input[type=checkbox] {
                height: 20px;
                left: 0;
                opacity: 0;
                position: absolute;
                top: 0;
                width: 30px;
            }

            .toggle-control {
                display: block;
                position: relative;
                padding-left: 40px;
                cursor: pointer;
                font-size: 22px;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            .toggle-control input {
                position: absolute;
                opacity: 0;
                cursor: pointer;
                height: 0;
                width: 0;
            }
            .toggle-control input:checked ~ .control {
                background-color: var(--nvs-primary-orange);
            }
            .toggle-control input:checked ~ .control:after {
                left: 22px;
            }
            .toggle-control .control {
                position: absolute;
                top: 0;
                left: 0;
                height: 20px;
                width: 40px;
                border-radius: 10px;
                background-color: var(--nvs-mid-gray);
                -webkit-transition: background-color 0.15s ease-in;
                transition: background-color 0.15s ease-in;
            }
            .toggle-control .control:after {
                content: "";
                position: absolute;
                left: 2px;
                top: 2px;
                width: 16px;
                height: 16px;
                border-radius: 10px;
                background: var(--nvs-background-color);
                -webkit-transition: left 0.15s ease-in;
                transition: left 0.15s ease-in;
            }
            .toggle-control .heading-label {
                position: relative;
                top: -10px;
                left: 10px;
            }
            label.toggle-control {
                margin-bottom: 0px!important;
            }

            /* -----------------------------
            || PLAY READER VIEW
            || -------------------------- */

            #witness-header {
                height: var(--nvs-form-control-height);
                width: 100%;
            }

            #playtext-col, #commentary-col {
                overflow-y: scroll;
                max-height: calc(100vh - 60px);
                background-repeat: no-repeat;
            }

            #playtext-col::-webkit-scrollbar {
                width: 60px;
            }

            #playtext-col::-webkit-scrollbar-track {
                background-image: var(--scrollbarURL);
                background-size: contain;
                background-repeat: no-repeat;
            }

            #playtext-col::-webkit-scrollbar-thumb {
                background-color: rgba(247, 155, 86, .5);
            }

            .play-row {
                border-bottom: solid 4px #fbeee0;
                min-height: var(--nvs-play-row-min-height);
            }

            .play-label {
                background-color: var(--nvs-light-beige);
                font-family: 'Roboto', sans-serif;
                font-size: 1.2vw;
                border: none;
                -webkit-box-align: center!important;
                -ms-flex-align: center!important;
                align-items: center!important;
                display: -webkit-box!important;
                display: -ms-flexbox!important;
                display: flex!important;
            }

            .play-words, .play-words-seen {
                padding-top: 10px;
                padding-bottom: 5px;
                font-family: 'Libre Baskerville', serif;
                font-size: 1.3vw;
                color: #070707;
                background-color: var(--nvs-background-color);
                -webkit-box-align: center!important;
                -ms-flex-align: center!important;
                align-items: center!important;
                display: -webkit-box!important;
                display: -ms-flexbox!important;
                display: flex!important;
            }

            span.castgroup {
                margin-left: 10px;
            }

            span.role {
                font-weight: bold;
            }

            span.roledesc {
                font-style: italic;
                display: inline-block;
            }

            span.stage {
                font-style: italic;
            }

            span.speaker-abbreviation {
                font-style: italic;
                display: inline-block;
                margin-right: 10px;
                margin-left: 10px;
            }

            .witness-meter, .variant-witness-meter {
                -webkit-box-align: center!important;
                -ms-flex-align: center!important;
                align-items: center!important;
                display: -webkit-box!important;
                display: -ms-flexbox!important;
                display: flex!important;
            }

            .variant-toggler, .variant-toggler:hover {
                text-decoration: none;
                color: #f99b4e;
            }

            .variant-row {
                /*background-color: #efefef;*/
                background-color: rgba(154, 154, 153, 0.1);
                border-bottom: solid 4px #fbeee0;
            }

            .witness-formula {
                color: #f99b4e;
                font-family: 'Roboto', sans-serif;
                font-size: 12px;
                text-transform: uppercase;
            }

            .variant-play-label {
                background-color: #f2f2f2;
            }

            .variant-words {
                font-family: 'Libre Baskerville', serif;
                color: #949494;
                padding-left: 37px;
                padding-top: 10px;
                padding-bottom: 5px;
            }

            .variant-note {
                color: #070707;
            }

            h3.heading {
                margin-top: 0px;
                margin-bottom: 0px;
            }

            span.difference {
                color: #e9702b;
                background-color: #d8d8d8;
            }

            comspan {
                background-color: rgba(144, 188, 226, .3);
                border-bottom: solid 1px rgb(144, 188, 226);
                cursor: pointer;
            }

            .comm-heading {
                background-color: #c4dffc;
                font-family: 'Libre Baskerville', serif;
                cursor: pointer;
                color: #525e69;
            }

            .comm-block {
                color: #0e0e0e;
                font-family: 'FormulaSerial';
                margin-bottom: 20px;
            }

            #search-widget {
                position: fixed;
                bottom: 0;
                width: 100%;
                z-index: 2000;
                pointer-events: none;
            }

            /* -----------------------------
            || NAV MODAL
            || -------------------------- */

            #nav-modal-label {
                font-family: 'Libre Baskerville', serif;
            }

            #nav-modal-body {
                font-family: 'FormulaSerial';
                overflow-y: scroll;
                max-height: calc(80vh);
            }
        </style>

        <title>Winter's Tale</title>
    </head>
    <body>
        <!-- Navigation Modal -->
        <div class="modal fade" id="nav-modal" tabindex="-1" role="dialog" aria-labelledby="nav-modal-label" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="nav-modal-label"></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div id="nav-modal-body" class="modal-body">

                    </div>
                    <!--<div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>-->
                </div>
            </div>
        </div>

        <div id="main-container" class="container-fluid h-100">

            <!-- MAIN HEADER -->
            <div id="main-header" class="row">

                <!-- NVS LOGO -->
                <div class="d-none d-lg-flex justify-content-center col-lg-1 pt-4 px-1">
                    <figure>
                    <img src="{% static 'img/nvs-logo.png'%}" class="img-fluid" style="max-height: 85px;">
                    </figure>
                </div>

                <!-- TEXT SETTINGS -->
                <div class="col-sm-12 col-md-5 col-lg-4">
                    <div class="heading-section-label">Text</div>
                    <div class="row p-1">
                        <div class="col-sm-12 bg-nvs-lightest-gray p-0 p-sm-2">
                            <div class="heading-label">PLAY</div>
                            <div class="nvs-selection">
                                <select id="play-selector" class="font-weight-bold">
                                    <option value="wt">The Winter's Tale</option>
                                </select>
                            </div>
                            <div class="row">
                                <!-- search play box -->
                                <div class="col-sm-6 pr-sm-1">
                                    <div id="hdr-quick-search-box" class="nvs-search" placeholder="SEARCH THIS PLAY" contentEditable="plaintext-only"></div>
                                </div>

                                <!-- play line no box -->
                                <div class="col-sm-4 p-sm-0">
                                    <input id="hdr-line-no-box" type="text" placeholder="ENTER LINE#" />
                                </div>

                                <!-- play go button -->
                                <div class="col-sm-2 pl-sm-1">
                                    <input type="button" value="GO">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FILTER SETTINGS -->
                <div class="col-sm-6 col-md-4">
                    <div class="heading-section-label">Filter</div>
                    <div class="row p-1">
                        <div class="col-sm-12 bg-nvs-lightest-gray p-0 p-sm-2">
                            <div class="row align-items-end">
                                <!-- act/scene -->
                                <div class="col-sm-5 pr-sm-1">
                                    <div class="heading-label">ACT, SCENE</div>
                                    <div class="nvs-selection">
                                        <select id="hdr-act-scene-selector">
                                            <option value="all">ALL</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- character -->
                                <div class="col-sm-5 p-sm-0">
                                    <div class="heading-label">CHARACTER</div>
                                    <div class="nvs-selection">
                                        <select id="hdr-character-selector">
                                            <option value="all">ALL</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- filter go button -->
                                <div class="col-sm-2 pl-sm-1">
                                    <input type="button" value="GO">
                                </div>
                            </div>

                            <div class="row">
                                <!-- advanced search -->
                                <div class="col-sm-12">
                                    <div class="nvs-search" placeholder="ADVANCED SEARCH" contentEditable="true"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW SETTINGS -->
                <div class="col-sm-6 col-md-3" style="border-right: solid 5px var(--nvs-background-color);">
                    <div class="heading-section-label">View</div>
                    <div class="row p-1">
                        <div class="col-sm-12 bg-nvs-lightest-gray p-0 p-sm-2">
                            <div class="row">
                                <div class="col-sm-7">
                                    <!-- reader view -->
                                    <label class="toggle-control">
                                        <input type="checkbox" checked="checked">
                                        <span class="control"></span>
                                        <span class="heading-label">READER</span>
                                    </label>

                                    <!-- list view -->
                                    <label class="toggle-control">
                                        <input type="checkbox">
                                        <span class="control"></span>
                                        <span class="heading-label">LIST</span>
                                    </label>

                                    <!-- chart view -->
                                    <label class="toggle-control">
                                        <input type="checkbox">
                                        <span class="control"></span>
                                        <span class="heading-label">CHART</span>
                                    </label>
                                </div>
                                <div class="col-sm-5">
                                    <input type="button" id="hdr-reset-button" class="nvs-secondary-button" value="RESET">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- QUANTITATIVE VIEW -->
            {% if nvs_session.preferences.show_quantitative_view %}
            <div id="quantitative-view" class="row no-gutters">
            </div>
            {% endif %}

            <!-- READER VIEW -->
            {% if nvs_session.preferences.show_reader_view %}
            <div id="reader-view" class="row flex-grow-1">
                <div id="main-col" class="col-md-12 col-lg-12 mt-2 p-1 view-col bg-nvs-lightest-gray">

                    <!-- header row -->
                    <div class="row">
                        <div class="d-none d-sm-block col-sm-3">
                            <div class="heading-section-label">READER VIEW</div>

                            <!-- witness header -->
                            <div id="witness-header">
                                <canvas id="witness-header-canvas"></canvas>
                            </div>
                        </div>

                        <!-- variant controls -->
                        <div class="col-sm-2 offset-sm-2 pl-sm-0 pr-sm-1">
                            <div class="heading-label">VARIANTS</div>
                            <div class="nvs-selection">
                                <select id="play-selector">
                                    <option value="all">SHOW PRIMARY</option>
                                </select>
                            </div>
                        </div>

                        <!-- commentary controls -->
                        <div class="col-sm-3 px-sm-0">
                            <div class="heading-label">COMMENTARY</div>
                            <div class="nvs-selection">
                                <select id="play-selector">
                                    <option value="all">SHOW NOTES & HIGHLIGHTS</option>
                                </select>
                            </div>
                        </div>

                        <!-- numbering controls -->
                        <div class="col-sm-2 pl-sm-1 pr-sm-0">
                            <div class="heading-label">NUMBERING</div>
                            <div class="nvs-selection">
                                <select id="play-selector">
                                    <option value="all">TLN</option>
                                </select>
                            </div>
                        </div>
                    </div>


                    <div class="row">
                        <!-- PLAYTEXT -->
                        <div id="playtext-col" class="col-sm-9 pr-0">
                            {% for line in lines %}
                                <div id="{{ line.xml_id }}-row"
                                     class="row no-gutters play-row offscreen"
                                     data-xml_id="{{ line.xml_id }}"
                                     data-line_number="{{ line.line_number }}"
                                     data-line_label="{{ line.line_label }}"
                                     data-text="{{ line.text }}"
                                     data-text-length="{{ line.text|length }}"
                                     data-witness_indicators="{{ line.witness_meter }}"
                                >
                                    <div id="{{ line.xml_id }}-witness-col" class="col-sm-4 m-0 p-0 witness-meter">
                                        <!--<canvas id="{{ line.xml_id }}-witness-meter" height="36px"></canvas>-->
                                        <img id="{{ line.xml_id }}-witness-meter" height="36" width="100%" src="{% static 'img/blank-meter.png'%}" />
                                    </div>
                                    <div id="{{ line.xml_id }}-number-col" class="col-sm-1 m-0 p-0 play-label">
                                        {% if line.witness_meter|to_int > 0 %}
                                            <a id="{{ line.xml_id }}-variant-toggler"
                                                   class="variant-toggler mx-1"
                                                   data-toggle="collapse"
                                                   href="#{{ line.xml_id }}-variant-div"
                                                   role="button"
                                                   aria-expanded="false"
                                                   aria-controls="{{ line.xml_id }}-variant-div"
                                                >
                                                <i id="{{ line.xml_id }}-variant-toggle" class="fas fa-chevron-circle-right"></i>
                                            </a>
                                        {% else %}
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        {% endif %}
                                        {{ line.line_label }}
                                    </div>
                                    <div id="{{ line.xml_id }}-text-col" class="col-sm-7 m-0 p-0 play-words offscreen">
                                        {{ line.rendered_html|safe }}
                                    </div>

                                </div>
                                {% if line.witness_meter|to_int > 0 %}
                                    <div class="collapse" class="variant-drawer" id="{{ line.xml_id }}-variant-div"></div>
                                {% endif %}
                            {% endfor %}

                        </div>

                        <!-- COMMENTARY -->
                        <div id="commentary-col" class="col-sm-3">
                            <div id="commentary-frame"></div>
                        </div>
                    </div>

                </div>
            </div>
            {% endif %}

            <!-- LIST VIEW -->
            {% if nvs_session.preferences.show_list_view %}
            <div id="quantitative-view" class="row no-gutters">
            </div>
            {% endif %}
        </div>
        <div id="search-widget" class="d-none container-fluid">
            <div class="row">
                <div class="col-sm-6 offset-sm-3">
                    <div class="d-flex flex-row justify-content-between align-items-center bg-nvs-lightest-gray" style="pointer-events: auto;">
                        <ul id="search-widget-tabs" class="nav nav-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <a class="nav-link active" id="search-widget-line-tab" data-toggle="tab" href="#search-widget-lines" role="tab" aria-controls="search-widget-lines" aria-selected="true">Lines (<span class="search-line-total">0</span>)</a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <a class="nav-link" id="search-widget-variant-tab" data-toggle="tab" href="#search-widget-variants" role="tab" aria-controls="explore" aria-selected="false">Variants (<span class="search-variant-total">0</span>)</a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <a class="nav-link" id="search-widget-commentary-tab" data-toggle="tab" href="#search-widget-commentary" role="tab" aria-controls="search-widget-commentary" aria-selected="false">Commentary (<span class="search-commentary-total">0</span>)</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="search-widget-lines" role="tabpanel" aria-labelledby="search-widget-line-tab">
                                <a id="search-line-prev" onClick="display_search_result('line', 'prev');"><i class="fas fa-chevron-left"></i></a>
                                <span id="search-line-current">0</span> out of
                                <span class="search-line-total">0</span>
                                <a id="search-line-next" onClick="display_search_result('line', 'next');"><i class="fas fa-chevron-right"></i></a>
                            </div>
                            <div class="tab-pane fade" id="search-widget-variants" role="tabpanel" aria-labelledby="search-widget-variant-tab">
                                <a id="search-variant-prev" onClick="display_search_result('variant', 'prev');"><i class="fas fa-chevron-left"></i></a>
                                <span id="search-variant-current">0</span> out of
                                <span class="search-variant-total">0</span>
                                <a id="search-variant-next" onClick="display_search_result('variant', 'next');"><i class="fas fa-chevron-right"></i></a>
                            </div>
                            <div class="tab-pane fade" id="search-widget-commentary" role="tabpanel" aria-labelledby="search-widget-commentary-tab">
                                <a id="search-commentary-prev" onClick="display_search_result('commentary', 'prev');"><i class="fas fa-chevron-left"></i></a>
                                <span id="search-commentary-current">0</span> out of
                                <span class="search-commentary-total">0</span>
                                <a id="search-commentary-next" onClick="display_search_result('commentary', 'next');"><i class="fas fa-chevron-right"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="{% static 'js/jquery-3.3.1.min.js' %}"></script>
        <script src="{% static 'js/popper.min.js' %}"></script>
        <script src="{% static 'js/bootstrap.min.js' %}"></script>
        <script src="{% static 'js/jquery.mark.min.js' %}"></script>
        <script src="{% static 'js/corpora.js' %}"></script>
        <script type="application/javascript">
    let corpora;
    let corpus_id = "{{ corpus_id }}";
    let play_prefix = "{{ play.prefix }}";
    let play_id = "{{ play.id }}";

    let playviewer_url = {% if site_request %}`/play/${play_prefix}/`{% else %}`/corpus/${corpus_id}/play-viewer/${play_prefix}/`{% endif %};
    let search_endpoint = {% if site_request %}`${window.location.protocol}//${window.location.host}/search/${play_prefix}/`{% else %}`/api/corpus/${corpus_id}/nvs-search/${play_prefix}/`{% endif %};
    let witness_meter_prefix = {% if site_request %}`/witnessmeter/`{% else %}`/nvs/witness-meter/`{% endif %};
    let paratext_prefix = {% if site_request %}`/paratext/${play_prefix}/`{% else %}`/corpus/${corpus_id}/paratext-viewer/${play_prefix}/`{% endif %};
    let minimap_url = {% if site_request %}`/minimap/${play_prefix}/`{% else %}`/corpus/${corpus_id}/play-minimap/${play_prefix}/`{% endif %};

    let style_sheet = null;
    let current_act_scene = "{{ nvs_session.filter.act_scene }}";
    let current_character = "{{ nvs_session.filter.character }}";
    let corpus;
    let screen_size = 'large';
    let meter_height = () => Math.round(window.innerHeight / (100 / 3)) + 'px';

    let witnesses = {{ witnesses|safe }};
    let witness_centuries = {{ witness_centuries|safe }};
    let witness_count = {{ witness_count }};
    let notes = {{ notes|safe }};
    let line_note_map = {{ line_note_map|safe }};
    let act_scenes = {{ act_scenes|safe }};
    let characters = null;
    let lines = {};
    let line_observer = null;
    let commentary_observer = null;
    let last_visible_line = -1;
    let last_commentary_line = 0;
    let remaining_commentaries = true;
    let commentaries = {};
    let commentary_loaded = false, characters_loaded = false;
    let comm_timer = null;
    let nvs_search = null;

    let nav_map = {
        'lb': {
            'content_type': 'PlayLine',
            'xml_id_field': 'xml_id',
            'content_field': 'rendered_html',
            'title': 'Play Line',
            'title_plural': 'Play Lines',
            'scroll_anchor': false
        },
        'bibl': {
            'content_type': 'Document',
            'xml_id_field': 'siglum',
            'content_field': 'bibliographic_entry',
            'title': "Bibliographic Entry",
            'title_plural': "Bibliographic Entries",
            'scroll_anchor': false
        },
        'siglum': {
            'content_type': 'Document',
            'xml_id_field': 'siglum',
            'content_field': 'bibliographic_entry',
            'title': "Collated Edition",
            'title_plural': "Collated Editions",
            'scroll_anchor': false
        },
        'note_cn': {
            'content_type': 'Commentary',
            'xml_id_field': 'xml_id',
            'content_field': 'contents',
            'title': "Commentary Note",
            'title_plural': "Commentary Notes",
            'scroll_anchor': false
        },
        'anchor': {
            'content_type': 'ParaText',
            'xml_id_field': 'child_xml_ids',
            'content_field': 'html_content',
            'title': "Appendix",
            'title_plural': "Appendix",
            'scroll_anchor': true
        }
    };
    let nav_history = [];
    let nav_history_cursor = 0;

    $(document).ready(function() {
        corpora = new Corpora({'csrf_token': "{{ csrf_token }}"{% if site_request %}, 'host': '{{ corpora_url }}'{% endif %}});
        screen_size = determine_screen_size(window.innerWidth);
        style_sheet = document.styleSheets[0];
        $(":root").css("--scrollbarURL", `url(${minimap_url}?width=60&height=${parseInt($("#playtext-col").height())})`);
        draw_witness_header_and_background();

        // GET CHARACTER NAMES; POSSIBLY FILTERED BY ACT/SCENE
        let speech_params = {
            'page-size': 0,
            'a_terms_characters': 'speaking.xml_id,speaking.name',
        };
        if (current_act_scene !== 'all') {
            if (current_act_scene.includes('.')) {
                let [current_act, current_scene] = current_act_scene.split('.');
                speech_params['f_act'] = current_act;
                speech_params['f_scene'] = current_scene;
            } else {
                speech_params['f_act'] = current_act_scene;
            }
        }
        corpora.list_content(
            corpus_id,
            'Speech',
            speech_params,
            function(char_data) {
                if (char_data.hasOwnProperty('meta') && char_data.meta.hasOwnProperty('aggregations') && char_data.meta.aggregations.hasOwnProperty('characters')) {
                    let char_selector = $('#hdr-character-selector');
                    Object.keys(char_data.meta.aggregations.characters).map(char_id_name => {
                        let [char_xml_id, char_name] = char_id_name.split('|||');
                        let selected = current_character === char_xml_id ? ' selected' : '';
                        char_selector.append(`
                            <option value="${char_xml_id}"${selected}>${char_name}</option>
                        `);
                    });
                }
                characters_loaded = true;
            }
        );

        setup_lines();
        configure_controls();

        $('.witness-meter').click(function(){
            let line_id = this.id.replace('-witness-col', '');
            let witness_indicators = $(`#${line_id}-row`).data('witness_indicators');
            display_variant_editions(witness_indicators);
        });

        $('comspan').mouseover(function(ev) {
            let selector = `comspan.${ev.target.className}`;
            style_sheet.insertRule(`
                ${selector} {
                    border: solid 1px var(--nvs-primary-orange);
                }
            `);

            setTimeout(delete_css_rule.bind(null, selector), 3000);
        });

        $('comspan').mouseleave(function(ev) {
            let selector = `comspan.${ev.target.className}`;
            delete_css_rule(selector);
        });

        let nav_type = get_param('nav_type');
        let nav_xml_id = get_param('nav_xml_id');
        if (nav_type && nav_xml_id) {
            show_nav_content(nav_type, nav_xml_id);
        }

        //setTimeout(wait_for_load, 1000);

    });

    function delete_css_rule(selector) {
        let rule_deletion_index = -1;
        for (let rule_index = 0; rule_index < style_sheet.cssRules.length; rule_index++) {
            if (style_sheet.cssRules[rule_index].selectorText === selector) {
                rule_deletion_index = rule_index;
                break;
            }
        }

        if (rule_deletion_index > -1) {
            style_sheet.deleteRule(rule_deletion_index);
        }
    }

    function configure_controls() {
        // HEADER: LINE# BOX
        $('#hdr-line-no-box').keypress(function(e) {
            if (e.which === 13) {
                let line_no = $('#hdr-line-no-box').val();
                if (`tln_${line_no}` in lines) {
                    $(`#tln_${line_no}-row`)[0].scrollIntoView({behavior: 'smooth'});
                }
            }
        });

        // HEADER: QUICK SEARCH BOX
        $('#hdr-quick-search-box').keypress(function(e) {
            if (e.which === 13) {
                let qs_box = $('#hdr-quick-search-box');
                let query = qs_box.text().trim();
                qs_box.empty();
                qs_box.html(query);
                corpora.make_request(
                    search_endpoint,
                    'POST',
                    {
                        quick_search: query
                    },
                    process_search_results
                );
                return false;
            }
        });

        // HEADER: ACT, SCENE BOX
        $('#hdr-act-scene-selector').change(function() {
            let selection = $('#hdr-act-scene-selector').val();
            window.location = `${playviewer_url}?act-scene=${selection}`;
        });

        // HEADER: CHARACTER BOX
        $('#hdr-character-selector').change(function() {
            let selection = $('#hdr-character-selector').val();
            window.location = `${playviewer_url}?character=${selection}`;
        });

        // HEADER: RESET BUTTON
        $('#hdr-reset-button').click(function() {
            window.location = `?reset=true`;
        });

        // COMMENTARY HIGHLIHT CLICK
        $('comspan').click(function(e) {
            let comm_id = this.className.replace('commentary-lemma-', '');
            comm_id = `commentary-note-${comm_id}`;
            setTimeout(delayed_scroll.bind(null, comm_id, false), 300);
            e.stopPropagation();
        });

        // VARIANT TOGGLER CLICK
        $('.variant-toggler').click(function() {
            let line_xml_id = this.id.replace('-variant-toggler', '');
            if (!lines[line_xml_id].populated) {
                show_notes(line_xml_id);
            }
            $('.variant-siglum').off('mouseenter').on('mouseenter', function() {
                let link = $(this);
                let siglum = `s_${link.html().toLowerCase()}`;
                if (siglum in witnesses) {
                    let parent_div = link.parent();
                    let line_id = parent_div.data('line-id');
                    let variant_id = parent_div.data('variant-id');
                    let wit_meter = $(`#${line_id}-${variant_id}-witness-meter`);
                    let wit_indicators = wit_meter.data('witness_indicators');
                    witnesses[siglum].slots.map(slot => {
                        wit_indicators = wit_indicators.substr(0, slot) + 'x' + wit_indicators.substr(slot + 1);
                    });
                    let url_parts = wit_meter.attr('src').split('/');
                    url_parts[url_parts.length - 5] = wit_indicators;
                    wit_meter.attr('src', url_parts.join('/'));
                }
            });

            $('.variant-witness-meter').off('click').on('click', function() {
                let witness_indicators = $(this).find('img').data('witness_indicators');
                display_variant_editions(witness_indicators);
            });
        });

        // SETUP CHARACTERS
        let act_scene_selector = $('#hdr-act-scene-selector');
        Object.keys(act_scenes).map(act_scene_label => {
            let selected = '';
            if (act_scenes[act_scene_label] === current_act_scene) {
                selected = ' selected'
            }

            act_scene_selector.append(`
                <option value="${act_scenes[act_scene_label]}"${selected}>${act_scene_label}</option>
            `);
        });

        // SEARCH TABS
        $('#search-widget-line-tab').click(function() {
            if (nvs_search && nvs_search.hasOwnProperty('current_line_result')) {
                if (nvs_search.current_line_result === 0 || nvs_search.line_results.length === 1) {
                    nvs_search.current_line_result = 0;
                    display_search_result('line', 'next');
                }
            }
        });
        $('#search-widget-variant-tab').click(function() {
            if (nvs_search && nvs_search.hasOwnProperty('current_variant_result')) {
                if (nvs_search.current_variant_result === 0 || nvs_search.variant_results.length === 1) {
                    nvs_search.current_variant_result = 0;
                    display_search_result('variant', 'next');
                }
            }
        });
        $('#search-widget-commentary-tab').click(function() {
            if (nvs_search && nvs_search.hasOwnProperty('current_commentary_result')) {
                if (nvs_search.current_commentary_result === 0 || nvs_search.commentary_results.length === 1) {
                    nvs_search.current_commentary_result = 0;
                    display_search_result('commentary', 'next');
                }
            }
        });
    }

    function get_nvs_var(variable_name) {
        return getComputedStyle(document.documentElement).getPropertyValue(`--${variable_name}`);
    }

    function determine_screen_size(width) {
        if (width < 768) { return 'small'; }
        else if (width < 992) { return 'medium'; }
        return 'large';
    }

    function show_notes(line_id) {
        let line_variant_div = $(`#${line_id}-variant-div`);
        let line_witness_meter = $(`#${line_id}-witness-meter`);

        line_variant_div.removeClass('hidden');
        line_witness_meter.removeClass('hidden');

        // make note/variant elements
        lines[line_id].notes.map(note_id => {
            if(!notes[note_id].populated) {
                notes[note_id].line_range = '';
                if (notes[note_id].lines.length > 1) {
                    let start_id = notes[note_id].lines[0].xml_id;
                    let end_id = notes[note_id].lines[notes[note_id].lines.length - 1].xml_id;
                    notes[note_id].line_range = `<span class='text-muted'>${lines[start_id].label}-${lines[end_id].label}: </span>`;
                }

                notes[note_id].variants.map(variant => {
                    let variant_words = variant.variant;
                    if (!variant_words) {
                        if (variant.description === null) {
                            variant_words = `Error with variant transform: <a href='${notes[note_id].uri}/' target='_blank'>Note</a> <a href='${variant.uri}/' target='_blank'>Variant</a>`;
                        } else {
                            variant_words = `<span class="variant-note">${variant.description}</span>`;
                        }
                    }
                    variant_words = notes[note_id].line_range + variant_words;

                    notes[note_id].lines.map(line => {
                        if (line.xml_id in lines) {
                            $(`#${line.xml_id}-variant-div`).append(`
                                <div class="row no-gutters variant-row">
                                    <div class="col-sm-4 p-0 m-0">
                                        <div class="row no-gutters">
                                            <div id="variant-${variant.id}" class="col-sm-12 p-0 m-0 variant-witness-meter">
                                                <img id="${line.xml_id}-${variant.id}-witness-meter" height="36" width="100%" src="{% static 'img/blank-meter.png'%}" data-witness_indicators="${variant.witness_meter}" />
                                            </div>
                                        </div>
                                        <div class="row no-gutters">
                                            <div class="col-sm-12 witness-formula" data-line-id="${line.xml_id}" data-variant-id="${variant.id}">
                                                ${variant.witness_formula}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-1 p-0 m-0 variant-play-label">&nbsp;</div>
                                    <div class="col-sm-7 p-0 m-0 variant-words">${variant_words}</div>
                                </div>
                            `);

                            $(`#${line.xml_id}-variant-div`).on('shown.bs.collapse', function (event) {
                                let indicator = $(`#${event.target.id.replace('-div', '-toggle')}`);
                                indicator.removeClass('fa-chevron-circle-right');
                                indicator.addClass('fa-chevron-circle-down');
                            });

                            $(`#${line.xml_id}-variant-div`).on('hidden.bs.collapse', function (event) {
                                let indicator = $(`#${event.target.id.replace('-div', '-toggle')}`);
                                indicator.removeClass('fa-chevron-circle-down');
                                indicator.addClass('fa-chevron-circle-right');
                            });

                            let variant_col = $(`#${line.xml_id}-witness-col`);
                            draw_witness_meter(
                                variant.witness_meter,
                                document.getElementById(`${line.xml_id}-${variant.id}-witness-meter`),
                                variant_col.outerWidth(),
                                25,
                                "#FFFFFF"
                            );
                        }
                    });
                });
                notes[note_id].populated = true;
            }
        });

        lines[line_id].populated = true;
    }

    function display_variant_editions(witness_indicators) {
        let wit_sigla = Object.keys(witnesses);
        let sigla = [];
        for (let slot = 0; slot < witness_indicators.length; slot++) {
            let indicator = witness_indicators.charAt(slot);
            if (indicator !== '0') {
                for (let sig_index = 0; sig_index < wit_sigla.length; sig_index++) {
                    if (witnesses[wit_sigla[sig_index]].slots.includes(slot) && !sigla.includes(wit_sigla[sig_index])) {
                        sigla.push(wit_sigla[sig_index]);
                        break;
                    }
                }
            }
        }

        let title = "Collated Editions for Variant";
        let content = "";
        sigla.map(siglum => {
            content += `<p><b>${siglum.replace('s_', '').toUpperCase()}</b> ${witnesses[siglum].bibliographic_entry}</p>`;
        });
        display_nav_modal(title, content);
    }

    function process_search_results(results) {
        if (results.last_commentary_line > last_commentary_line) {
            last_visible_line = results.last_commentary_line;
            commentary_loaded = false;
            load_commentary();
        }

        if (!commentary_loaded){
            setTimeout(process_search_results.bind(null, results), 1000)
        } else {
            console.log(results);
            $(":root").css("--scrollbarURL", `url(${minimap_url}?width=60&height=${parseInt($("#playtext-col").height())}&no-cache=${Math.floor(Date.now() / 1000)})`);
            if (nvs_search) {
                $('#reader-view').unmark();
            }

            nvs_search = {
                character_results: results.characters,
                line_results: results.lines,
                variant_results: results.variants,
                commentary_results: results.commentaries,
                current_line_result: 0,
                current_variant_result: 0,
                current_commentary_result: 0
            };

            $('.search-line-current').html('0');
            $('.search-variant-current').html('0');
            $('.search-commentary-current').html('0');
            $('.search-line-total').html(nvs_search.line_results.length);
            $('.search-variant-total').html(nvs_search.variant_results.length);
            $('.search-commentary-total').html(nvs_search.commentary_results.length);
            $('#search-line-prev').removeClass('d-none');
            $('#search-line-next').removeClass('d-none');
            $('#search-variant-prev').removeClass('d-none');
            $('#search-variant-next').removeClass('d-none');
            $('#search-commentary-prev').removeClass('d-none');
            $('#search-commentary-next').removeClass('d-none');
            $('#search-widget').removeClass('d-none');

            nvs_search.line_results.map(result => {
                let html_span = $(`#${result.xml_id}-text-col`);
                result.matches.map(match => html_span.mark(match));
            });

            nvs_search.variant_results.map(result => {
                show_notes(result.xml_id);
                $(`#${result.xml_id}-variant-div`).collapse('show');
                let html_span = $(`#${result.xml_id}-variant-div .variant-words`);
                result.matches.map(match => html_span.mark(match));
            });

            nvs_search.commentary_results.map((result, result_num) => {
                let comm_header = $(`#commentary-note-${result.comm_id}`);
                let comm_content = $(`#commentary-content-${result.comm_id}`);
                result.matches.map(match => {
                    comm_header.mark(match, {className: `search-commentary-result-${result_num}`});
                    comm_content.mark(match, {className: `search-commentary-result-${result_num}`});
                });
            });

            if (nvs_search.line_results.length) display_search_result('line', 'next');
            else if (nvs_search.variant_results.length) display_search_result('variant', 'next');
            else if (nvs_search.commentary_results.length) display_search_result('commentary', 'next');
            else display_nav_modal('No results.', 'No results for your search term were found.');
        }
    }

    function display_search_result(type, which) {
        $(`#search-widget-${type}-tab`).tab('show');

        if (which === 'next') {
            nvs_search[`current_${type}_result`] += 1;
        } else {
            nvs_search[`current_${type}_result`] -= 1;
        }

        if (type === 'commentary') {
            let comm_result_num = nvs_search.current_commentary_result - 1;
            document.getElementsByClassName(`search-commentary-result-${comm_result_num}`)[0].scrollIntoView({behavior: 'smooth'});
        }
        else {
            let result = nvs_search[`${type}_results`][nvs_search[`current_${type}_result`] - 1];
            let id_suffix = '-text-col';
            if (type === 'variant') id_suffix = '-variant-div';
            document.getElementById(`${result.xml_id}${id_suffix}`).scrollIntoView({behavior: 'smooth'});
        }

        $(`#search-${type}-current`).html(nvs_search[`current_${type}_result`]);
        if (nvs_search[`current_${type}_result`] === 1) {
            $(`#search-${type}-prev`).addClass('d-none');
        } else {
            $(`#search-${type}-prev`).removeClass('d-none');
        }

        if (nvs_search[`current_${type}_result`] === nvs_search[`${type}_results`].length) {
            $(`#search-${type}-next`).addClass('d-none');
        } else {
            $(`#search-${type}-next`).removeClass('d-none');
        }
    }

    function load_commentary() {
        if (commentary_observer === null) {
            commentary_observer = new IntersectionObserver(function(entries) {
                if (entries[0].isIntersecting) {
                    $(entries[0].target).remove();
                    if (remaining_commentaries) {
                        console.log('loading more commentary...');
                        last_visible_line += 20;
                        load_commentary();
                    }
                }
            }, { threshold: [0] });
        }

        let comm_frame = $('#commentary-frame');
        let comm_search = {};
        comm_search['r_lines.line_number'] = `${last_commentary_line}__${last_visible_line + 20}`;
        comm_search['s_id'] = 'asc';
        comm_search['page-size'] = 500;

        corpora.list_content(
            corpus_id,
            'Commentary',
            comm_search,
            function(comm_data) {
                if (comm_data.records.length) {
                    comm_data.records.map(comm => {
                        if (!commentaries.hasOwnProperty(comm.id)) {
                            comm_frame.append(`
                                <div class="row">
                                    <div id="commentary-note-${comm.id}" class="col-sm-12 comm-heading" onClick="document.getElementById('${comm.lines[0].xml_id}-row').scrollIntoView();">
                                        <a name="commentary-note-${comm.id}"></a>
                                        ${comm.line_label}: ${comm.subject_matter}
                                    </div>
                                </div>
                                <div class="row">
                                    <div id="commentary-content-${comm.id}" class="col-sm-12 comm-block">
                                        ${comm.contents}
                                    </div>
                                </div>
                            `);
                            commentaries[comm.id] = true;
                        }
                    });
                    let comm_spinner = $('#commentary-spinner');
                    if (comm_spinner.length) comm_spinner.remove();
                    comm_frame.append(`
                        <div id="commentary-spinner" class="row">
                            <div class="col-sm-12">
                                <i class="fas fa-spinner"></i>
                            </div>
                        </div>
                    `);
                    commentary_observer.observe($('#commentary-spinner')[0]);
                } else {
                    remaining_commentaries = false;
                }

                commentary_loaded = true;
            },
            true
        );
        last_commentary_line = last_visible_line + 20;
    }

    function draw_witness_header_and_background() {
        let wit_header = $('#witness-header');
        let width = wit_header.width();
        let witness_width = width / witness_count;
        let header_height = wit_header.height();

        let header_canvas = $('#witness-header-canvas');
        header_canvas.attr('width', `${width}px`);
        header_canvas.attr('height', `${header_height}px`);
        let header_context = header_canvas[0].getContext('2d');
        let light_beige = get_nvs_var('nvs-light-beige');
        let dark_beige = get_nvs_var('nvs-dark-beige');
        let font_color = get_nvs_var('nvs-mid-gray');
        let font_size = 12;
        header_context.font = `${font_size}px Roboto`;
        header_context.textAlign = "left";
        header_context.textBaseline = "bottom";

        let playtext_col = $('#playtext-col');
        let background_canvas = document.createElement('canvas');
        background_canvas.height = playtext_col.innerHeight();
        background_canvas.width = width;
        let background_context = background_canvas.getContext('2d');

        let century_cursor = 0;
        let width_cursor = 0;
        for (let century in witness_centuries) {
            let century_width = witness_centuries[century] * witness_width;

            if (century_cursor % 2 === 0) {
                header_context.beginPath();
                header_context.fillStyle = dark_beige;
                header_context.fillRect(width_cursor, 0, century_width, header_height);

                background_context.beginPath();
                background_context.fillStyle = dark_beige;
                background_context.fillRect(width_cursor, 0, century_width, playtext_col.innerHeight());
            } else {
                header_context.beginPath();
                header_context.fillStyle = light_beige;
                header_context.fillRect(width_cursor, 0, century_width, header_height);

                background_context.beginPath();
                background_context.fillStyle = light_beige;
                background_context.fillRect(width_cursor, 0, century_width, playtext_col.innerHeight());
            }

            header_context.save();
            header_context.fillStyle = font_color;
            header_context.translate(width_cursor + 5, header_height - 5);
            header_context.rotate(-Math.PI / 2);
            header_context.fillText(century, 0, font_size);
            header_context.restore();

            century_cursor += 1;
            width_cursor += century_width;
        }

        playtext_col.css('background-image', `url(${background_canvas.toDataURL()})`);
        playtext_col.css('background-position', `${header_canvas.offset().left + 6}px 0px`);
    }

    function draw_witness_meter(witness_meter, canvas_element, width, height, inactive_color="#9A9A99") {
        canvas_element.src = `${witness_meter_prefix}${witness_meter}/${Math.floor(height)}/${Math.floor(width)}/${inactive_color.replace('#', '')}/`;
    }

    function get_param(param) {
        return (window.location.search.match(new RegExp('[?&]' + param + '=([^&]+)')) || [, null])[1];
    }

    function romanize (num) {
        if (isNaN(num))
            return NaN;
        let digits = String(+num).split(""),
            key = ["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM",
                   "","X","XX","XXX","XL","L","LX","LXX","LXXX","XC",
                   "","I","II","III","IV","V","VI","VII","VIII","IX"],
            roman = "",
            i = 3;
        while (i--)
            roman = (key[+digits.pop() + (i * 10)] || "") + roman;
        return Array(+digits.join("") + 1).join("M") + roman;
    }

    function navigate_to(nav_type, xml_id) {
        show_nav_content(nav_type, xml_id);
    }

    function view_nav_history(forward=false) {
        let valid_history_location = false;
        if (forward && nav_history_cursor + 1 <= nav_history.length - 1) {
            nav_history_cursor += 1;
            valid_history_location = true;
        } else if (nav_history_cursor - 1 >= 0) {
            nav_history_cursor -= 1;
            valid_history_location = true;
        }

        if (valid_history_location) {
            let nav_parts = nav_history[nav_history_cursor].split('|');
            let nav_type = nav_parts[0];
            let xml_id = nav_parts[1];
            show_nav_content(nav_type, xml_id, true);
        }
    }

    function show_nav_content(nav_type, xml_id, historic=false) {
        let history_key = `${nav_type}|${xml_id}`;
        if (!historic && !nav_history.includes(history_key)) {
            nav_history.push(history_key);
            nav_history_cursor = nav_history.length - 1;
        }

        xml_id = xml_id.replace(/#/g, '');
        if (nav_type === 'lb') {
            let start_id = xml_id;
            let end_id = null;
            if (start_id.includes(' ')) {
                let id_parts = start_id.split(' ');
                start_id = id_parts[0];
                end_id = id_parts[1];
            }

            if (start_id in lines) {
                let lines_label = 'Line';
                let line_row = $(lines[start_id].row);
                let lines_html = `<div class="play-words">${line_row.data('text')}<br/>`;

                if (end_id) {
                    lines_label += `s ${line_row.data('line_label')}-`;
                    let collecting = true;
                    while (collecting) {
                        line_row = line_row.next();
                        if (line_row.hasClass('play-row')) {
                            lines_html += `${line_row.data('text')}<br/>`;
                            if (line_row.data('xml_id') === end_id) {
                                collecting = false;
                                lines_label += line_row.data('line_label');
                            }
                        }
                    }
                } else lines_label += ' ' + line_row.data('line_label');

                lines_label += `
                        <i class="fas fa-external-link-square-alt ml-2"
                            style="cursor: pointer;"
                            onClick="javascript: $('#nav-modal').modal('hide'); $('#${start_id}-row')[0].scrollIntoView({behavior: 'smooth'});"
                        ></i>
                `;
                lines_html += "</div>";
                display_nav_modal(lines_label, lines_html);
            }
        } else {
            if (nav_type === 'siglum'){
                xml_id = `s_${xml_id.toLowerCase()}`;
                if (xml_id in witnesses) {
                    let title = 'Collated Edition';
                    if (witnesses[xml_id].bibliographic_entry.includes('<br /><br />')) title += 's';
                    display_nav_modal(title, witnesses[xml_id].bibliographic_entry);
                }
            } else {
                if (!nav_map.hasOwnProperty(nav_type)) nav_type = 'anchor';

                let xml_ids = xml_id.split(' ');
                let search_params = {
                    page: 1,
                    'page-size': xml_ids.length,
                    only: 'id',
                    operator: xml_ids.length > 1 ? 'or' : 'and'
                };
                let content_type = nav_map[nav_type]['content_type'];
                let search_field = nav_map[nav_type]['xml_id_field'];
                search_params[`t_${search_field}`] = xml_ids.join('__');
                corpora.list_content(corpus_id, content_type, search_params, function (search_data) {
                    if (search_data.hasOwnProperty('records') && search_data.records.length === xml_ids.length) {
                        let ids = search_data.records.map(record => record.id);
                        populate_nav_contents(nav_type, ids, [], xml_ids[0]);
                    }
                });
            }
        }
    }

    function populate_nav_contents(nav_type, ids, contents=[], first_xml_id=null) {
        if (ids.length > 0) {
            let content_type = nav_map[nav_type]['content_type'];

            corpora.get_content(corpus_id, content_type, ids[0], function(content_data) {
                contents.push(content_data);
                ids.shift();

                if (ids.length > 0) {
                    populate_nav_contents(nav_type, ids, contents, first_xml_id);
                } else {
                    let nav_title = nav_map[nav_type]['title'];
                    if (contents.length > 1) { nav_title = nav_map[nav_type]['title_plural']; }

                    let nav_content = '';
                    contents.map(content => {
                        if (nav_content === '') nav_content += '<a name="nav-content-start"></a>';
                        else nav_content += '<br><br>';

                        if (nav_type === 'note_cn') {
                            nav_content += `
                                <div class="comm-heading">
                                    ${content.line_label}: ${content.subject_matter}
                                </div>
                            `;
                        } else if (nav_type === 'anchor') {
                            nav_title = `${content.section} | ${content.title}`;
                            nav_title += `
                                <a href="${paratext_prefix}${content.section}/#paratext-${content.id}" target="_blank">
                                    <i class="fas fa-external-link-square-alt ml-2"></i>
                                </a>
                            `;
                        }

                        nav_content += content[nav_map[nav_type]['content_field']];
                    });

                    display_nav_modal(nav_title, nav_content);
                    if (nav_map[nav_type].scroll_anchor) {
                        setTimeout(delayed_scroll.bind(null, first_xml_id), 2000)
                    }
                }
            });
        }
    }

    function display_nav_modal(title, content) {
        let title_html = '';
        if (nav_history_cursor - 1 >= 0) title_html += `<i class="fa fa-chevron-circle-left" aria-hidden="true" onClick="javascript: view_nav_history();" style="cursor: pointer;"></i>`;
        if (nav_history_cursor + 1 <= nav_history.length - 1) title_html += `<i class="fa fa-chevron-circle-right" aria-hidden="true" onClick="javascript: view_nav_history(true);" style="cursor: pointer;"></i>`;
        if (title_html === '') title_html += title;
        else title_html += `<span class="ml-2">${title}</span>`;

        $('#nav-modal-label').html(title_html);
        $('#nav-modal-body').html(content);
        $('#nav-modal').modal();
    }

    function delayed_scroll(anchor, smooth=true) {
        let scroll_opts = {behavior: 'smooth'};
        if (!smooth) scroll_opts = null;

        if ($(`#${anchor}`).length) {
            $(`#${anchor}`)[0].scrollIntoView(scroll_opts);
        }
        else $(`a[name=${anchor}]`)[0].scrollIntoView(scroll_opts);
    }

    function setup_lines() {
        var line_observer = new IntersectionObserver(function(entries) {
            if (entries[entries.length - 1].isIntersecting) {
                let line_id = entries[entries.length - 1].target.id.replace('-row', '');
                let line_no = parseInt(lines[line_id].number);
                if (line_no > last_visible_line) {
                    clearTimeout(comm_timer);
                    last_visible_line = line_no;
                    comm_timer = setTimeout(load_commentary, 1000);
                }
            }
        }, { threshold: [0] });

        $('.play-row').each(function() {
            let row = $(this);
            let xml_id = row.data('xml_id');
            lines[xml_id] = {
                row: row,
                populated: false,
                notes: [],
                label: row.data('line_label'),
                number: row.data('line_number'),
                witness_indicators: row.data('witness_indicators'),
                witness_column: document.getElementById(`${xml_id}-witness-col`),
                witness_meter: document.getElementById(`${xml_id}-witness-meter`),
            };

            draw_witness_meter(
                lines[xml_id].witness_indicators,
                lines[xml_id].witness_meter,
                lines[xml_id].witness_column.clientWidth,
                lines[xml_id].witness_column.clientHeight - 8
            );

            line_observer.observe(this);
        });

        Object.keys(notes).map(note_id => {
            let note = notes[note_id];
            note.lines.map(line => {
                if (lines.hasOwnProperty(line.xml_id)) lines[line.xml_id].notes.push(note_id);
            });
        });

        last_visible_line = 0;
        load_commentary();
    }

    </script>
    </body>
</html>