{% load static %}
{% load extras %}
<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="apple-touch-icon" sizes="180x180" href="/static/img/icon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/static/img/icon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/static/img/icon/favicon-16x16.png">
        <link rel="manifest" href="/static/img/icon/site.webmanifest">
        <link rel="mask-icon" href="/static/img/icon/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">

        <!-- CSS -->
        <link href="{% static 'css/fontawesome.min.css' %}" rel="stylesheet">
        <link href="{% static 'css/regular.min.css' %}" rel="stylesheet">
        <link href="{% static 'css/solid.min.css' %}" rel="stylesheet">
        <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
        <!--<link href="{% static 'css/nvs.css' %}" rel="stylesheet">-->

        <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
        <style title="main-sheet">
            /* -----------------------------
            || MAIN CSS VARIABLES
            || -------------------------- */
            :root {
                {% if site_request %}
                --scrollbarURL: url("/minimap/{{ play.prefix }}/?width=40&height=1000");
                {% else %}
                --scrollbarURL: url("/corpus/{{ corpus_id }}/play-minimap/{{ play.prefix }}/?width=40&height=1000");
                {% endif %}
                --nvs-form-control-height: 35px;
                --nvs-play-row-min-height: 39px;
                --nvs-form-control-font-size: 12px;
                --nvs-background-color: #FFFFFF;
                --nvs-lightest-gray: #F2F2F2;
                --nvs-lighter-gray: #cfcfcf;
                --nvs-mid-gray: #828282;
                --nvs-yellow-gray: #3b371c;
                --nvs-dark-blue: #2a69a1;
                --nvs-light-blue: #6c9ecc;
                --nvs-lightest-blue: rgb(235, 244, 252);
                --nvs-primary-orange: #CC5F38;
                --nvs-secondary-orange: #F1B06E;
                --nvs-burnt-orange: #d87448;
                --nvs-light-orange: #F9EFE4;
                --nvs-dark-yellow: #F0E438;
                --nvs-light-yellow: #f9f1d9;
                --nvs-light-beige: #FBF5F1;
                --nvs-dark-beige: #EBE4DD;
            }

            /* -----------------------------
            || FONTS
            || -------------------------- */
            @font-face {
                font-family: "HalyardTextBook";
                src: url("/static/proprietary/font/HalyardTextBook.woff2") format('woff2'), url("/static/proprietary/font/HalyardTextBook.woff") format('woff');
            }

            @font-face {
                font-family: "HalyardTextSemiBold";
                src: url("/static/proprietary/font/HalyardTextSemBd.woff2") format('woff2'), url("/static/proprietary/font/HalyardTextSemBd.woff") format('woff');
            }

            @font-face {
                font-family: "HalyardTextMedium";
                src: url("/static/proprietary/font/HalyardTextMed.woff2") format('woff2'), url("/static/proprietary/font/HalyardTextMed.woff") format('woff');
            }

            @font-face {
                font-family: "FormulaSerial";
                src: url("{% static 'font/FormulaSerial.woff2' %}") format('woff2'), url("{% static 'font/FormulaSerial.woff' %}") format('woff');
            }

            /* -----------------------------
            || MAIN STRUCTURE
            || -------------------------- */
            body {
                background-color: #FFFFFF;
            }

            canvas {
                display: block;
            }

            /* -----------------------------
            || TEMPORARY HEADER NAV
            || -------------------------- */
            .nav {
                font-family: 'Roboto Condensed', sans-serif;
            }

            .edition-menu {
                min-width: 300px;
            }

            .info-menu, .tools-menu {
                min-width: 220px;
            }

            .info-menu {
                background-color: var(--nvs-lightest-blue);
                border-right: solid 1px var(--nvs-background-color);
            }

            .tools-menu {
                background-color: rgb(242, 242, 242);
            }

            .menu-shadow {
                border: none;
                border-radius: 0;
                padding-top: 0px;
                padding-bottom: 0px;
            }

            .menu-shadow.show {
                box-shadow: rgba(99, 99, 99, 0.3) 4px 8px 8px 0;
            }

            li a {
                padding: 0.5rem 1rem 1.5rem 1rem;
                width: 100%;
                display: block;
                text-decoration: none;
                color: rgb(55, 55, 55);
            }

            li a:hover {
                color: var(--nvs-dark-blue);
            }

            .dropdown-item {
                padding: 0px;
            }

            .dropdown-item:active {
                background-color: inherit;
            }

            .dropdown-item a {
                padding-bottom: 0px;
            }

            #play-title {
                font-family: 'Roboto Condensed', sans-serif;
                color: var(--nvs-dark-blue);
                text-transform: uppercase;
                font-weight: bolder;
                font-size: 25px;
                padding-left: 1rem;
                line-height: 1;
            }

            .search-div {
                border-top: solid 1px var(--nvs-lightest-blue);
                border-left: solid 1px var(--nvs-lightest-blue);
            }


            .heading-label {
                font-family: 'Roboto Condensed', sans-serif;
                color: var(--nvs-mid-gray);
                font-size: 14px;
            }

            .view-col {
                background-color: var(--nvs-background-color);
                border-left: solid 5px var(--nvs-background-color);
                border-right: solid 5px var(--nvs-background-color);
            }

            .nvs-selection {
                position: relative;
            }

            .nvs-selection:after {
                content: '\f0d7';
                font-family: "Font Awesome 5 Free";
                font-weight: 900;
                font-size: 25px;
                color: var(--nvs-lighter-gray);
                right: 10px;
                top: 4px;
                height: 35px;
                position: absolute;
                pointer-events: none;
            }

            select::-ms-expand {
                display: none;
            }

            .nvs-search, .nvs-selection select, input[type=text], input[type=button] {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                /* Add some styling */

                display: block;
                width: 100%;
                height: var(--nvs-form-control-height);
                float: right;
                margin: 2.5px 0px;
                padding: 0px 10px;
                font-size: var(--nvs-form-control-font-size);
                line-height: 1;
                color: #333;
                background-color: #ffffff;
                background-image: none;
                border: 1px solid var(--nvs-lighter-gray);
                -ms-word-break: normal;
                word-break: normal;
            }

            .nvs-selection select {
                font-size: 16px;
            }

            .nvs-search {
                position: relative;
                height: unset;
                min-height: var(--nvs-form-control-height);
                padding: 10px;
                max-height: 150px;
                overflow-x: hidden;
                overflow-y: auto;
            }

            .nvs-search:empty:before{
                content: attr(placeholder);
                color: var(--nvs-mid-gray);
                pointer-events: none;
                display: block;
            }

            .nvs-search:empty:after {
                content: '\f002';
                font-family: "Font Awesome 5 Free";
                font-weight: 900;
                font-size: 18px;
                color: var(--nvs-lighter-gray);
                right: 10px;
                top: 6px;
                height: 35px;
                position: absolute;
                pointer-events: none;
            }

            input[type=button] {
                cursor: pointer;
                background-color: var(--nvs-primary-orange);
                color: var(--nvs-background-color);
            }

            input.nvs-secondary-button {
                background-color: var(--nvs-secondary-orange);
            }

            input[type=checkbox] {
                height: 20px;
                left: 0;
                opacity: 0;
                position: absolute;
                top: 0;
                width: 30px;
            }

            .toggle-control {
                display: block;
                position: relative;
                padding-left: 40px;
                cursor: pointer;
                font-size: 22px;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            .toggle-control input {
                position: absolute;
                opacity: 0;
                cursor: pointer;
                height: 0;
                width: 0;
            }
            .toggle-control input:checked ~ .control {
                background-color: var(--nvs-primary-orange);
            }
            .toggle-control input:checked ~ .control:after {
                left: 22px;
            }
            .toggle-control .control {
                position: absolute;
                top: 0;
                left: 0;
                height: 20px;
                width: 40px;
                border-radius: 10px;
                background-color: var(--nvs-mid-gray);
                -webkit-transition: background-color 0.15s ease-in;
                transition: background-color 0.15s ease-in;
            }
            .toggle-control .control:after {
                content: "";
                position: absolute;
                left: 2px;
                top: 2px;
                width: 16px;
                height: 16px;
                border-radius: 10px;
                background: var(--nvs-background-color);
                -webkit-transition: left 0.15s ease-in;
                transition: left 0.15s ease-in;
            }
            .toggle-control .heading-label {
                position: relative;
                top: -10px;
                left: 10px;
            }
            label.toggle-control {
                margin-bottom: 0px!important;
            }

            /* -----------------------------
            || PLAY READER VIEW
            || -------------------------- */

            .header-block {
                min-height: var(--nvs-play-row-min-height);
            }

            .bg-nvs {
                background-color: var(--nvs-background-color);
            }

            .bg-nvs-light-blue {
                background-color: var(--nvs-light-blue);
            }

            .bg-nvs-light-orange {
                background-color: var(--nvs-light-orange);
            }

            .bg-nvs-light-yellow {
                background-color: var(--nvs-light-yellow);
            }

            .bg-nvs-lightest-gray {
                background-color: var(--nvs-lightest-gray);
            }

            .text-white {
                color: #FFFFFF;
            }

            .vertical {
                font-size: 12px;
                position: relative;
                transform: rotate(-90deg);
                transform-origin: 45% 70%;
                line-height: 1;
            }

            #witness-header {
                height: var(--nvs-form-control-height);
                width: 100%;
            }

            #playtext-col, #playtext-header-col, #act-scene-frame, #commentary-frame {
                overflow-y: scroll;
                overflow-x: hidden;
                max-height: calc(100vh - 80px);
                background-repeat: no-repeat;
            }

            #playtext-col::-webkit-scrollbar, #playtext-header-col::-webkit-scrollbar {
                width: 40px;
            }

            #playtext-col::-webkit-scrollbar-track {
                background-color: var(--nvs-lightest-gray);
                background-image: var(--scrollbarURL);
                background-size: contain;
                background-repeat: no-repeat;
            }

            #playtext-col::-webkit-scrollbar-thumb {
                background-color: rgba(42, 105, 161, .5);
            }

            #playtext-header-col::-webkit-scrollbar-track {
                background-color: var(--nvs-lightest-gray);
            }

            #playtext-col, #playtext-header-col, #act-scene-header-col, #act-scene-frame {
                border-right: solid 1px var(--nvs-lighter-gray);
            }

            #act-scene-frame {
                background-color: var(--nvs-lightest-gray);
                overflow-x: hidden;
            }

            #commentary-frame {
                background-color: var(--nvs-light-yellow);
                padding: 10px;
                padding-top: 0px;
            }

            .play-row {
                border-top: solid 1px var(--nvs-light-blue);
                min-height: var(--nvs-play-row-min-height);
            }

            .play-label {
                background-color: var(--nvs-background-color);
                color: var(--nvs-mid-gray);
                border: none;
                border-left: solid 1px var(--nvs-lighter-gray);
                border-right: solid 1px var(--nvs-lighter-gray);
                font-family: 'Roboto Condensed', sans-serif;
                font-size: 14px;
            }

            .play-words {
                padding-top: 10px;
                padding-bottom: 5px;
                padding-left: 0px;
                font-family: 'Libre Baskerville', serif;
                font-size: clamp(18px, 1.2vw, 24px);
                color: #070707;
                background-color: var(--nvs-background-color);
                -webkit-box-align: center!important;
                -ms-flex-align: center!important;
                align-items: center!important;
                display: -webkit-box!important;
                display: -ms-flexbox!important;
                display: flex!important;
            }

            .play-words.no-variants {
                padding-left: 41px !important;
            }

           /* -----------------------------
           || PLAY TEXT STYLING
           || -------------------------- */

            span.castlist:not(:empty) {
                width: 100%;
            }
            h3.heading {
                font-size: 20px;
                text-transform: uppercase;
                margin-top: 0px;
                margin-bottom: 0px;
                margin-left: auto !important;
                margin-right: auto !important;
                text-align: center;
            }

            span.castgroup {
                margin-left: 10px;
                margin-right: 5px;
            }

            span.role {
                font-weight: bold;
            }

            span.castgroup span.role {
                margin-right: 5px;
            }

            span.roledesc {
                font-style: italic;
                display: inline-block;
            }

            span.stage {
                font-style: italic;
                margin-right: auto !important;
                margin-left: auto !important;
            }

            span.speaker-abbreviation {
                font-style: italic;
                display: inline-block;
                margin-right: 10px;
                margin-left: 10px;
            }

            .witness-meter, .variant-witness-meter {
                -webkit-box-align: center!important;
                -ms-flex-align: center!important;
                align-items: center!important;
                display: -webkit-box!important;
                display: -ms-flexbox!important;
                display: flex!important;
            }

            .clickable {
                cursor: pointer;
            }

            .variant-toggler {
                margin: 0px;
                margin-right: 8px;
            }

            .variant-row {
                border-bottom: solid 1px var(--nvs-light-blue);
            }

            .witness-formula {
                color: #f99b4e;
                background-color: var(--nvs-light-orange);
                font-family: 'Roboto Condensed', sans-serif;
                font-size: 12px;
                text-transform: uppercase;
            }

            .variant-play-label {
                background-color: #f2f2f2;
            }

            .variant-words {
                font-family: 'Libre Baskerville', serif;
                font-size: clamp(18px, 1.2vw, 30px);
                color: #949494;
                padding-left: 41px !important;
                padding-top: 10px;
                padding-bottom: 5px;
            }

            .variant-note {
                color: #070707;
            }

            span.difference {
                color: #e9702b;
                background-color: #FFFFFF;
            }

            comspan {
                background-color: rgba(249, 240, 175, .52);
                border-bottom: solid 1px var(--nvs-dark-yellow);
                cursor: pointer;
            }

            .comm-heading {
                background-color: var(--nvs-dark-yellow);
                font-family: 'Libre Baskerville', serif;
                cursor: pointer;
                color: #000000;
            }

            .comm-block {
                color: #000000;
                font-family: 'HalyardTextBook';
                font-size: clamp(13px,1.2vw,16px);
                margin-bottom: 20px;
                font-variant-numeric: oldstyle-nums;
            }

            .comm-block a {
                color: var(--nvs-dark-blue);
            }

            .actscene-indicator {
                color: var(--nvs-mid-gray);
                font-size: 12px;
                cursor: pointer;
            }

            .actscene-indicator.active {
                font-weight: bold;
                color: var(--nvs-dark-blue);
            }

            .actscene-divider {
                border-top: solid 1px var(--nvs-mid-gray);
                width: 100%;
            }


            /* -----------------------------
            || SEARCH WIDGET
            || -------------------------- */

            #search-widget {
                position: fixed;
                bottom: 0;
                width: 100%;
                z-index: 2000;
                pointer-events: none;
                font-family: "Roboto Condensed", sans-serif;
                text-transform: uppercase;
                font-size: 14px;
            }

            #search-results-div {
                border: 1px solid var(--nvs-mid-gray);
                border-bottom: none;
                box-shadow: 0px 3px 3px 0 rgba(0, 0, 0, 0.4);
            }

            .nav-tabs .nav-link {
                border-radius: 0px !important;
            }

            mark {
                padding: .2em;
                background-color: var(--nvs-light-blue);
                color: white;
            }

            /* -----------------------------
            || NAV MODAL
            || -------------------------- */

            #nav-modal-label {
                font-family: 'Libre Baskerville', serif;
            }

            #nav-modal-body {
                font-family: 'FormulaSerial';
                overflow-y: scroll;
                max-height: calc(80vh);
            }

            .ref-modal {
                position: absolute;
                max-width: calc(33vw);
            }

            .arrow-right, .arrow-left {
                background-color: #FFFFFF;
                position: relative;
                box-sizing: border-box;
                border: 1px solid var(--nvs-mid-gray);
                box-shadow: 0px 3px 3px 0 rgba(0, 0, 0, 0.4);
            }

            .arrow-right {
                float: left;
            }

            .arrow-left {
                float: right;
            }

            .arrow-right:after, .arrow-right:before, .arrow-left:after, .arrow-left:before {
                content: " ";
                width: 0;
                height: 0;
                position: absolute;
                left: -15px;
                top: 10%;
            }

            .arrow-right:after, .arrow-right:before {
                left: 100%;
            }

            .arrow-right:after {
                border-top: 15px solid transparent;
                border-right: none;
                border-left: 15px solid white;
                border-bottom: 15px solid transparent;
            }

            .arrow-right:before {
                border-top: 17px solid transparent;
                border-right: none;
                border-left: 16px solid var(--nvs-mid-gray);
                border-bottom: 16px solid transparent;
                margin-top: -2px;
            }

            .arrow-left:after {
                border-top: 15px solid transparent;
                border-left: none;
                border-right: 15px solid white;
                border-bottom: 15px solid transparent;
            }

            .arrow-left:before {
                border-top: 17px solid transparent;
                border-left: none;
                border-right: 16px solid var(--nvs-mid-gray);
                border-bottom: 16px solid transparent;
                margin-top: -2px;
                margin-left: -1px;
            }

            .ref-modal-header {
                font-family: 'Roboto Condensed', sans-serif;
                color: #000000;
                padding: 10px;
                cursor: move;
            }

            .ref-modal-close {
                cursor: pointer;
            }

            .ref-modal-content {
                padding: 10px;
                font-family: 'FormulaSerial';
                max-height: calc(40vh);
                overflow-y: scroll;
            }

            /* -----------------------------
            || REF LINKS
            || -------------------------- */
            .ref-bibl {
                font-family: "HalyardTextMedium";
                color: var(--nvs-dark-blue);
            }

            .ref-siglum {
                font-family: "HalyardTextSemiBold";
                color: var(--nvs-burnt-orange) !important;
            }

            .ref-lb, .ref-note_cn, .ref-anchor, .ref-p, .ref-text, .ref-item, .ref-quote, .ref-div, .ref-l {
                font-family: "Roboto Condensed", sans-serif;
                font-weight: bold;
                color: var(--nvs-dark-blue);
            }

            .ref-lb:before, .ref-lb:hover:before {
                content: "TLN ";
                font-weight: normal;
                text-decoration: none;
            }

            .ref-anchor, .ref-p, .ref-text, .ref-item, .ref-quote, .ref-div, .ref-l {
                text-transform: uppercase;
            }
        </style>

        <title>{{ play.title }}</title>
    </head>
    <body>
        <!-- Navigation Modal -->
        <div class="modal fade" id="nav-modal" tabindex="-1" role="dialog" aria-labelledby="nav-modal-label" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="nav-modal-label"></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div id="nav-modal-body" class="modal-body">

                    </div>
                    <!--<div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>-->
                </div>
            </div>
        </div>

        <div id="main-container" class="container-fluid h-100">
            <!-- MAIN HEADER -->
            <div id="main-header" class="row">
                <!-- LOGO -->
                <div class="col-sm-2 pt-2">
                    <img src="{% static 'img/nvs-logo.png'%}" class="img-fluid m-0" style="max-height: 90px;">
                </div>

                <!-- NAV -->
                <div class="col-sm-10">
                    <div class="row">
                        <div class="col-sm-12">
                            <ul class="nav">
                                <li class="dropdown menu-shadow">
                                    <a class="dropdown-toggle edition-menu" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false"><b>NVS DIGITAL EDITIONS</b> (BETA)</a>
                                    <ul class="dropdown-menu menu-shadow">
                                        <li class="dropdown-item">
                                            <div class="dropright">
                                                <a class="dropdown-toggle edition-menu" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">THE WINTER'S TALE</a>
                                                <ul class="dropdown-menu menu-shadow">
                                                    <li class="dropdown-item"><a href="{% if site_request %}/edition/wt/{% else %}/corpus/{{ corpus_id }}/play-viewer/wt/{% endif %}">VARIORUM READER</a></li>
                                                    <li class="dropdown-item"><a href="{% if site_request %}/frontmatter/{% else %}/corpus/{{ corpus_id }}/frontmatter/{% endif %}">FRONT MATTER</a></li>
                                                    <li class="dropdown-item"><a href="{% if site_request %}/bibliography/{% else %}/corpus/{{ corpus_id }}/bibliography/{% endif %}">BIBLIOGRAPHY</a></li>
                                                    <li class="dropdown-item"><a href="{% if site_request %}/appendix/{% else %}/corpus/{{ corpus_id }}/appendix/{% endif %}">APPENDIX</a></li>
                                                </ul>
                                            </div>
                                        </li>
                                        <li class="dropdown-item">
                                            <div class="dropright">
                                                <a class="dropdown-toggle edition-menu" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">A MIDSUMMER NIGHT'S DREAM</a>
                                                <ul class="dropdown-menu menu-shadow">
                                                    <li class="dropdown-item"><a href="{% if site_request %}/edition/mnd/{% else %}/corpus/{{ corpus_id }}/play-viewer/mnd/{% endif %}">VARIORUM READER</a></li>
                                                    <li class="dropdown-item"><a href="{% if site_request %}/frontmatter/{% else %}/corpus/{{ corpus_id }}/frontmatter/{% endif %}">FRONT MATTER</a></li>
                                                    <li class="dropdown-item"><a href="{% if site_request %}/bibliography/{% else %}/corpus/{{ corpus_id }}/bibliography/{% endif %}">BIBLIOGRAPHY</a></li>
                                                    <li class="dropdown-item"><a href="{% if site_request %}/appendix/{% else %}/corpus/{{ corpus_id }}/appendix/{% endif %}">APPENDIX</a></li>
                                                </ul>
                                            </div>
                                        </li>
                                    </ul>
                                </li>
                                <li class="dropdown menu-shadow ml-auto">
                                    <a class="dropdown-toggle info-menu" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false"><b>NVS INFO</b></a>
                                    <ul class="dropdown-menu info-menu menu-shadow">
                                        <li class="dropdown-item"><a href="{% if site_request %}/about/{% else %}/corpus/{{ corpus_id }}/about/{% endif %}">ABOUT</a></li>
                                        <li class="dropdown-item"><a href="{% if site_request %}/how-to/{% else %}/corpus/{{ corpus_id }}/how-to/{% endif %}">HOW TO DIGITAL NVS</a></li>
                                        <li class="dropdown-item"><a href="{% if site_request %}/faqs/{% else %}/corpus/{{ corpus_id }}/faqs/{% endif %}">FAQS & LEXICON</a></li>
                                        <li class="dropdown-item"><a href="{% if site_request %}/contributors/{% else %}/corpus/{{ corpus_id }}/contributors/{% endif %}">CONTRIBUTORS</a></li>
                                        <li class="dropdown-item"><a href="{% if site_request %}/print-editions/{% else %}/corpus/{{ corpus_id }}/print/{% endif %}">PRINT EDITIONS</a></li>
                                    </ul>
                                </li>
                                <li class="dropdown menu-shadow">
                                    <a class="dropdown-toggle tools-menu" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false"><b>NVS TOOLS</b></a>
                                    <ul class="dropdown-menu tools-menu menu-shadow">
                                        <li class="dropdown-item"><a href="{% if site_request %}/tools/{% else %}/corpus/{{ corpus_id }}/tools/{% endif %}">ABOUT</a></li>
                                        <li class="dropdown-item"><a href="{% if site_request %}/advanced-search/{% else %}/corpus/{{ corpus_id }}/search/{% endif %}">ADVANCED SEARCH</a></li>
                                        <li class="dropdown-item"><a href="{% if site_request %}/data/{% else %}/corpus/{{ corpus_id }}/data/{% endif %}">DATA</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="row no-gutters">
                        <div class="col-sm-3">
                            <div id="play-title" class="align-self-baseline">
                                {{ play.title }}
                            </div>
                        </div>
                        <div class="col-sm-9 search-div">
                            <div class="row">
                                <div class="col-sm-6 offset-6">
                                    <div id="hdr-quick-search-box" class="nvs-search" placeholder="SEARCH THIS PLAY" contentEditable="plaintext-only"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- READER VIEW -->
            {% if nvs_session.preferences.show_reader_view %}
            <div id="reader-view" class="row flex-grow-1">
                <div id="main-col" class="col-md-12 col-lg-12 p-1 view-col">

                    <!-- header row -->
                    <div class="row">
                        <div class="col-sm-8 pr-0 bg-nvs-light-blue">
                            <div class="row no-gutters header-block align-items-end">
                                <div class="col-sm-4">
                                    <div class="heading-label text-white">
                                        TEXTUAL VARIANTS BY YEAR
                                    </div>
                                </div>
                                <div class="col-sm-7 m-0 p-0">
                                    <div class="heading-label text-white">
                                        PLAY TEXT
                                    </div>
                                </div>
                                <div class="col-sm-1 m-0 p-0">
                                    <input id="hdr-line-no-box" type="text" placeholder="ENTER LINE#" />
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="row header-block bg-nvs-light-blue align-items-end">
                                <div class="col-sm-1 m-0 p-0">
                                    &nbsp;
                                </div>
                                <div class="col-sm-11 m-0 p-0">
                                    <div class="heading-label text-white">
                                        COMMENTARY NOTES BY LINE
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div id="playtext-header-col" class="col-sm-8 pr-0 bg-nvs-light-orange">
                            <div class="row no-gutters header-block">
                                <div id="witness-header" class="col-sm-4 m-0 p-0">
                                    &nbsp;
                                </div>
                                <div class="col-sm-7 bg-nvs">
                                    <div class="heading-label mt-1 ml-2">
                                        SHOW VARS BY LINE | HIGHLIGHT
                                    </div>
                                </div>
                                <div class="col-sm-1 bg-nvs">
                                    <div class="row no-gutters h-100">
                                        <div class="col-sm-8 offset-4 play-label">
                                            <div class="heading-label vertical d-flex h-100 justify-content-center align-items-end">
                                                TLN
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="row header-block">
                                <div id="act-scene-header-col" class="col-sm-1 bg-nvs-lightest-gray">
                                    <div class="heading-label vertical d-flex h-100 align-items-end">
                                        ACT<br>SCN
                                    </div>
                                </div>
                                <div class="col-sm-11 bg-nvs-light-yellow">
                                    &nbsp;
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- PLAYTEXT -->
                        <div id="playtext-col" class="col-sm-8 pr-0">
                            {% for line in lines %}
                                <div id="{{ line.xml_id }}-row"
                                     class="row no-gutters play-row offscreen"
                                     data-xml_id="{{ line.xml_id }}"
                                     data-act="{{ line.act }}"
                                     data-scene="{{ line.scene }}"
                                     data-line_number="{{ line.line_number }}"
                                     data-line_label="{{ line.line_label }}"
                                     data-text="{{ line.text }}"
                                     data-text-length="{{ line.text|length }}"
                                     data-witness_indicators="{{ line.witness_meter }}"
                                >
                                    <div id="{{ line.xml_id }}-witness-col" class="col-sm-4 m-0 p-0 witness-meter {% if line.witness_meter|to_int > 0 %}clickable{% endif %}">
                                        <img id="{{ line.xml_id }}-witness-meter" height="30" width="100%" src="{% static 'img/blank-meter.png'%}" />
                                    </div>
                                    <div id="{{ line.xml_id }}-text-col" class="col-sm-7 m-0 p-0 play-words {% if line.witness_meter|to_int == 0 %}no-variants{% endif %}">
                                        {% if line.witness_meter|to_int > 0 %}
                                            <a id="{{ line.xml_id }}-variant-toggler"
                                                   class="variant-toggler"
                                                   data-toggle="collapse"
                                                   href="#{{ line.xml_id }}-variant-div"
                                                   role="button"
                                                   aria-expanded="false"
                                                   aria-controls="{{ line.xml_id }}-variant-div"
                                                >
                                                <img id="{{ line.xml_id }}-variant-toggle" src="{% static 'img/nvs-variants-expand.png' %}" />
                                            </a>
                                        {% endif %}
                                        {{ line.rendered_html|safe }}
                                    </div>
                                    <div id="{{ line.xml_id }}-number-col" class="col-sm-1 m-0 p-0">
                                        <div class="row no-gutters h-100 bg-nvs">
                                            <div class="col-sm-8 offset-4 play-label d-flex justify-content-center align-items-center">
                                                {{ line.line_label }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% if line.witness_meter|to_int > 0 %}
                                    <div class="collapse" class="variant-drawer" id="{{ line.xml_id }}-variant-div"></div>
                                {% endif %}
                            {% endfor %}

                        </div>

                        <!-- COMMENTARY -->
                        <div id="act-scene-commentary-col" class="col-sm-4">
                            <div class="row">
                                <div class="col-sm-1 p-0 m-0">
                                    <div id="act-scene-frame" class="d-flex flex-column h-100 align-self-center p-0 m-0">
                                        {% for label, actscene in act_scenes.items %}
                                            <div class="actscene-indicator{% if forloop.first %} active{% endif %} my-auto mx-0 px-0 align-self-center" data-actscene="{{ actscene }}">
                                                {{ label }}
                                            </div>

                                            {% if not forloop.last %}
                                                <hr class="actscene-divider" />
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-sm-11 p-0 m-0">
                                    <div id="commentary-frame"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            {% endif %}

            <!-- LIST VIEW -->
            {% if nvs_session.preferences.show_list_view %}
            <div id="quantitative-view" class="row no-gutters">
            </div>
            {% endif %}
        </div>
        <div id="search-widget" class="d-none container-fluid">
            <div class="row">
                <div class="col-sm-4 offset-sm-4">
                    <div id="search-results-div" class="align-items-center bg-nvs-lightest-gray" style="pointer-events: auto;">
                        <ul id="search-widget-tabs" class="nav nav-tabs nav-fill" role="tablist">
                            <li class="nav-item" role="presentation">
                                <a class="nav-link active" id="search-widget-line-tab" data-toggle="tab" href="#search-widget-lines" role="tab" aria-controls="search-widget-lines" aria-selected="true">Lines (<span class="search-line-total">0</span>)</a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <a class="nav-link" id="search-widget-variant-tab" data-toggle="tab" href="#search-widget-variants" role="tab" aria-controls="explore" aria-selected="false">Variants (<span class="search-variant-total">0</span>)</a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <a class="nav-link" id="search-widget-commentary-tab" data-toggle="tab" href="#search-widget-commentary" role="tab" aria-controls="search-widget-commentary" aria-selected="false">Commentary (<span class="search-commentary-total">0</span>)</a>
                            </li>
                            <li class="nav-item w-auto justify-content-end" role="presentation">
                                <a class="nav-link" href="javascript: clear_search();">X</a>
                            </li>
                        </ul>
                        <div class="tab-content p-3 bg-nvs">
                            <div class="tab-pane fade show active" id="search-widget-lines" role="tabpanel" aria-labelledby="search-widget-line-tab">
                                <a id="search-line-prev" onClick="display_search_result('line', 'prev');"><i class="fas fa-chevron-left"></i></a>
                                <span id="search-line-current">0</span> out of
                                <span class="search-line-total">0</span>
                                <a id="search-line-next" onClick="display_search_result('line', 'next');"><i class="fas fa-chevron-right"></i></a>
                            </div>
                            <div class="tab-pane fade" id="search-widget-variants" role="tabpanel" aria-labelledby="search-widget-variant-tab">
                                <a id="search-variant-prev" onClick="display_search_result('variant', 'prev');"><i class="fas fa-chevron-left"></i></a>
                                <span id="search-variant-current">0</span> out of
                                <span class="search-variant-total">0</span>
                                <a id="search-variant-next" onClick="display_search_result('variant', 'next');"><i class="fas fa-chevron-right"></i></a>
                            </div>
                            <div class="tab-pane fade" id="search-widget-commentary" role="tabpanel" aria-labelledby="search-widget-commentary-tab">
                                <a id="search-commentary-prev" onClick="display_search_result('commentary', 'prev');"><i class="fas fa-chevron-left"></i></a>
                                <span id="search-commentary-current">0</span> out of
                                <span class="search-commentary-total">0</span>
                                <a id="search-commentary-next" onClick="display_search_result('commentary', 'next');"><i class="fas fa-chevron-right"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="{% static 'js/jquery-3.3.1.min.js' %}"></script>
        <script src="{% static 'js/popper.min.js' %}"></script>
        <script src="{% static 'js/bootstrap.min.js' %}"></script>
        <script src="{% static 'js/jquery.mark.min.js' %}"></script>
        <script src="{% static 'js/corpora.js' %}"></script>
        <script type="application/javascript">
    let corpora;
    let corpus_id = "{{ corpus_id }}";
    let play_prefix = "{{ play.prefix }}";
    let play_id = "{{ play.id }}";

    let playviewer_url = {% if site_request %}`/play/${play_prefix}/`{% else %}`/corpus/${corpus_id}/play-viewer/${play_prefix}/`{% endif %};
    let search_endpoint = {% if site_request %}`${window.location.protocol}//${window.location.host}/search/${play_prefix}/`{% else %}`/api/corpus/${corpus_id}/nvs-search/${play_prefix}/`{% endif %};
    let witness_meter_prefix = {% if site_request %}`/witnessmeter/`{% else %}`/nvs/witness-meter/`{% endif %};
    let paratext_prefix = {% if site_request %}`/paratext/${play_prefix}/`{% else %}`/corpus/${corpus_id}/paratext-viewer/${play_prefix}/`{% endif %};
    let minimap_url = {% if site_request %}`/minimap/${play_prefix}/`{% else %}`/corpus/${corpus_id}/play-minimap/${play_prefix}/`{% endif %};

    let style_sheet = null;
    let current_act_scene = "{{ nvs_session.filter.act_scene }}";
    let current_character = "{{ nvs_session.filter.character }}";
    let corpus;
    let screen_size = 'large';
    let meter_height = () => Math.round(window.innerHeight / (100 / 3)) + 'px';
    let last_century_buffer = 0;

    let witnesses = {{ witnesses|safe }};
    let witness_centuries = {{ witness_centuries|safe }};
    let witness_count = {{ witness_count }};
    let notes = {{ notes|safe }};
    let line_note_map = {{ line_note_map|safe }};
    let act_scenes = {{ act_scenes|safe }};

    let characters = null;
    let lines = {};
    let line_observer = null;
    let commentary_observer = null;
    let last_visible_line = -1;
    let last_commentary_line = 0;
    let remaining_commentaries = true;
    let commentaries = {};
    let commentary_loaded = false, characters_loaded = false;
    let comm_timer = null;
    let nvs_search = null;
    let ref_modal_counter = 0;

    let nav_map = {
        'lb': {
            'content_type': 'PlayLine',
            'xml_id_field': 'xml_id',
            'content_field': 'rendered_html',
            'title': 'LINE',
            'title_plural': 'LINES',
            'scroll_anchor': false,
            'filter_play': true,
        },
        'bibl': {
            'content_type': 'Document',
            'xml_id_field': 'siglum',
            'content_field': 'bibliographic_entry',
            'title': "BIBLIOGRAPHY",
            'title_plural': "BIBLIOGRAPHY",
            'scroll_anchor': false,
            'filter_play': false,
        },
        'siglum': {
            'content_type': 'Document',
            'xml_id_field': 'siglum',
            'content_field': 'bibliographic_entry',
            'title': "COLLATED EDITION",
            'title_plural': "COLLATED EDITIONS",
            'scroll_anchor': false,
            'filter_play': false,
        },
        'note_cn': {
            'content_type': 'Commentary',
            'xml_id_field': 'xml_id',
            'content_field': 'contents',
            'title': "COMMENTARY",
            'title_plural': "COMMENTARY",
            'scroll_anchor': false,
            'filter_play': true,
        },
        'anchor': {
            'content_type': 'ParaText',
            'xml_id_field': 'child_xml_ids',
            'content_field': 'html_content',
            'title': "APPENDIX",
            'title_plural': "APPENDIX",
            'scroll_anchor': true,
            'filter_play': true,
        }
    };
    let nav_history = [];
    let nav_history_cursor = 0;

    $(document).ready(function() {
        corpora = new Corpora({'csrf_token': "{{ csrf_token }}"{% if site_request %}, 'host': '{{ corpora_url }}'{% endif %}});
        screen_size = determine_screen_size(window.innerWidth);
        style_sheet = document.styleSheets[0];
        $(":root").css("--scrollbarURL", `url(${minimap_url}?width=40&height=${parseInt($("#playtext-col").height())})`);
        draw_witness_header_and_background();

        // GET CHARACTER NAMES; POSSIBLY FILTERED BY ACT/SCENE
        let speech_params = {
            'page-size': 0,
            'a_terms_characters': 'speaking.xml_id,speaking.name',
        };
        if (current_act_scene !== 'all') {
            if (current_act_scene.includes('.')) {
                let [current_act, current_scene] = current_act_scene.split('.');
                speech_params['f_act'] = current_act;
                speech_params['f_scene'] = current_scene;
            } else {
                speech_params['f_act'] = current_act_scene;
            }
        }
        corpora.list_content(
            corpus_id,
            'Speech',
            speech_params,
            function(char_data) {
                if (char_data.hasOwnProperty('meta') && char_data.meta.hasOwnProperty('aggregations') && char_data.meta.aggregations.hasOwnProperty('characters')) {
                    let char_selector = $('#hdr-character-selector');
                    Object.keys(char_data.meta.aggregations.characters).map(char_id_name => {
                        let [char_xml_id, char_name] = char_id_name.split('|||');
                        let selected = current_character === char_xml_id ? ' selected' : '';
                        char_selector.append(`
                            <option value="${char_xml_id}"${selected}>${char_name}</option>
                        `);
                    });
                }
                characters_loaded = true;
            }
        );

        setup_lines();
        configure_controls();

        $('.witness-meter').click(function(){
            let line_id = this.id.replace('-witness-col', '');
            let witness_indicators = $(`#${line_id}-row`).data('witness_indicators');
            display_variant_editions(witness_indicators, this);
        });

        $('comspan').mouseover(function(ev) {
            let selector = `comspan.${ev.target.className}`;
            style_sheet.insertRule(`
                ${selector} {
                    border: solid 1px var(--nvs-primary-orange);
                }
            `);

            setTimeout(delete_css_rule.bind(null, selector), 3000);
        });

        $('comspan').mouseleave(function(ev) {
            let selector = `comspan.${ev.target.className}`;
            delete_css_rule(selector);
        });

        let nav_type = get_param('nav_type');
        let nav_xml_id = get_param('nav_xml_id');
        if (nav_type && nav_xml_id) {
            navigate_to(nav_type, nav_xml_id);
        }

        //setTimeout(wait_for_load, 1000);

    });

    function delete_css_rule(selector) {
        let rule_deletion_index = -1;
        for (let rule_index = 0; rule_index < style_sheet.cssRules.length; rule_index++) {
            if (style_sheet.cssRules[rule_index].selectorText === selector) {
                rule_deletion_index = rule_index;
                break;
            }
        }

        if (rule_deletion_index > -1) {
            style_sheet.deleteRule(rule_deletion_index);
        }
    }

    function configure_controls() {
        // HEADER: NESTED DROPDOWN
        $('.dropdown-menu a.dropdown-toggle').on('click', function(e) {
            if (!$(this).next().hasClass('show')) {
                $(this).parents('.dropdown-menu').first().find('.show').removeClass("show");
            }
            let subMenu = $(this).next(".dropdown-menu");
            subMenu.toggleClass('show');
            let parentMenu = $(this).parents('.dropdown-menu').first()[0];
            subMenu.css('position', 'absolute');
            subMenu.css('top', `${this.offsetTop}px`);
            subMenu.css('left', `${this.offsetLeft + this.offsetWidth}px`);

            $(this).parents('li.nav-item.dropdown.show').on('hidden.bs.dropdown', function(e) {
                $('.dropdown-submenu .show').removeClass("show");
            });

            return false;
        });

        // HEADER: LINE# BOX
        $('#hdr-line-no-box').keypress(function(e) {
            if (e.which === 13) {
                let line_no = $('#hdr-line-no-box').val();
                if (`tln_${line_no}` in lines) {
                    $(`#tln_${line_no}-row`)[0].scrollIntoView({behavior: 'smooth'});
                } else {
                    while (line_no.length < 4) {
                        line_no = '0' + line_no;
                    }
                    if (`tln_${line_no}` in lines) {
                        $(`#tln_${line_no}-row`)[0].scrollIntoView({behavior: 'smooth'});
                    }
                }
            }
        });

        // HEADER: QUICK SEARCH BOX
        $('#hdr-quick-search-box').keypress(function(e) {
            if (e.which === 13) {
                let qs_box = $('#hdr-quick-search-box');
                let query = qs_box.text().trim();
                qs_box.empty();
                qs_box.html(query);
                corpora.make_request(
                    search_endpoint,
                    'POST',
                    {
                        quick_search: query
                    },
                    process_search_results
                );
                return false;
            }
        });

        // HEADER: ACT, SCENE BOX
        $('#hdr-act-scene-selector').change(function() {
            let selection = $('#hdr-act-scene-selector').val();
            window.location = `${playviewer_url}?act-scene=${selection}`;
        });

        // HEADER: CHARACTER BOX
        $('#hdr-character-selector').change(function() {
            let selection = $('#hdr-character-selector').val();
            window.location = `${playviewer_url}?character=${selection}`;
        });

        // HEADER: RESET BUTTON
        $('#hdr-reset-button').click(function() {
            window.location = `?reset=true`;
        });

        // COMMENTARY HIGHLIHT CLICK
        $('comspan').click(function(e) {
            let comm_id = this.className.replace('commentary-lemma-', '');
            comm_id = `commentary-note-${comm_id}`;
            setTimeout(delayed_scroll.bind(null, comm_id, false), 300);
            e.stopPropagation();
        });

        // VARIANT TOGGLER CLICK
        $('.variant-toggler').click(function() {
            let line_xml_id = this.id.replace('-variant-toggler', '');
            if (!lines[line_xml_id].populated) {
                show_notes(line_xml_id);
            }
            $('.variant-siglum').off('mouseenter').on('mouseenter', function() {
                let link = $(this);
                let siglum = `s_${link.html().toLowerCase()}`;

                let parent_div = link.parent();
                let line_id = parent_div.data('line-id');
                let variant_id = parent_div.data('variant-id');
                let wit_meter = $(`#${line_id}-${variant_id}-witness-meter`);
                let wit_indicators = wit_meter.data('witness_indicators');

                if (siglum in witnesses) {
                    witnesses[siglum].slots.map(slot => {
                        wit_indicators = wit_indicators.substr(0, slot) + 'x' + wit_indicators.substr(slot + 1);
                    });
                } else {
                    wit_indicators = wit_indicators.slice(0, -1) + 'x';
                }

                let url_parts = wit_meter.attr('src').split('/');
                url_parts[url_parts.length - 6] = wit_indicators;
                wit_meter.attr('src', url_parts.join('/'));
            });

            $('.variant-witness-meter').off('click').on('click', function() {
                let witness_indicators = $(this).find('img').data('witness_indicators');
                display_variant_editions(witness_indicators, this);
            });
        });

        // SETUP CHARACTERS
        let act_scene_selector = $('#hdr-act-scene-selector');
        Object.keys(act_scenes).map(act_scene_label => {
            let selected = '';
            if (act_scenes[act_scene_label] === current_act_scene) {
                selected = ' selected'
            }

            act_scene_selector.append(`
                <option value="${act_scenes[act_scene_label]}"${selected}>${act_scene_label}</option>
            `);
        });

        // SEARCH TABS
        $('#search-widget-line-tab').click(function() {
            if (nvs_search && nvs_search.hasOwnProperty('current_line_result')) {
                if (nvs_search.current_line_result === 0 || nvs_search.line_results.length === 1) {
                    nvs_search.current_line_result = 0;
                    display_search_result('line', 'next');
                }
            }
        });
        $('#search-widget-variant-tab').click(function() {
            if (nvs_search && nvs_search.hasOwnProperty('current_variant_result')) {
                if (nvs_search.current_variant_result === 0 || nvs_search.variant_results.length === 1) {
                    nvs_search.current_variant_result = 0;
                    display_search_result('variant', 'next');
                }
            }
        });
        $('#search-widget-commentary-tab').click(function() {
            if (nvs_search && nvs_search.hasOwnProperty('current_commentary_result')) {
                if (nvs_search.current_commentary_result === 0 || nvs_search.commentary_results.length === 1) {
                    nvs_search.current_commentary_result = 0;
                    display_search_result('commentary', 'next');
                }
            }
        });

        // ACT/SCENE INDICATORS
        $('.actscene-indicator').click(function() {
            let actscene = $(this).data('actscene').toString();
            console.log(actscene);
            let actscene_parts = actscene.split('.');
            let act = actscene_parts[0];
            let scene = actscene_parts[1];

            $(`.play-row[data-act="${act}"][data-scene="${scene}"]:first`)[0].scrollIntoView({behavior: 'smooth'});
        });
    }

    function get_nvs_var(variable_name) {
        return getComputedStyle(document.documentElement).getPropertyValue(`--${variable_name}`);
    }

    function determine_screen_size(width) {
        if (width < 768) { return 'small'; }
        else if (width < 992) { return 'medium'; }
        return 'large';
    }

    function show_notes(line_id) {
        let line_variant_div = $(`#${line_id}-variant-div`);
        let line_witness_meter = $(`#${line_id}-witness-meter`);

        line_variant_div.removeClass('hidden');
        line_witness_meter.removeClass('hidden');

        // make note/variant elements
        lines[line_id].notes.map(note_id => {
            if(!notes[note_id].populated) {
                notes[note_id].line_range = '';
                if (notes[note_id].lines.length > 1) {
                    let start_id = notes[note_id].lines[0].xml_id;
                    let end_id = notes[note_id].lines[notes[note_id].lines.length - 1].xml_id;
                    notes[note_id].line_range = `<span class='text-muted'>${lines[start_id].label}-${lines[end_id].label}: </span>`;
                }

                notes[note_id].variants.map(variant => {
                    let variant_words = variant.variant;
                    if (!variant_words) {
                        if (variant.description === null) {
                            variant_words = `Error with variant transform: <a href='${notes[note_id].uri}/' target='_blank'>Note</a> <a href='${variant.uri}/' target='_blank'>Variant</a>`;
                        } else {
                            variant_words = `<span class="variant-note">${variant.description}</span>`;
                        }
                    }
                    variant_words = notes[note_id].line_range + variant_words;

                    notes[note_id].lines.map(line => {
                        if (line.xml_id in lines) {
                            $(`#${line.xml_id}-variant-div`).append(`
                                <div class="row no-gutters variant-row">
                                    <div class="col-sm-4 p-0 m-0">
                                        <div class="row no-gutters">
                                            <div id="variant-${variant.id}" class="col-sm-12 p-0 m-0 variant-witness-meter clickable">
                                                <img id="${line.xml_id}-${variant.id}-witness-meter" height="15" width="100%" src="{% static 'img/blank-meter.png'%}" data-witness_indicators="${variant.witness_meter}" />
                                            </div>
                                        </div>
                                        <div class="row no-gutters">
                                            <div class="col-sm-12 witness-formula" data-line-id="${line.xml_id}" data-variant-id="${variant.id}">
                                                ${variant.witness_formula}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-8 p-0 m-0 variant-words align-self-center">${variant_words}</div>
                                </div>
                            `);

                            $(`#${line.xml_id}-variant-div`).on('shown.bs.collapse', function (event) {
                                let indicator = $(`#${event.target.id.replace('-div', '-toggle')}`);
                                indicator.attr('src', "{% static 'img/nvs-variants-collapse.png' %}")
                            });

                            $(`#${line.xml_id}-variant-div`).on('hidden.bs.collapse', function (event) {
                                let indicator = $(`#${event.target.id.replace('-div', '-toggle')}`);
                                indicator.attr('src', "{% static 'img/nvs-variants-expand.png' %}")
                            });

                            let variant_col = $(`#${line.xml_id}-witness-col`);
                            draw_witness_meter(
                                variant.witness_meter,
                                document.getElementById(`${line.xml_id}-${variant.id}-witness-meter`),
                                variant_col.outerWidth(),
                                25,
                                "#FFFFFF"
                            );
                        }
                    });
                });
                notes[note_id].populated = true;
            }
        });

        lines[line_id].populated = true;
    }

    function display_variant_editions(witness_indicators, link) {
        let wit_sigla = Object.keys(witnesses);
        let sigla = [];
        for (let slot = 0; slot < witness_indicators.length; slot++) {
            let indicator = witness_indicators.charAt(slot);
            if (indicator !== '0') {
                for (let sig_index = 0; sig_index < wit_sigla.length; sig_index++) {
                    if (witnesses[wit_sigla[sig_index]].slots.includes(slot) && !sigla.includes(wit_sigla[sig_index])) {
                        sigla.push(wit_sigla[sig_index]);
                        break;
                    }
                }
            }
        }

        let title = "Collated Editions for Variant";
        let content = "";
        sigla.map(siglum => {
            content += `<p><b>${siglum.replace('s_', '').toUpperCase()}</b> ${witnesses[siglum].bibliographic_entry}</p>`;
        });
        display_nav_modal(title, content, link);
    }

    function process_search_results(results) {
        if (results.last_commentary_line > last_commentary_line) {
            last_visible_line = results.last_commentary_line;
            commentary_loaded = false;
            load_commentary();
        }

        if (!commentary_loaded){
            setTimeout(process_search_results.bind(null, results), 1000)
        } else {
            $(":root").css("--scrollbarURL", `url(${minimap_url}?width=40&height=${parseInt($("#playtext-col").height())}&no-cache=${Math.floor(Date.now() / 1000)})`);
            if (nvs_search) {
                $('#reader-view').unmark();
            }

            nvs_search = {
                character_results: results.characters,
                line_results: results.lines,
                variant_results: results.variants,
                commentary_results: results.commentaries,
                current_line_result: 0,
                current_variant_result: 0,
                current_commentary_result: 0
            };

            $('.search-line-current').html('0');
            $('.search-variant-current').html('0');
            $('.search-commentary-current').html('0');
            $('.search-line-total').html(nvs_search.line_results.length);
            $('.search-variant-total').html(nvs_search.variant_results.length);
            $('.search-commentary-total').html(nvs_search.commentary_results.length);
            $('#search-line-prev').removeClass('d-none');
            $('#search-line-next').removeClass('d-none');
            $('#search-variant-prev').removeClass('d-none');
            $('#search-variant-next').removeClass('d-none');
            $('#search-commentary-prev').removeClass('d-none');
            $('#search-commentary-next').removeClass('d-none');
            $('#search-widget').removeClass('d-none');

            nvs_search.line_results.map(result => {
                let html_span = $(`#${result.xml_id}-text-col`);
                result.matches.map(match => html_span.mark(match));
            });

            nvs_search.variant_results.map(result => {
                show_notes(result.xml_id);
                $(`#${result.xml_id}-variant-div`).collapse('show');
                let html_span = $(`#${result.xml_id}-variant-div .variant-words`);
                result.matches.map(match => html_span.mark(match));
            });

            nvs_search.commentary_results.map((result, result_num) => {
                let comm_header = $(`#commentary-note-${result.comm_id}`);
                let comm_content = $(`#commentary-content-${result.comm_id}`);
                result.matches.map(match => {
                    comm_header.mark(match, {className: `search-commentary-result-${result_num}`});
                    comm_content.mark(match, {className: `search-commentary-result-${result_num}`});
                });
            });

            if (nvs_search.line_results.length) display_search_result('line', 'next');
            else if (nvs_search.variant_results.length) display_search_result('variant', 'next');
            else if (nvs_search.commentary_results.length) display_search_result('commentary', 'next');
            else display_nav_modal('No results.', 'No results for your search term were found.', null);
        }
    }

    function display_search_result(type, which) {
        $(`#search-widget-${type}-tab`).tab('show');

        if (which === 'next') {
            nvs_search[`current_${type}_result`] += 1;
        } else {
            nvs_search[`current_${type}_result`] -= 1;
        }

        if (type === 'commentary') {
            let comm_result_num = nvs_search.current_commentary_result - 1;
            document.getElementsByClassName(`search-commentary-result-${comm_result_num}`)[0].scrollIntoView({behavior: 'smooth'});
        }
        else {
            let result = nvs_search[`${type}_results`][nvs_search[`current_${type}_result`] - 1];
            let id_suffix = '-text-col';
            if (type === 'variant') id_suffix = '-variant-div';
            document.getElementById(`${result.xml_id}${id_suffix}`).scrollIntoView({behavior: 'smooth'});
        }

        $(`#search-${type}-current`).html(nvs_search[`current_${type}_result`]);
        if (nvs_search[`current_${type}_result`] === 1) {
            $(`#search-${type}-prev`).addClass('d-none');
        } else {
            $(`#search-${type}-prev`).removeClass('d-none');
        }

        if (nvs_search[`current_${type}_result`] === nvs_search[`${type}_results`].length) {
            $(`#search-${type}-next`).addClass('d-none');
        } else {
            $(`#search-${type}-next`).removeClass('d-none');
        }
    }

    function clear_search() {
        $('#reader-view').unmark();
        $('#search-widget').addClass('d-none');
    }

    function load_commentary() {
        if (commentary_observer === null) {
            commentary_observer = new IntersectionObserver(function(entries) {
                if (entries[0].isIntersecting) {
                    $(entries[0].target).remove();
                    if (remaining_commentaries) {
                        console.log('loading more commentary...');
                        last_visible_line += 20;
                        load_commentary();
                    }
                }
            }, { threshold: [0] });
        }

        let comm_frame = $('#commentary-frame');
        let comm_search = {
            'f_play.id': play_id,
            'r_lines.line_number': `${last_commentary_line}__${last_visible_line + 20}`,
            's_id': 'asc',
            'page-size': 500
        };

        corpora.list_content(
            corpus_id,
            'Commentary',
            comm_search,
            function(comm_data) {
                if (comm_data.records.length) {
                    comm_data.records.map(comm => {
                        if (!commentaries.hasOwnProperty(comm.id)) {
                            comm_frame.append(`
                                <div class="row">
                                    <div id="commentary-note-${comm.id}" class="col-sm-12 comm-heading" onClick="document.getElementById('${comm.lines[0].xml_id}-row').scrollIntoView();">
                                        <a name="commentary-note-${comm.id}"></a>
                                        n. ${comm.line_label}: ${comm.subject_matter}
                                    </div>
                                </div>
                                <div class="row">
                                    <div id="commentary-content-${comm.id}" class="col-sm-12 comm-block">
                                        ${comm.contents}
                                    </div>
                                </div>
                            `);
                            commentaries[comm.id] = true;
                        }
                    });
                    let comm_spinner = $('#commentary-spinner');
                    if (comm_spinner.length) comm_spinner.remove();
                    comm_frame.append(`
                        <div id="commentary-spinner" class="row">
                            <div class="col-sm-12">
                                <i class="fas fa-spinner"></i>
                            </div>
                        </div>
                    `);
                    commentary_observer.observe($('#commentary-spinner')[0]);
                } else {
                    remaining_commentaries = false;
                }

                commentary_loaded = true;
            },
            true
        );
        last_commentary_line = last_visible_line + 20;
    }

    function draw_witness_header_and_background() {
        let wit_header = $('#witness-header');
        let wit_header_col = $('#playtext-header-col');
        let width = wit_header.width();
        let selectively_quoted_width = 20;
        let witness_width = (width - selectively_quoted_width) / witness_count;
        let centuries = Object.keys(witness_centuries);
        let last_century = centuries[centuries.length - 1];

        if (witness_centuries[last_century] * witness_width < 20) {
            last_century_buffer = 20 - witness_centuries[last_century] * witness_width;
            witness_width = (width - (last_century_buffer + selectively_quoted_width)) / witness_count;
        }

        let header_height = wit_header.height();

        let header_canvas = document.createElement('canvas');
        let header_context = header_canvas.getContext('2d');
        //let light_beige = get_nvs_var('nvs-light-beige');
        //let dark_beige = get_nvs_var('nvs-dark-beige');
        let font_color = get_nvs_var('nvs-mid-gray');
        let light_orange = get_nvs_var('nvs-light-orange');
        let delimiter_color = get_nvs_var('nvs-background-color');
        let font_size = 12;
        header_context.font = `${font_size}px Roboto Condensed`;
        header_context.textAlign = "left";
        header_context.textBaseline = "bottom";

        let playtext_col = $('#playtext-col');
        let background_canvas = document.createElement('canvas');
        background_canvas.height = playtext_col.innerHeight();
        background_canvas.width = width;
        let background_context = background_canvas.getContext('2d');

        // DRAW LIGHT ORANGE BACKGROUND ON BOTH CANVASES
        header_context.beginPath();
        header_context.fillStyle = light_orange;
        header_context.fillRect(0, 0, width, header_height);

        background_context.beginPath();
        background_context.fillStyle = light_orange;
        background_context.fillRect(0, 0, width, playtext_col.innerHeight());

        let century_cursor = 0;
        let width_cursor = 0;
        let delimiter_width = 2;
        let century_width = 0;
        for (let century in witness_centuries) {
            century_width = witness_centuries[century] * witness_width;

            header_context.beginPath();
            header_context.fillStyle = delimiter_color;
            header_context.fillRect(width_cursor, 0, delimiter_width, header_height);

            background_context.beginPath();
            background_context.fillStyle = delimiter_color;
            background_context.fillRect(width_cursor, 0, delimiter_width, playtext_col.innerHeight());

            header_context.save();
            header_context.fillStyle = font_color;
            header_context.translate(width_cursor + 5, header_height - 5);
            header_context.rotate(-Math.PI / 2);
            header_context.fillText(century, 0, font_size);
            header_context.restore();

            century_cursor += 1;
            width_cursor += century_width;
        }

        if (century_width < 20) {
            width_cursor += 20 - century_width;
        }

        header_context.beginPath();
        header_context.fillStyle = delimiter_color;
        header_context.fillRect(width_cursor, 0, delimiter_width, header_height);

        background_context.beginPath();
        background_context.fillStyle = delimiter_color;
        background_context.fillRect(width_cursor, 0, delimiter_width, playtext_col.innerHeight());

        header_context.save();
        header_context.fillStyle = font_color;
        header_context.translate(width_cursor + 5, header_height - 5);
        header_context.rotate(-Math.PI / 2);
        header_context.fillText("SEL.", 0, font_size);
        header_context.restore();

        wit_header_col.css('background-image', `url(${header_canvas.toDataURL()})`);
        wit_header_col.css('background-position', `${wit_header.offset().left + 6}px 5px`);

        playtext_col.css('background-image', `url(${background_canvas.toDataURL()})`);
        playtext_col.css('background-position', `${wit_header.offset().left + 6}px 0px`);
        playtext_col.css('background-color', light_orange);
    }

    function draw_witness_meter(witness_meter, canvas_element, width, height, inactive_color="#CFCFCF") {
        canvas_element.src = `${witness_meter_prefix}${witness_meter}/${Math.floor(height)}/${Math.floor(width)}/${inactive_color.replace('#', '')}/${Math.floor(last_century_buffer)}/`;
    }

    function get_param(param) {
        return (window.location.search.match(new RegExp('[?&]' + param + '=([^&]+)')) || [, null])[1];
    }

    function romanize (num) {
        if (isNaN(num))
            return NaN;
        let digits = String(+num).split(""),
            key = ["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM",
                   "","X","XX","XXX","XL","L","LX","LXX","LXXX","XC",
                   "","I","II","III","IV","V","VI","VII","VIII","IX"],
            roman = "",
            i = 3;
        while (i--)
            roman = (key[+digits.pop() + (i * 10)] || "") + roman;
        return Array(+digits.join("") + 1).join("M") + roman;
    }

    function navigate_to(nav_type, xml_id, link=null) {
        xml_id = xml_id.replace(/#/g, '');
        if (nav_type === 'lb') {
            let start_id = xml_id;
            let end_id = null;
            if (start_id.includes(' ')) {
                let id_parts = start_id.split(' ');
                start_id = id_parts[0];
                end_id = id_parts[1];
            }

            if (start_id in lines) {
                let lines_label = 'Line';
                let line_row = $(lines[start_id].row);
                let lines_html = `<div class="play-words">${line_row.data('text')}<br/>`;

                if (end_id) {
                    lines_label += `s ${line_row.data('line_label')}-`;
                    let collecting = true;
                    while (collecting) {
                        line_row = line_row.next();
                        if (line_row.hasClass('play-row')) {
                            lines_html += `${line_row.data('text')}<br/>`;
                            if (line_row.data('xml_id') === end_id) {
                                collecting = false;
                                lines_label += line_row.data('line_label');
                            }
                        }
                    }
                } else lines_label += ' ' + line_row.data('line_label');

                lines_label += `
                        <i class="fas fa-external-link-square-alt ml-2"
                            style="cursor: pointer;"
                            onClick="javascript: $('#nav-modal').modal('hide'); $('#${start_id}-row')[0].scrollIntoView({behavior: 'smooth'});"
                        ></i>
                `;
                lines_html += "</div>";
                display_nav_modal(lines_label, lines_html, link);
            }
        } else {
            if (nav_type === 'siglum'){
                if (!xml_id.startsWith('s_')) xml_id = `s_${xml_id.toLowerCase()}`;

                if (xml_id in witnesses) {
                    let title = 'Collated Edition';
                    if (witnesses[xml_id].bibliographic_entry.includes('<br /><br />')) title += 's';
                    display_nav_modal(title, witnesses[xml_id].bibliographic_entry, link);
                }
            } else {
                if (!nav_map.hasOwnProperty(nav_type)) nav_type = 'anchor';

                let xml_ids = xml_id.split(' ');
                let search_params = {
                    page: 1,
                    'page-size': xml_ids.length,
                    only: 'id',
                    operator: xml_ids.length > 1 ? 'or' : 'and'
                };

                if (nav_map[nav_type]['filter_play']) {
                    search_params['f_play.id'] = play_id;
                }

                let content_type = nav_map[nav_type]['content_type'];
                let search_field = nav_map[nav_type]['xml_id_field'];
                search_params[`t_${search_field}`] = xml_ids.join('__');
                corpora.list_content(corpus_id, content_type, search_params, function (search_data) {
                    if (search_data.hasOwnProperty('records') && search_data.records.length === xml_ids.length) {
                        let ids = search_data.records.map(record => record.id);
                        populate_nav_contents(nav_type, ids, [], xml_ids[0], link);
                    }
                });
            }
        }
    }

    function populate_nav_contents(nav_type, ids, contents=[], first_xml_id=null, link=null) {
        if (ids.length > 0) {
            let content_type = nav_map[nav_type]['content_type'];

            corpora.get_content(corpus_id, content_type, ids[0], function(content_data) {
                contents.push(content_data);
                ids.shift();

                if (ids.length > 0) {
                    populate_nav_contents(nav_type, ids, contents, first_xml_id, link);
                } else {
                    let nav_title = nav_map[nav_type]['title'];
                    if (contents.length > 1) { nav_title = nav_map[nav_type]['title_plural']; }

                    let nav_content = '';
                    contents.map(content => {
                        if (nav_content === '') nav_content += '<a name="nav-content-start"></a>';
                        else nav_content += '<br><br>';

                        if (nav_type === 'note_cn') {
                            nav_content += `
                                <div class="comm-heading">
                                    ${content.line_label}: ${content.subject_matter}
                                </div>
                            `;
                        } else if (nav_type === 'anchor') {
                            nav_title = `${content.section} | ${content.title}`;
                            nav_title += `
                                <a href="${paratext_prefix}${content.section}/#paratext-${content.id}" target="_blank">
                                    <i class="fas fa-external-link-square-alt ml-2"></i>
                                </a>
                            `;
                        }

                        nav_content += content[nav_map[nav_type]['content_field']];
                    });

                    let modal_id = display_nav_modal(nav_title, nav_content, link);
                    if (nav_map[nav_type].scroll_anchor) {
                        setTimeout(delayed_scroll.bind(null, first_xml_id, true, modal_id), 2000)
                    }
                }
            });
        }
    }

    function display_nav_modal(title, content, link) {
        let modal_id = '';
        let modal_el = null;
        let title_html = '';
        if (nav_history_cursor - 1 >= 0) title_html += `<i class="fa fa-chevron-circle-left" aria-hidden="true" onClick="javascript: view_nav_history();" style="cursor: pointer;"></i>`;
        if (nav_history_cursor + 1 <= nav_history.length - 1) title_html += `<i class="fa fa-chevron-circle-right" aria-hidden="true" onClick="javascript: view_nav_history(true);" style="cursor: pointer;"></i>`;
        if (title_html === '') title_html += title;
        else title_html += `<span class="ml-2">${title}</span>`;

        if (link) {
            modal_id = `ref-modal-${ref_modal_counter}`;
            let link_rect = link.getBoundingClientRect();
            let arrow_side = 'right';
            if (link_rect.x <= window.innerWidth / 2) {
                arrow_side = 'left'
            }
            $('body').append(`
                <div
                    id="${modal_id}"
                    class="ref-modal"
                >
                    <div class="arrow-${arrow_side}">
                        <div id="${modal_id}-header" class="ref-modal-header d-flex ${arrow_side === 'left' ? 'flex-row-reverse' : ''} justify-content-between">
                            ${title}
                            <i id="${modal_id}-close-button" class="fas fa-times ref-modal-close" data-modal-id="${modal_id}" aria-label="Close"></i>
                        </div>
                        <div class="ref-modal-content">${content}</div>
                    </div>
                </div>
            `);
            modal_el = $(`#${modal_id}`);
            if (arrow_side === 'right') {
                modal_el.css('top', `${link_rect.top + window.pageYOffset - 20}px`);
                modal_el.css('left', `${link_rect.left - (modal_el.width() + 20)}px`);
            } else {
                modal_el.css('top', `${link_rect.top + window.pageYOffset - 20}px`);
                modal_el.css('left', `${link_rect.right + 20}px`);
            }

            $(`#${modal_id}-close-button`).click(function() {
                let close_modal_id = $(this).data('modal-id');
                $(`#${close_modal_id}`).remove();
            });
            let ref_modal = $(`#${modal_id}`);
            make_draggable(ref_modal[0]);
            ref_modal_counter += 1;
        }
        else {
            $('#nav-modal-label').html(title_html);
            $('#nav-modal-body').html(content);
            $('#nav-modal').modal();
        }

        return modal_id;
    }

    function make_draggable(elmnt) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        if (document.getElementById(elmnt.id + "-header")) {
            // if present, the header is where you move the DIV from:
            document.getElementById(elmnt.id + "-header").onmousedown = dragMouseDown;
        } else {
            // otherwise, move the DIV from anywhere inside the DIV:
            elmnt.onmousedown = dragMouseDown;
        }

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // get the mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // call a function whenever the cursor moves:
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // calculate the new cursor position:
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // set the element's new position:
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            // stop moving when mouse button is released:
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    function delayed_scroll(anchor, smooth=true, parent=null) {
        let scroll_opts = {behavior: 'smooth'};
        if (!smooth) scroll_opts = null;

        let id_selector = `${parent ? '#' + parent + ' ' : ''}#${anchor}`;
        let anchor_selector = `${parent ? '#' + parent + ' ' : ''}a[name=${anchor}]`;

        console.log(id_selector);
        console.log(anchor_selector);

        if ($(id_selector).length) {
            $(id_selector)[0].scrollIntoView(scroll_opts);
        }
        else $(anchor_selector)[0].scrollIntoView(scroll_opts);
    }

    function setup_lines() {
        var line_observer = new IntersectionObserver(function(entries) {
            if (entries[entries.length - 1].isIntersecting) {
                let line_id = entries[entries.length - 1].target.id.replace('-row', '');

                // determine whether more commentary ought to be loaded
                let line_no = parseInt(lines[line_id].number);
                if (line_no > last_visible_line) {
                    clearTimeout(comm_timer);
                    last_visible_line = line_no;
                    comm_timer = setTimeout(load_commentary, 1000);
                }

                // determine current act/scene
                let act = lines[line_id].act;
                let scene = lines[line_id].scene;
                let act_scene = `${act}.${scene}`;
                if (act_scene !== current_act_scene) {
                    $('.actscene-indicator').removeClass('active');
                    $(`.actscene-indicator[data-actscene="${act_scene}"]`).addClass('active');
                    current_act_scene = act_scene;
                }
            }
        }, { threshold: [0] });

        $('.play-row').each(function() {
            let row = $(this);
            let xml_id = row.data('xml_id');
            lines[xml_id] = {
                row: row,
                populated: false,
                notes: [],
                label: row.data('line_label'),
                number: row.data('line_number'),
                act: row.data('act'),
                scene: row.data('scene'),
                witness_indicators: row.data('witness_indicators'),
                witness_column: document.getElementById(`${xml_id}-witness-col`),
                witness_meter: document.getElementById(`${xml_id}-witness-meter`),
            };

            draw_witness_meter(
                lines[xml_id].witness_indicators,
                lines[xml_id].witness_meter,
                lines[xml_id].witness_column.clientWidth,
                lines[xml_id].witness_column.clientHeight - 8
            );

            line_observer.observe(this);
        });

        Object.keys(notes).map(note_id => {
            let note = notes[note_id];
            note.lines.map(line => {
                if (lines.hasOwnProperty(line.xml_id)) lines[line.xml_id].notes.push(note_id);
            });
        });

        last_visible_line = 0;
        load_commentary();
    }

    </script>
    </body>
</html>