{% extends 'base.html' %}
{% load static %}
{% load extras %}

{% block css %}
    <style type="text/css">
        span.speaker {
            border-left: solid 4px #17BEBB;
            padding-left: 8px;
        }

        span.stage_direction {
            border-left: solid 4px #EF3E36;
            padding-left: 8px;
        }

        span.header {
            font-size: 20px;
            font-weight: bold;
            margin-top: 8px;
            margin-bottom: 8px;
        }

        span.speaker-abbreviation {
            font-style: italic;
        }

        span.difference {
            padding: 5px;
            background-color: #EF3E36;
            color: white;
        }

        .line-row {
            margin-bottom: 10px;
        }

        .variant-row {
            margin-bottom: 5px;
        }

        .witness-meter {
            height: 10px;
        }

        .witness-meter-0 {
            font-size: 1px;
            width: 1px;
            background-color: #17BEBB;
        }

        .witness-meter-1 {
            font-size: 1px;
            width: 1px;
            background-color: #EF3E36;
        }

        .variant-bug {
            border: dashed 2px red;
        }
    </style>
{% endblock %}

{% block main %}
    {% if line_mode %}
        {% for line in lines %}
            <div class="row line-row">
                <div class="col-sm-1">
                    <a name="{{ line.xml_id }}"></a>
                    {{ line.line_label }}
                </div>
                <div class="col-sm-8">
                    {% if line.notes|length %}
                        <a data-toggle="collapse" href="#tn_ln_{{ line.xml_id }}" role="button" aria-expanded="false" aria-controls="collapseExample">
                            {% if line.has_bug %}
                                <i class="fas fa-bug"></i>
                            {% else %}
                                <i class="fas fa-caret-square-right"></i>
                            {% endif %}
                        </a>
                    {% else %}
                        <i class="far fa-caret-square-right"></i>
                    {% endif %}
                    {{ line.rendered_html|safe }}
                </div>
                <div class="col-sm-3">
                    {% if line.witness_meter %}
                        {% with witness_meter=line.witness_meter %}
                            {% include "witness_meter.html" %}
                        {% endwith %}
                    {% endif %}
                </div>

                {% if line.notes|length %}
                    </div>
                    <div class="collapse" id="tn_ln_{{ line.xml_id }}">
                        {% for note in line.notes %}
                            {% for variant in note.variants %}
                                <div class="row variant-row">
                                    <div class="col-sm-1"></div>
                                    <div class="col-sm-6">
                                        {% if variant.variant %}
                                            {{ variant.variant|safe }}
                                        {% endif %}
                                    </div>
                                    <div class="col-sm-2{% if variant.has_bug %} variant-bug{% endif %}">
                                        <a href="/corpus/{{ corpus.id }}/TextualNote/{{ note.id }}/" target="_blank">Note</a>
                                        <a href="/corpus/{{ corpus.id }}/TextualVariant/{{ variant.id }}/" target="_blank">Variant</a>
                                        <a href="?note-id={{ note.id }}&variant-id={{ variant.id }}&line-id={{ line.xml_id }}"><i class="fas fa-sync-alt"></i></a>
                                        <a href="?note-id={{ note.id }}&variant-id={{ variant.id }}&line-id={{ line.xml_id }}&mark-as-bug=y"><i class="fas fa-bug"></i></a><br>
                                        {{ variant.label|safe }}
                                    </div>
                                    <div class="col-sm-3">
                                        {% if variant.witness_meter %}
                                            {% with witness_meter=variant.witness_meter %}
                                                {% include "witness_meter.html" %}
                                            {% endwith %}
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                {% else %}
                    </div>
                {% endif %}
        {% endfor %}
    {% else %}
        {{ html|safe }}
    {% endif %}
{% endblock %}

{% block js %}
    <script src="{% static 'js/jquery.connections.js' %}"></script>
    <script type="application/javascript">
        $(document).ready(function() {
            hide_loading_overlay();
            let line_xml_id = $(location).attr('hash');
            if (line_xml_id) {
                line_xml_id = line_xml_id.substr(1);

                $(`#tn_ln_${line_xml_id}`).collapse('show');
            }
        });
    </script>
{% endblock %}