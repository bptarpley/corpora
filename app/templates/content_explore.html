{% extends 'base.html' %}
{% load static %}
{% load extras %}

{% block css %}
    <style type="text/css">
        canvas {
            outline: none;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0); /* mobile webkit */
        }

        #selected_div {
            position: fixed;
            top: calc(10vh);
            left: 0px;
            width: 200px;
            max-height: calc(100vh);
            background-color: rgba(255, 255, 255, .8);
        }

        .content-pane {
            cursor: move;
        }

        .selection-div:hover {
            color: #EF3E36;
        }

        .popup-button:hover {
            cursor: pointer;
            color: #EF3E36;
        }
    </style>
    <link href="{% static 'css/vis-network.min.css' %}" rel="stylesheet">

{% endblock %}

{% block main %}
    <div class="row mt-4">
        <div id="explore" class="col-12">
            <div id="explore-legend" class="d-inline-flex align-items-start"></div>
            <div id="explore-div" style="height: 800px;"></div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script src="{% static 'js/filepond.js' %}"></script>
    <script src="{% static 'js/tinymce/tinymce.min.js' %}"></script>
    <script src="{% static 'js/vis-network.min.js' %}"></script>
    <script type="application/javascript">
        let corpus_id = '{{ corpus_id }}';
        let corpus_uri = `/corpus/${corpus_id}`;
        let content_type_name = '{{ content_type }}';
        let content_ids = {{ content_ids|safe }};
        let content_uris = content_ids.map(c_id => `${corpus_uri}/${content_type_name}/${c_id}`);
        let selected_uris = [];
        let root_node_mass = 50;
        let content_type = null;
        let canvas, content, network, nodes, edges = null;
        let panes_displayed = {};
        let stabilization_seconds = 20;
        let stabilization_timer = null;
        let per_group_limit = 21;
        let groups = {};
        let group_colors = [
            '#EF3E36',
            '#091540',
            '#17BEBB',
            '#BFC0C0',
            '#2191FB',
            '#297045',
            '#9448BC',
            '#FFB627',
            '#CCC9E7',
            '#E9E3B4',
        ];
        let group_color_cursor = 0;

        $(document).ready(function() {
            /* when finished loading:
            network.fit();
            nodes.update([{ id: content.uri, label: content.label, title: null, fixed: true }]);
            hide_loading_overlay();
             */
            canvas = $('#explore-div');
            
            corpora.get_corpus(corpus_id, function(corpus_data) {
                add_breadcrumb(corpus_data.name, `/corpus/${corpus_id}/`);
                content_type = corpus_data.content_types[content_type_name];

                if (content_ids.length > 0) {
                    let seed_id = content_ids[0];
                    let seed_uri = `/corpus/${corpus_id}/${content_type_name}/${seed_id}`;

                    corpora.get_network_json(corpus_id, content_type_name, seed_id, {per_type_limit: per_group_limit}, function(net_json) {
                        nodes = new vis.DataSet(net_json.nodes);
                        edges = new vis.DataSet(net_json.edges);
                        determine_group_colors();

                        let seed_node = nodes.get(seed_uri);
                        seed_node.mass = root_node_mass;
                        seed_node.size = 20;
                        seed_node.skip = per_group_limit;
                        affix_node_label(seed_node);
                        nodes.update(seed_node);

                        let explore_div = $('#explore-div')[0];
                        network = new vis.Network(
                            explore_div,
                            {
                                nodes: nodes,
                                edges: edges
                            },
                            {
                                nodes: {
                                    shape: 'dot',
                                    size: 10
                                },
                                groups: groups,
                                interaction: {
                                    zoomSpeed: 0.4,
                                    hover: true,
                                    tooltipDelay: 100
                                }
                            }
                        );

                        network.on("dragStart", function(params){
                            params.nodes.map(id => {
                                let n = nodes.get(id);
                                n.fixed = false;
                                affix_node_label(n);
                                nodes.update(n);
                            });
                        });

                        network.on("dragEnd", function(params){
                            params.nodes.map(id => {
                                nodes.update([{ id: id, fixed: true }]);
                            });
                        });

                        network.on("click", function(params) {
                            remove_unpinned_panes();

                            if (params.nodes.length > 0) {
                                let clicked_uri = params.nodes[0];
                                let clicked_node = nodes.get(clicked_uri);
                                let pane_id = `${clicked_uri.replaceAll('/', '-')}-pane`;
                                let canvas_offset = canvas.offset();
                                let pane_x = params.pointer.DOM.x + canvas_offset.left;
                                let pane_y = params.pointer.DOM.y + canvas_offset.top;

                                affix_node_label(clicked_node);
                                nodes.update(clicked_node);

                                if ($(`#${pane_id}`).length > 0) {
                                    console.log('already there!');
                                } else {
                                    $('#main-container').append(`
                                        <div id="${pane_id}"
                                            class="content-pane"
                                            style="background-color: rgba(255, 255, 255, .8);
                                                width: 200px;
                                                height: 225px;
                                                position: absolute;
                                                top: ${pane_y}px;
                                                left: ${pane_x}px;">

                                            <div style="height: 25px;">
                                                <span id="${pane_id}-select" title="Select" onClick="select_node('${clicked_uri}');" class="popup-button far fa-check-square"></span>
                                                <span id="${pane_id}-pin" title="Pin" onClick="pin_node('${clicked_uri}');" class="popup-button fas fa-thumbtack"></span>
                                                <span title="Sprawl" onClick="sprawl_node('${clicked_uri}');" class="popup-button fas fa-expand-arrows-alt"></span>
                                                <span title="Remove" onClick="extrude_node('${clicked_uri}');" class="popup-button far fa-trash-alt"></span>
                                            </div>
                                            <iframe src="${clicked_uri}/?popup=y" frameBorder="0" width="200px" height="200px" />
                                        </div>
                                    `);
                                    panes_displayed[clicked_uri] = {pinned: false};
                                    make_draggable(document.getElementById(pane_id));
                                }
                            }
                        });

                        network.on("stabilized", function(params) {
                            clearTimeout(stabilization_timer);
                        });

                        extrude_node(corpus_uri);

                        let children = [];
                        nodes.map(n => {
                            if (n.id !== seed_uri) {
                                children.push(n.id);
                            }
                        });
                        children.map(child_uri => {
                            sprawl_node(child_uri);
                        });

                        for (let x = 1; x < content_ids.length; x++) {
                            sprawl_node(`${corpus_uri}/${content_type_name}/${content_ids[x]}`, true);
                        }
                    });
                }
            });

            hide_loading_overlay();
        });

        function sprawl_node(uri, sprawl_children=false) {
            let node_ct = uri.split('/').slice(-2)[0];
            let node_id = uri.split('/').slice(-1)[0];
            let skip = 0;

            let node = nodes.get(uri);
            if (node && node.hasOwnProperty('skip')) {
                skip = node.skip;
            }

            corpora.get_network_json(corpus_id, node_ct, node_id, {per_type_skip: skip, per_type_limit: per_group_limit}, function(net_json) {
                let children = [];

                net_json.nodes.map(n => {
                    if (n.id !== corpus_uri && !nodes.get(n.id)) {
                        if (content_uris.includes(n.id)) { n.mass = root_node_mass; n.size = 20; affix_node_label(n); }
                        if (n.id === uri) { n.skip = per_group_limit; }
                        nodes.add(n);
                        children.push(n.id);
                    }
                });

                net_json.edges.map(e => {
                    if (e.from !== corpus_uri && e.to !== corpus_uri && !edges.get(e.id)) {
                        edges.add(e);
                    }
                });

                determine_group_colors();
                network.setOptions({groups: groups});

                if (sprawl_children) {
                    children.map(child_uri => sprawl_node(child_uri));
                }

                clearTimeout(stabilization_timer);
                stabilization_timer = setTimeout(stop_jitter, stabilization_seconds * 1000);
            });

            if (node) {
                node.skip = skip += per_group_limit;
                nodes.update(node);
            }
        }

        function select_node(uri) {
            let sel_id = `${uri.replaceAll('/', '-')}-pane-select`;

            if (!selected_uris.includes(uri)) {
                selected_uris.push(uri);
                $(`#${sel_id}`).css('color', '#EF3E36');
            } else {
                selected_uris = selected_uris.filter(val => val !== uri);
                $(`#${uri.replaceAll('/', '-')}-selection`).remove();
                $(`#${sel_id}`).css('color', '#091540');
            }

            if (selected_uris.length > 0) {
                if ($('#selected_div').length === 0) {

                    canvas.append(`
                        <div id="selected_div">
                            <form id="selection_form" method="post" action="${corpus_uri}/">
                                {% csrf_token %}
                                <input type="hidden" id="merge_ids" name="content-ids" value="" />
                                <button type="button" class="btn btn-sm btn-primary" id="merge_button" disabled>Merge...</button>
                            </form>
                        </div>
                    `);

                    $('#merge_button').click(function() {
                        let selected_cts = selected_uris.map(suri => suri.split('/').slice(-2)[0]);
                        let selected_ids = selected_uris.map(suri => suri.split('/').slice(-1)[0]);

                        selected_cts = [...new Set(selected_cts)];
                        if (selected_cts.length > 1) {
                            alert("Only content of the same type can be merged!");
                        } else {
                            let selection_form = $('#selection_form');
                            selection_form.attr('action', `${corpus_uri}/${selected_cts[0]}/merge/`);
                            $('#merge_ids').val(selected_ids.join(','));
                            selection_form.submit();
                        }

                    });
                }

                let selected_div = $('#selected_div');

                selected_uris.map(sel_uri => {
                    let sel_node = nodes.get(sel_uri);
                    let sel_label = sel_node.title ? sel_node.title : sel_node.label;
                    let sel_id = `${sel_uri.replaceAll('/', '-')}-selection`;
                    if ($(`#${sel_id}`).length === 0) {
                        selected_div.append(`
                            <div id="${sel_id}" class="selection-div">
                                <div class="float-right">
                                    <span onClick="select_node('${sel_uri}');" class="popup-button far fa-minus-square"></span>
                                </div>
                                [${sel_node.group}] ${sel_label}
                            </div>
                        `);
                    }
                });

                if (selected_uris.length > 1) {
                    $('#merge_button').removeAttr('disabled');
                } else {
                    $('#merge_button').attr('disabled', true);
                }
            } else {
                $('#selected_div').remove();
            }
        }

        function pin_node(uri) {
            if (!panes_displayed[uri].pinned) {
                panes_displayed[uri].pinned = true;
                let pin_id = `${uri.replaceAll('/', '-')}-pane-pin`;
                $(`#${pin_id}`).css('color', '#EF3E36');
            } else {
                panes_displayed[uri].pinned = false;
                remove_unpinned_panes();
            }
        }

        function extrude_node(uri, remove_isolated=true) {
            edge_ids = network.getConnectedEdges(uri);
            edge_ids.map(edge_id => edges.remove(edge_id));
            nodes.remove(uri);
            remove_unpinned_panes();

            if (remove_isolated) {
                let isolated_nodes = new vis.DataView(nodes, {
                    filter: function (node) {
                        let connEdges = edges.get({
                            filter: function (edge) {
                                return (
                                    (edge.to == node.id) || (edge.from == node.id));
                            }
                        });
                        return connEdges.length == 0;
                    }
                });

                isolated_nodes.map(i => extrude_node(i.id, false));
            }
        }

        function remove_unpinned_panes() {
            for (let pane_uri in panes_displayed) {
                if (!panes_displayed[pane_uri].pinned) {
                    let pane_id = `${pane_uri.replaceAll('/', '-')}-pane`;
                    $(`#${pane_id}`).remove();
                    delete panes_displayed[pane_uri];
                }
            }
        }

        function stop_jitter() {
            nodes.map(n => {n.fixed = true; nodes.update(n);});
        }

        function affix_node_label(node) {
            if (node.title) {
                node.label = node.title;
                node.title = null;
            }
        }

        function determine_group_colors() {
            let group_names = nodes.map(n => n.group);
            group_names = [...new Set(group_names)];
            group_names.map(group_name => {
                if (group_name !== 'Corpus' && !Object.keys(groups).includes(group_name)) {
                    groups[group_name] = {
                        color: group_colors[group_color_cursor]
                    };

                    group_color_cursor++;
                    if (group_color_cursor >= group_colors.length) group_color_cursor = 0;

                    groups[group_name].selected = group_colors[group_color_cursor];
                }
            });

            let legend = $('#explore-legend');
            legend.html('');
            for (let group_name in groups) {
                legend.append(`
                    <span class="badge mr-1" style="background-color: ${groups[group_name].color}; color: #FFFFFF;">${group_name}</span>
                `);
            }
        }

        function make_draggable(elmnt) {
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            if (document.getElementById(elmnt.id + "header")) {
                // if present, the header is where you move the DIV from:
                document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
            } else {
                // otherwise, move the DIV from anywhere inside the DIV:
                elmnt.onmousedown = dragMouseDown;
            }

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                // call a function whenever the cursor moves:
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // set the element's new position:
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                // stop moving when mouse button is released:
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

    </script>
{% endblock %}