{% extends 'base.html' %}
{% load static %}
{% load extras %}

{% block css %}
    <link href="{% static 'css/filepond.css' %}" rel="stylesheet">
    <style type="text/css">
        #settings-editor {
            /* Setting height is important, otherwise editor wont show up */
            height: 300px;
        }

        .corpora-content-cell {
            max-height: 100px;
            overflow: scroll;
            -ms-overflow-style: -ms-autohiding-scrollbar;
        }

        .ct-selection-cell {
            white-space: nowrap;
        }

        #provenance-div {
            max-height: 200px;
            overflow: scroll;
            -ms-overflow-style: -ms-autohiding-scrollbar;
        }
    </style>
{% endblock %}

{% block modals %}
    <!-- UPLOAD CORPUS FILES MODAL -->
    <div class="modal fade" id="file-upload-modal" tabindex="-1" role="dialog" aria-labelledby="file-upload-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="file-upload-modal-label">Import Corpus File(s)</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="import-corpus-files-form" method="post">
                        {% csrf_token %}
                        <input type="hidden" id="import-corpus-files" name="import-corpus-files"/>
                    </form>
                    <div class="alert alert-light">
                        <table class="table table-striped">
                            <thead class="thead-dark">
                                <th scope="col">Path: <span id="file-upload-modal-table-header">/</span></th>
                            </thead>
                            <tbody id="file-upload-modal-table-body">
                                <tr><td>Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <input type="file" class="filepond" id="import-corpus-filepond">
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="input-group">
                                <input type="text" class="form-control" id="file-upload-modal-new-folder-box" aria-placeholder="New Folder" placeholder="New Folder">
                                <span class="input-group-btn ml-1"><a href="javascript:handle_folder_creation();" role="button" id="file-upload-modal-new-folder-button" class="btn btn-secondary">Go</a></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" id="file-upload-reset-button" class="btn btn-secondary">Reset</button>
                    <button type="button" id="file-upload-import-button" class="btn btn-primary" disabled>Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JOB MODAL -->
    <div class="modal fade" id="job-modal" tabindex="-1" role="dialog" aria-labelledby="job-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="job-form" method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="job-modal-label">Run a Job</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="jobsite-selector">Jobsite</label>
                            <select id="jobsite-selector" class="form-control" name="jobsite">
                            </select>
                        </div>
                        <div id="task-selector-div" class="form-group">
                            <label for="task-selector">Task</label>
                            <select id="task-selector" class="form-control" name="task">
                            </select>
                        </div>
                        <div id="task-parameters-div">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="job-submit-button" disabled>Run</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Job Finished Modal -->
    <div class="modal fade" id="job-finished-modal" tabindex="-1" role="dialog" aria-labelledby="job-finished-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="job-finished-modal-label">Job Completed</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        One or more jobs have completed for this corpus. Click the "Refresh" button below to view results.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="window.location = window.location.href.replace(location.hash, '');">Refresh</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENT TYPE MODAL -->
    <div class="modal fade" id="new-ct-modal" tabindex="-1" role="dialog" aria-labelledby="new-ct-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="new-ct-modal-label">Create New Content Type</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="new-ct-name-box">Name</label>
                        <input id="new-ct-name-box" type="text" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="new-ct-plural-name-box">Plural Name</label>
                        <input id="new-ct-plural-name-box" type="text" class="form-control">
                    </div>
                    <div class="form-check">
                        <input id="new-ct-nav-checkbox" type="checkbox" value="" class="form-check-input" checked>
                        <label for="new-ct-nav-checkbox">Include in Navigation?</label>
                    </div>
                    <div id="new-ct-proxy-field-div" class="form-group d-none">
                        <label for="new-ct-proxy-field-selector">Proxy For</label>
                        <select id="new-ct-proxy-field-selector" class="form-control"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="new-ct-create-button">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FIELD MODAL -->
    <div class="modal fade" id="new-f-modal" tabindex="-1" role="dialog" aria-labelledby="new-f-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="new-f-modal-label">Create New Field</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input id="new-f-ct-name" type="hidden" value="new">
                    <input id="new-f-f-id" type="hidden" value="new">
                    <input id="new-f-action" type="hidden" value="create">
                    <div class="form-group">
                        <label for="new-f-name-box">Name</label>
                        <input id="new-f-name-box" type="text" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="new-f-label-box">Label</label>
                        <input id="new-f-label-box" type="text" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="new-f-type-box">Type</label>
                        <select id="new-f-type-box">
                            <option value="keyword" selected>Keyword</option>
                            <option value="text">Text</option>
                            <option value="large_text">Large Text</option>
                            <option value="html">HTML</option>
                            <option value="number">Number</option>
                            <option value="decimal">Decimal</option>
                            <option value="boolean">Boolean</option>
                            <option value="date">Date</option>
                            <option value="link">Link</option>
                            <option value="iiif-image">IIIF Image URL</option>
                            <option value="file">File Upload</option>
                            <option value="cross_reference">Cross Reference</option>
                        </select>
                        <select id="new-f-cross-reference-box" class="d-none">
                            <option value="Document">Document</option>
                        </select>
                    </div>
                    <div class="form-group d-none" id="new-f-synonym-div">
                        <label for="new-f-synonym-box">Synonyms for Searching this Field</label>
                        <select id="new-f-synonym-box">
                            <option value="None">None</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input id="new-f-in-lists-checkbox" type="checkbox" value="" class="form-check-input">
                        <label for="new-f-in-lists-checkbox">Include in Lists?</label>
                    </div>
                    <div class="form-check">
                        <input id="new-f-indexed-checkbox" type="checkbox" value="" class="form-check-input">
                        <label for="new-f-indexed-checkbox">Indexed?</label>
                    </div>
                    <div id="new-f-indexed-with-div" class="form-group align-items-start d-none">
                        <label for="new-f-indexed-with-box">with:&nbsp;</label>
                        <select id="new-f-indexed-with-box" class="f-with w-50" multiple>
                            <!-- Populated via Javascript /-->
                        </select>
                    </div>
                    <div class="form-check">
                        <input id="new-f-unique-checkbox" type="checkbox" value="" class="form-check-input">
                        <label for="new-f-unique-checkbox">Unique?</label>
                    </div>
                    <div id="new-f-unique-with-div" class="form-group align-items-start d-none">
                        <label for="new-f-unique-with-box">with:&nbsp;</label>
                        <select id="new-f-unique-with-box" class="f-with w-50" multiple>
                            <!-- Populated via Javascript /-->
                        </select>
                    </div>
                    <div class="form-check">
                        <input id="new-f-multiple-checkbox" type="checkbox" value="" class="form-check-input">
                        <label for="new-f-multiple-checkbox">Multiple?</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="new-f-create-button">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TEMPLATE MODAL -->
    <div class="modal fade" id="template-modal" tabindex="-1" role="dialog" aria-labelledby="template-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="template-modal-label">Edit Template</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="template-ct-name" value="">
                    <input type="hidden" id="template-is-new" value="">

                    <div class="form-group">
                        <label for="template-name">Name:</label>
                        <input id="template-name" type="text" class="form-control">
                    </div>

                    <div id="template-editor" style="height: 400px;"></div>

                    <div class="form-group">
                        <label for="template-mime-type">MIME Type</label>
                        <select id="template-mime-type">
                            <option value="text/html">text/html</option>
                            <option value="text/xml">text/xml</option>
                            <option value="application/json">application/json</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="template-save-button">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCHEMA MODAL -->
    <div class="modal fade" id="import-modal" tabindex="-1" role="dialog" aria-labelledby="import-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="import-modal-label">Import Schema</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="import-editor" style="height: 400px;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="import-button">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENT MANAGER CONFIRMATION MODAL -->
    <div class="modal fade" id="confirmation-modal" tabindex="-1" role="dialog" aria-labelledby="confirmation-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmation-modal-label">Confirm Deletion</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="confirmation-ct-name" name="content_type" value="">
                        <input type="hidden" id="confirmation-field-name" name="field" value="">
                        <input type="hidden" id="confirmation-action" name="action" value="">
                        <div id="confirmation-modal-message" class="alert alert-danger"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="confirmation-confirm-button">Confirm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- CONTENT DELETION CONFIRMATION MODAL -->
    <div class="modal fade" id="deletion-confirmation-modal" tabindex="-1" role="dialog" aria-labelledby="deletion-confirmation-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deletion-confirmation-modal-label">Confirm Deletion</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="deletion-confirmation-modal-message" class="alert alert-danger"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="deletion-confirmation-button">Delete</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block main %}
        <div class="row mt-4">

            <!-- METADATA -->
            <div class="col-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h4>Metadata</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12">
                                <div id="corpus-metadata-div" class="list-group">
                                    <div class="list-group-item">
                                        <h5>Name</h5>
                                        <span id="corpus-name-span"></span>
                                    </div>
                                    <div class="list-group-item">
                                        <h5>Description</h5>
                                        <span id="corpus-desc-span"></span>
                                    </div>
                                    <div class="list-group-item">
                                        <h5>Path</h5>
                                        <span id="corpus-path-span"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FILES -->
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <h4>Corpus Files</h4>
                            {% if response.scholar.is_admin or role == 'Editor' %}
                                <button id="import-corpus-files-button" class="btn btn-primary rounded" type="button">Import</button>
                            {% else %}
                                <span>&nbsp;</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body" id="corpus-files-div">
                        <div class="alert alert-info">
                            There are currently no files for this corpus.
                        </div>
                    </div>
                </div>
            </div>


            <div class="col-6">
                <!-- JOBS -->
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <h4>Running Jobs</h4>
                            <span>
                            {% if response.scholar.is_admin or role == 'Editor' %}
                                <button id="run-job-button" class="btn btn-primary rounded" type="button">Run Job</button>
                                <button id="launch-notebook-button" class="btn btn-primary rounded ml-1" type="button">Launch Notebook</button>
                                <form id="launch-notebook-form" method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="launch-notebook" value="y" />
                                </form>
                            {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <iframe src="/jobs/corpus/{{ corpus_id }}/" width="100%" height="100%" frameBorder="0"></iframe>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h4>Provenance</h4>
                    </div>
                    <div class="card-body">
                        <div id="provenance-div">
                            <div class="alert alert-info">
                                No jobs have been completed for this corpus.
                            </div>
                        </div>
                    </div>
                </div>


            </div>

        </div>
        <div id="content-types-div">

            <!-- CONTENT TYPES LISTED HERE -->

            <form id="multiselect-form" method="post" action="/not/set">
                {% csrf_token %}
                <input id="multiselect-content-ids" name="content-ids" type="hidden" value="">
            </form>
        </div>

        {% if response.scholar.is_admin or role == 'Editor' %}
        <div class="row">
            <!-- CONTENT TYPE MANAGER -->
            <div class="col">
                <a name="ct_manager_div"></a>
                <div id="type-manager-div" class="card mt-4">
                    <div class="card-header">
                        <h4>Content Type Manager</h4>
                    </div>
                    <div class="card-body">
                        <div class="list-group" id="tm-ct-group">
                            <div class="alert alert-info">No Content Types have been defined.</div>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                        <span>
                            <button type="button" class="btn btn-primary mr-2" id="new-ct-button">New Content Type</button>
                            <button type="button" title="Import Schema" class="btn btn-secondary" id="show-import-modal-button"><span class="fas fa-file-import"></span></button>
                            <a role="button" title="Export Schema" class="btn btn-secondary" href="/corpus/{{ corpus_id }}/?export=schema" download="schema"><span class="fas fa-file-export"></span></a>
                        </span>
                        <span>
                            <button type="button" class="btn btn-primary" id="save-content-type-schema-button">Save Changes</button>
                        </span>
                    </div>
                </div>
            </div>
            <form id="ct-schema-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="schema" id="ct-schema" value="">
            </form>
        </div>
        {% endif %}

    {% if response.scholar.is_admin %}
        <div class="row">
            <div class="col">
                <div id="type-manager-div" class="card mt-4">
                    <div class="card-header">
                        <h4>Corpus Management</h4>
                    </div>
                    <div class="card-body">
                        <button type="button" class="btn btn-danger" id="corpus-show-delete-confirmation-button">Delete Corpus</button>
                        <div id="corpus-deletion-confirmation-div" class="alert alert-danger mt-3 d-none">
                            <strong>Warning:</strong> Should you delete this corpus, all data and linkages comprising it
                            will be deleted, and it will only be recoverable via backups. Depending on the size of your corpus,
                            deletion could take some time. <strong>If you are certain you'd like to delete this corpus,
                            type its name (<span id="corpus-deletion-name-span"></span>) in the box below and click the
                            "Delete" button</strong>:

                            <form id="corpus-deletion-form" method="post">
                                {% csrf_token %}
                                <div class="form-group mt-3">
                                    <label for="corpus-deletion-confirmation-box" class="sr-only">Corpus Name</label>
                                    <input type="text" class="form-control" id="corpus-deletion-confirmation-box" name="corpus-deletion-name" placeholder="Corpus Name">
                                </div>
                                <button type="button" class="btn btn-danger" id="corpus-delete-button">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block js %}
    <script src="{% static 'js/filepond.js' %}"></script>
    <script src="{% static 'js/ace/ace.js' %}"></script>
    <script src={% static 'js/beautify/beautify.js' %}></script>
    <script src={% static 'js/beautify/beautify-css.js' %}></script>
    <script src={% static 'js/beautify/beautify-html.js' %}></script>
    <script type="application/javascript">
        let corpus_id = "{{ corpus_id }}";
        let role = "{{ role }}";
        let available_jobsites = {{ available_jobsites|safe }};
        let available_tasks = {{ available_tasks|safe }};
        let corpus = null;
        let template_formats = null;
        let jobsites = [];
        let local_jobsite_id = null;
        let tasks = [];
        let ct_search = {};
        let selected_content = {};
        let import_editor;
        let template_editor;

        // VARS FOR FILE UPLOADS/IMPORTS
        let file_upload_path = '';
        let file_uploads = [];
        let import_files = [];

        // CREATE FILE POND FOR IMPORT CORPUS FILES MODAL
        const import_corpus_file_pond = FilePond.create(document.querySelector('#import-corpus-filepond'), {
            allowMultiple: true,
            allowRevert: false
        });
        import_corpus_file_pond.on('addfile', (error, file) => {
            if(!error) {
                file_uploads.push(file.filename);
            }
        });
        import_corpus_file_pond.on('processfile', (error, file) => {
            if(!error) {
                import_files.push(`${file_upload_path}/${file.filename}`);
                let import_button = $('#file-upload-import-button');
                import_button.html(`Import ${import_files.length} File(s)`);
                import_button.attr('disabled', false);
                let index = file_uploads.indexOf(file.filename);
                if (index !== -1) { file_uploads.splice(index, 1); }
                if (file_uploads.length === 0) {
                    upload_file(file_upload_path);
                }
            }
        });
        
        const FIELD_TYPE_LABELS = {
            text: 'Text',
            large_text: 'Large Text',
            keyword: 'Keyword',
            html: 'HTML',
            choice: 'Choice',
            number: 'Number',
            decimal: 'Decimal',
            boolean: 'Boolean',
            date: 'Date',
            file: 'File',
            link: 'Link',
            'iiif-image': 'IIIF Image URL',
            cross_reference: 'Cross Reference',
            embedded: 'Embedded'
        };

        // fires once HTML DOM has loaded
        $(document).ready(function() {
            // query corpora api for corpus data
            corpora.get_corpus(corpus_id, function(corpus_data) {
                corpus = corpus_data;

                // core metadata
                $('#corpus-name-span').html(corpus.name);
                $('#corpus-desc-span').html(corpus.description);
                $('#corpus-path-span').html(corpus.path);

                // user metadata
                let corpus_metadata_div = $('#corpus-metadata-div');
                for (let key in corpus.kvp) {
                    if (!key.startsWith("_") && (typeof(corpus.kvp[key]) == "string" || typeof(corpus.kvp[key]) == "boolean")) {
                        corpus_metadata_div.append(`
                            <div class="list-group-item">
                                <h5>${key}</h5>
                                ${corpus.kvp[key]}
                            </div>
                        `);
                    }
                }

                // load corpus provenance
                let provenance_div = $('#provenance-div');
                if (corpus.provenance.length > 0) { provenance_div.html(''); }
                corpus.provenance.forEach( prov => {
                    let retry_form = '';
                    if (role === 'Admin' || role === 'Editor') {
                        retry_form = `
                            <form method="post">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${corpora.csrf_token}">
                                <input type="hidden" name="retry-job-id" value="${prov.job_id}">
                                <button type="submit" role="button" class="btn btn-danger">Retry</button>
                            </form>
                        `;
                    }

                    provenance_div.append(`
                        <div id="provenance-${prov.job_id}-div" class="alert alert-${prov.status === "complete" ? 'success' : 'danger'} provenance">
                            <div class="row">
                                <div class="col-sm-10">
                                    Task: <b>${prov.task_name}</b><br />
                                    Completed: ${corpora.time_string(prov.completed)}
                                </div>
                                <div class="col-sm-2">
                                    ${retry_form}
                                </div>
                            </div>
                        </div>
                    `);
                });

                // load corpus files
                let corpus_files_div = $('#corpus-files-div');
                if (Object.keys(corpus.files).length > 0) {
                    corpus_files_div.html(`
                        <table class="table table-striped">
                            <thead class="thead-dark">
                                <th scope="col">
                                    File
                                </th>
                                <th scope="col">
                                    Description
                                </th>
                                <th scope="col">
                                    Extension
                                </th>
                                <th scope="col">
                                    Size (bytes)
                                </th>
                            </thead>
                            <tbody id="corpus-files-table-body">
                            </tbody>
                        </table>
                    `);

                    let corpus_files_tbody = $('#corpus-files-table-body');
                    for (let file_key in corpus.files) {
                        let file = corpus.files[file_key];

                        let file_url = corpora.file_url(file.uri);
                        if (file.is_image) {
                            file_url = corpora.image_url(file.uri);
                        }

                        let open_mode = 'target="_blank"';
                        if (file.extension === 'zip') {
                            open_mode = `download="${file.basename}"`;
                        }

                        corpus_files_tbody.append(`
                            <tr>
                                <td>
                                    <a href="${file_url}" target="_blank">${file.basename}</a>
                                </td>
                                <td>
                                    ${file.description}
                                </td>
                                <td>
                                    ${file.extension}
                                </td>
                                <td>
                                    ${file.byte_size}
                                </td>
                            </tr>
                        `);
                    }
                }

                // setup content type manager
                if (role === 'Editor' || role === 'Admin') {
                    // setup the editor for importing a content type schema
                    import_editor = ace.edit("import-editor");
                    import_editor.setTheme("ace/theme/monokai");
                    import_editor.getSession().setMode("ace/mode/json");

                    // setup the editor for editing template
                    template_editor = ace.edit("template-editor");
                    template_editor.setTheme("ace/theme/monokai");
                    template_editor.getSession().setMode("ace/mode/django");

                    // populate synonym file options
                    if (corpus.hasOwnProperty('available_synonyms')) {
                        let synonym_box = $('#new-f-synonym-box');
                        for (let synonym_option in corpus.available_synonyms) {
                            synonym_box.append(`
                                <option value='${synonym_option}'>${corpus.available_synonyms[synonym_option].label}</option>
                            `);
                        }
                    }

                    // setup event for showing schema import modal
                    $('#show-import-modal-button').click(function () {
                        import_editor.setValue('');
                        $('#import-modal-label').html('Import Schema');
                        $('#import-button').removeClass('d-none');
                        $('#import-modal').modal();
                    });

                    // setup event for clicking "Import" button on schema import modal
                    $('#import-button').click(function () {
                        let import_schema = JSON.parse(import_editor.getValue());
                        for (let x = 0; x < import_schema.length; x++) {
                            if (!corpus.content_types.hasOwnProperty(import_schema[x].name)) {
                                corpus.content_types[import_schema[x].name] = import_schema[x];
                                manage_content_type(import_schema[x].name);
                            }
                        }

                        $('#import-modal').modal('hide');
                    });

                    // setup event for saving the content type schema
                    $('#save-content-type-schema-button').click(function () {
                        $('#save-content-type-schema-button').attr('disabled', true);
                        let ct_schema = [];
                        for (let ct_name in corpus.content_types) {
                            ct_schema.push(corpus.content_types[ct_name]);
                        }
                        $('#ct-schema').val(JSON.stringify(ct_schema));
                        $('#ct-schema-form').submit();
                    });

                    // PEP8 CLASS FORMAT CONTENT TYPE NAME
                    $('#new-ct-name-box').focusout(function () {
                        $('#new-ct-name-box').val(pep8_class_format(pep8_variable_format($('#new-ct-name-box').val())));
                    });

                    // PEP8 VARIABLE FORMAT FIELD NAME
                    $('#new-f-name-box').focusout(function () {
                        $('#new-f-name-box').val(pep8_variable_format($('#new-f-name-box').val()));
                    });

                    // NEW CONTENT TYPE BUTTON CLICK
                    $('#new-ct-button').click(function () {
                        $('#new-ct-modal-label').html('Create Content Type');
                        $('#new-ct-index').val('new');
                        $('#new-ct-name-box').prop('disabled', false);
                        $('#new-ct-name-box').val('');
                        $('#new-ct-plural-name-box').val('');
                        $('#new-ct-nav-checkbox').prop('checked', true);
                        $('#new-ct-proxy-field-selector').val('');
                        $('#new-ct-proxy-field-div').addClass('d-none');
                        $('#new-ct-modal').modal();
                    });

                    // CREATE/EDIT CONTENT TYPE BUTTON CLICK
                    $('#new-ct-create-button').click(function () {
                        let ct_name = $('#new-ct-name-box').val();
                        if (!corpus.content_types.hasOwnProperty(ct_name)) {
                            corpus.content_types[ct_name] = {
                                id: '',
                                name: ct_name,
                                plural_name: $('#new-ct-plural-name-box').val(),
                                show_in_nav: $('#new-ct-nav-checkbox').is(':checked'),
                                proxy_field: '',
                                fields: [],
                                is_new: true,
                                templates: {
                                    Label: {
                                        template: {% verbatim %}`${ct_name} {{ ${ct_name}.id }}`{% endverbatim %},
                                        mime_type: "text/html"
                                    }
                                }
                            };
                        } else {
                            corpus.content_types[ct_name].plural_name = $('#new-ct-plural-name-box').val();
                            corpus.content_types[ct_name].show_in_nav = $('#new-ct-nav-checkbox').is(':checked');
                            corpus.content_types[ct_name].proxy_field = $('#new-ct-proxy-field-selector').val();
                        }

                        $('#new-ct-modal').modal('hide');
                        manage_content_type(ct_name);
                    });

                    // FIELD TYPE SELECTION CHANGE
                    $('#new-f-type-box').change(function () {
                        let selection = $(this).val();

                        if (selection === 'cross_reference') {
                            $('#new-f-cross-reference-box').removeClass('d-none');
                        } else {
                            $('#new-f-cross-reference-box').addClass('d-none');
                        }

                        if (['text', 'large_text', 'html'].includes(selection)) {
                            $('#new-f-synonym-div').removeClass('d-none');
                        } else {
                            $('#new-f-synonym-div').addClass('d-none');
                        }
                    });

                    // FIELD INDEXED CHECK CHANGE
                    $('#new-f-indexed-checkbox').change(function () {
                        if ($(this).is(':checked') && $('#new-f-indexed-with-box option').length > 0) {
                            $('#new-f-indexed-with-div').removeClass('d-none');
                            $('#new-f-indexed-with-div').addClass('d-flex');
                        } else {
                            $('#new-f-indexed-with-div').removeClass('d-flex');
                            $('#new-f-indexed-with-div').addClass('d-none');
                        }
                    });

                    // FIELD UNIQUE CHECK CHANGE
                    $('#new-f-unique-checkbox').change(function () {
                        if ($(this).is(':checked') && $('#new-f-unique-with-box option').length > 0) {
                            $('#new-f-unique-with-div').removeClass('d-none');
                            $('#new-f-unique-with-div').addClass('d-flex');
                        } else {
                            $('#new-f-unique-with-div').removeClass('d-flex');
                            $('#new-f-unique-with-div').addClass('d-none');
                        }
                    });

                    // CREATE FIELD BUTTON CLICK
                    $('#new-f-create-button').click(function () {
                        let synonym_file = $('#new-f-synonym-box').val();
                        let cross_reference_type = '';
                        if ($('#new-f-type-box').val() == 'cross_reference') {
                            cross_reference_type = $('#new-f-cross-reference-box').val();
                        }

                        let field = {
                            name: $('#new-f-name-box').val(),
                            label: $('#new-f-label-box').val(),
                            in_lists: $('#new-f-in-lists-checkbox').is(':checked'),
                            indexed: $('#new-f-indexed-checkbox').is(':checked'),
                            indexed_with: $('#new-f-indexed-with-box').val(),
                            unique: $('#new-f-unique-checkbox').is(':checked'),
                            unique_with: $('#new-f-unique-with-box').val(),
                            multiple: $('#new-f-multiple-checkbox').is(':checked'),
                            cross_reference_type: cross_reference_type,
                            synonym_file: synonym_file !== 'None' ? synonym_file : null,
                            type: $('#new-f-type-box').val(),
                        };

                        let ct_name = $('#new-f-ct-name').val();
                        let f_index = $('#new-f-f-id').val();
                        let action = $('#new-f-action').val();

                        if (action === 'create' && f_index === 'new') {
                            corpus.content_types[ct_name].fields.push(field);
                            manage_field(ct_name, corpus.content_types[ct_name].fields.length - 1);
                        } else {
                            f_index = parseInt(f_index);
                            corpus.content_types[ct_name].fields[f_index] = field;
                            manage_field(ct_name, f_index);
                        }

                        $('#new-f-modal').modal('hide');
                    });

                    // TEMPLATE SAVE BUTTON
                    $(`#template-save-button`).click(function () {
                        let ct_name = $('#template-ct-name').val();
                        let template_name = $('#template-name').val();
                        let is_new = $('#template-is-new').val();

                        if (is_new === 'yes') {
                            corpus.content_types[ct_name].templates[template_name] = {
                                template: template_editor.getValue(),
                                mime_type: $('#template-mime-type').val()
                            };
                        }
                        else {
                            corpus.content_types[ct_name].templates[template_name].template = template_editor.getValue();
                            corpus.content_types[ct_name].templates[template_name].mime_type = $('#template-mime-type').val();
                        }

                        $('#template-modal').modal('hide');
                    });

                    // BUILD CONTENT TABLES AND SETUP CONTENT TYPE MANAGER
                    if (corpus.content_types) {
                        $('#tm-ct-group').html('');
                    }

                    // HANDLE CORPUS DELETION EVENTS
                    $('#corpus-show-delete-confirmation-button').click(function () {
                        $('#corpus-deletion-name-span').html(corpus.name);
                        if ($(this).html() === "Delete Corpus") {
                            $('#corpus-deletion-confirmation-div').removeClass('d-none');
                            $(this).html("Cancel Corpus Deletion");
                        } else {
                            $('#corpus-deletion-confirmation-div').addClass('d-none');
                            $(this).html("Delete Corpus");
                        }
                    });

                    $('#corpus-delete-button').click(function () {
                        $('#corpus-deletion-form').submit();
                    });
                }

                // load first pages of 5 items for each content type; setup content type nav
                let breadcrumb = $('#breadcrumb');
                let breadcrumb_inner = $('#breadcrumb-inner');
                let ct_nav = `
                    <ul class="nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle p-0 mr-2" id="ct_nav_dropdown" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Content Types</a>
                            <div class="dropdown-menu" aria-labelledby="ct_nav_dropdown">
                `;
                for (let ct_name in corpus.content_types) {
                    let content_table = new ContentTable({
                        container_id: 'content-types-div',
                        corpora: corpora,
                        corpus: corpus,
                        content_type: ct_name
                    });

                    if (role === 'Editor' || role === 'Admin') {
                        manage_content_type(ct_name);
                    }

                    let ct_plural_name = corpus.content_types[ct_name].plural_name;
                    if (corpus.content_types[ct_name].show_in_nav) {
                        ct_nav += `<a class="dropdown-item" href="#${ct_plural_name}">${ct_plural_name}</a>`;
                    }
                }
                ct_nav += `</div></li>`;
                if (role === 'Editor' || role === 'Admin') {
                    ct_nav += `
                        <li class="nav-item">
                            <a class="nav-link p-0" href="#ct_manager_div">Content Type Manager</a>
                        </li>
                    `;
                }
                ct_nav += `</ul>`;
                breadcrumb_inner.append(ct_nav);
                breadcrumb_inner.css('overflow', 'unset');
                breadcrumb.removeClass('d-none');
                breadcrumb.css('position', 'fixed');

                // SETUP JOBS
                corpora.get_jobsites(function (jobsites_data) {
                    jobsites = jobsites_data;

                    if (role === 'Editor' || role === 'Admin') {
                        let jobsite_selector = $('#jobsite-selector');

                        for (let x = 0; x < jobsites.length; x++) {
                            if (role === 'Admin' || available_jobsites.includes(_id(jobsites[x]))) {
                                jobsite_selector.append(`
                                    <option value="${_id(jobsites[x])}" class="${jobsites[x]["type"]}">
                                        ${jobsites[x]["name"]}
                                    </option>
                                `);
                                if (jobsites[x].name === 'Local') {
                                    local_jobsite_id = _id(jobsites[x]);
                                }
                            }
                        }
                    }

                    corpora.get_tasks('Corpus', function (tasks_data) {
                        tasks = tasks_data.filter(function (value, index, arr) {
                            return value.track_provenance;
                        });

                        if (role === 'Editor' || role === 'Admin') {
                            load_tasks(local_jobsite_id);
                            $("#jobsite-selector").on("change", function () {
                                load_tasks($('#jobsite-selector :selected').val());
                            });

                            $('#run-job-button').click(function () {
                                $('#job-modal').modal();
                            });

                            $('#job-submit-button').click(function () {
                                $('#job-form').submit();
                            });

                            $('#launch-notebook-button').click(function () {
                                $('#launch-notebook-form').submit();
                            })
                        }
                    });
                });

                // CONTENT DELETION BUTTON
                $('#deletion-confirmation-button').click(function() {
                    let multi_form = $('#multiselect-form');
                    multi_form.append(`
                        <input type='hidden' name='deletion-confirmed' value='y'/>
                    `);
                    multi_form.attr('action', '');
                    multi_form.submit();
                });

                let scroll_location = location.hash;
                location.hash = '';
                location.hash = scroll_location;
            });

            hide_loading_overlay();
        });

        function manage_content_type(ct_name) {
            let ct_div_prefix = `tm-ct-${ct_name}`;

            if ($(`#${ct_div_prefix}-container`).length === 0) {
                let delete_or_lock_button = `<button id="${ct_div_prefix}-delete-button" class="btn btn-sm btn-danger" data-toggle="tooltip" data-placement="top" title="Delete"><span class="fas fa-trash-alt"></span></button>`;
                if (corpus.content_types[ct_name].inherited) {
                    delete_or_lock_button = `<button class="btn btn-sm btn-danger" disabled><span class="fas fa-lock"></span></button>`;
                }

                $('#tm-ct-group').append(`
                    <div id="${ct_div_prefix}-container" class="list-group-item content-type">
                        <button id="${ct_div_prefix}-button" class="btn btn-sm btn-link" data-toggle="collapse" data-target="#${ct_div_prefix}" aria-expanded="false" aria-controls="${ct_div_prefix}">
                            <span id="${ct_div_prefix}-indicator" class="fas fa-caret-right"></span>
                            <h5 id="${ct_div_prefix}-name" style="display: inline;">${ct_name}</h5>
                        </button>
                        <span class="float-right">
                            <button id="${ct_div_prefix}-edit-button" class="btn btn-sm btn-primary" data-toggle="tooltip" data-placement="top" title="Edit"><span class="fas fa-edit"></span></button>
                            <button id="${ct_div_prefix}-reindex-button" class="btn btn-sm btn-primary" data-toggle="tooltip" data-placement="top" title="Re-Index"><span class="fas fa-sync"></span></button>
                            <button id="${ct_div_prefix}-relabel-button" class="btn btn-sm btn-primary" data-toggle="tooltip" data-placement="top" title="Re-Label"><span class="fas fa-tag"></span></button>
                            ${delete_or_lock_button}
                        </span>
                        <div id="${ct_div_prefix}" class="alert alert-info collapse p-3 mt-2" aria-labelledby="${ct_div_prefix}-container" data-parent="#tm-ct-group">
                            <h5 class="mb-2">Fields</h5>
                            <table class="table table-striped">
                                <thead class="thead-dark">
                                    <th scope="col">Name</th>
                                    <th scope="col">Label</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">In Lists?</th>
                                    <th scope="col">Indexed?</th>
                                    <th scope="col">Unique?</th>
                                    <th scope="col">Multiple?</th>
                                    <th scope="col"></th>
                                </thead>
                                <tbody id="${ct_div_prefix}-f-table">
                                    <tr><td colspan="8">No fields have been defined.</td></tr>
                                </tbody>
                            </table>
                            <button type="button" class="btn btn-primary" id="${ct_div_prefix}-new-f-button">New Field</button>
                            <span class="ml-2">
                                Edit Template: <select id="${ct_div_prefix}-edit-template-selector"></select>
                                <button type="button" class="btn btn-sm btn-secondary ml-2" id="${ct_div_prefix}-edit-template-button">Go</button>
                                <button type="button" class="btn btn-sm btn-secondary ml-2" id="${ct_div_prefix}-new-template-button">New Template</button>
                            </span>
                        </div>
                    </div>
                `);

                // SETUP TEMPLATE SELECTION FOR TEMPLATE EDITOR
                for (let template in corpus.content_types[ct_name].templates) {
                    $(`#${ct_div_prefix}-edit-template-selector`).append(`
                        <option value="${template}">${template}</option>
                    `);
                }

                // SETUP COLLAPSE ICONS
                $(`#${ct_div_prefix}`).on('show.bs.collapse', function (event) {
                    let indicator = $(`#${ct_div_prefix}-indicator`);
                    indicator.removeClass("fa-caret-right");
                    indicator.addClass("fa-caret-down");
                });
                $(`#${ct_div_prefix}`).on('hidden.bs.collapse', function (event) {
                    let indicator = $(`#${ct_div_prefix}-indicator`);
                    indicator.removeClass("fa-caret-down");
                    indicator.addClass("fa-caret-right");
                });

                // ADD CONTENT TYPE TO CROSS REFERENCE OPTIONS
                $('#new-f-cross-reference-box').append(`
                    <option value='${ct_name}'>${ct_name}</option>
                `);

                // EDIT CONTENT TYPE BUTTON
                $(`#${ct_div_prefix}-edit-button`).click(function() {
                    $('#new-ct-modal-label').html('Edit Content Type');

                    $('#new-ct-name').val(ct_name);
                    $('#new-ct-name-box').val(corpus.content_types[ct_name].name);
                    $('#new-ct-name-box').prop('disabled', true);
                    $('#new-ct-plural-name-box').val(corpus.content_types[ct_name].plural_name);
                    $('#new-ct-nav-checkbox').prop('checked', corpus.content_types[ct_name].show_in_nav);

                    let has_xrefs = false;
                    let proxy_field_selector = $('#new-ct-proxy-field-selector');
                    let proxy_field_div = $('#new-ct-proxy-field-div');
                    proxy_field_selector.html('');
                    proxy_field_selector.append(`
                        <option value=''>None</option>
                    `);
                    for (let x = 0; x < corpus.content_types[ct_name].fields.length; x++) {
                        if (corpus.content_types[ct_name].fields[x].type === 'cross_reference') {
                            has_xrefs = true;
                            proxy_field_selector.append(`
                                <option value='${corpus.content_types[ct_name].fields[x].name}'>${corpus.content_types[ct_name].fields[x].label}</option>
                            `);
                        }
                    }
                    proxy_field_selector.val(corpus.content_types[ct_name].proxy_field);
                    if (has_xrefs) { proxy_field_div.removeClass('d-none'); } else { proxy_field_div.addClass('d-none'); }

                    $('#new-ct-modal').modal();
                });

                // REINDEX CONTENT TYPE BUTTPN
                $(`#${ct_div_prefix}-reindex-button`).click(function() {
                    $('#confirmation-ct-name').val(ct_name);
                    $('#confirmation-field-index').val('');
                    $('#confirmation-field-name').val('');
                    $('#confirmation-action').val('reindex');
                    $('#confirmation-confirm-button').attr('disabled', false);
                    $('#confirmation-modal-label').html('Confirm Re-indexing');

                    let message = `You are attempting to re-index the <b>${ct_name}</b> content type.
                    Depending on how much content belongs to this type, this may take a long time, and
                    while re-indexing is taking place, the content will be temporarily unavailable in
                    lists. Do you wish to proceed?`;

                    $('#confirmation-modal-message').html(message);
                    $('#confirmation-modal').modal();
                });

                // REINDEX CONTENT TYPE BUTTON
                $(`#${ct_div_prefix}-relabel-button`).click(function() {
                    $('#confirmation-ct-name').val(ct_name);
                    $('#confirmation-field-index').val('');
                    $('#confirmation-field-name').val('');
                    $('#confirmation-action').val('relabel');
                    $('#confirmation-confirm-button').attr('disabled', false);
                    $('#confirmation-modal-label').html('Confirm Re-Labeling');

                    let message = `You are attempting to re-label content belonging to the <b>${ct_name}</b> content type.
                    Depending on how much content belongs to this type, this may take a long time. Do you wish to proceed?`;

                    $('#confirmation-modal-message').html(message);
                    $('#confirmation-modal').modal();
                });

                // DELETE CONTENT TYPE BUTTON
                $(`#${ct_div_prefix}-delete-button`).click(function() {
                    if (!corpus.content_types[ct_name].inherited) {
                        if (!corpus.content_types[ct_name].hasOwnProperty('is_new')) {
                            $('#confirmation-ct-name').val(ct_name);
                            $('#confirmation-field-index').val('');
                            $('#confirmation-field-name').val('');
                            $('#confirmation-action').val('delete');
                            $('#confirmation-confirm-button').attr('disabled', false);
                            $('#confirmation-modal-label').html('Confirm Deletion');


                            let message = `You are attempting to delete the <b>${ct_name}</b> content type.
                            Upon doing so, <b>all content of this type will be irreversibly deleted</b>. Some templates may also need to be
                            regenerated or manually adjusted. Are you sure you want to proceed?`;

                            let referencing_fields = [];
                            for (let x in corpus.content_types) {
                                for (let y = 0; y < corpus.content_types[x].fields.length; y++) {
                                    if (corpus.content_types[x].fields[y].cross_reference_type === ct_name) {
                                        referencing_fields.push(`${x} -> ${corpus.content_types[x].fields[y].name}`);
                                    }
                                }
                            }

                            if (referencing_fields.length > 0) {
                                message = `
                                    You are attempting to delete the ${ct_name} content type.
                                    This is currently not possible, as the following fields reference this content type:<ul class="mt-2">
                                `;
                                referencing_fields.map(x => message += `<li>${x}</li>`);
                                message += `
                                    </ul>If you still wish to delete the ${ct_name} content type,
                                    you must first delete the above fields.
                                `;
                                $('#confirmation-confirm-button').attr('disabled', true);
                            }

                            $('#confirmation-modal-message').html(message);
                            $('#confirmation-modal').modal();
                        } else {
                            delete corpus.content_types[ct_name];
                            $(`#${ct_div_prefix}-container`).remove();
                        }
                    }
                });

                // NEW FIELD BUTTON
                $(`#${ct_div_prefix}-new-f-button`).click(function (){
                    $('#new-f-modal-label').html('Create New Field');
                    $('#new-f-ct-name').val(ct_name);
                    $('#new-f-f-id').val('new');
                    $('#new-f-action').val('create');
                    $('#new-f-name-box').val('');
                    $('#new-f-name-box').prop('disabled', false);
                    $('#new-f-label-box').val('');
                    $('#new-f-type-box').val('keyword');
                    $('#new-f-synonym-box').val('None');
                    $('#new-f-synonym-div').addClass('d-none');
                    $('#new-f-in-lists-checkbox').prop('checked', true);
                    $('#new-f-indexed-checkbox').prop('checked', false);
                    $('#new-f-unique-checkbox').prop('checked', false);
                    $('#new-f-multiple-checkbox').prop('checked', false);
                    $('#new-f-create-button').html('Create');

                    $('.f-with').html('');
                    for (let x = 0; x < corpus.content_types[ct_name].fields.length; x++) {
                        $('.f-with').append(`
                            <option value='${corpus.content_types[ct_name].fields[x].name}'>${corpus.content_types[ct_name].fields[x].label}</option>
                        `);
                    }

                    $('#new-f-indexed-with-box').val([]);
                    $('#new-f-indexed-with-div').removeClass('d-flex');
                    $('#new-f-indexed-with-div').addClass('d-none');
                    $('#new-f-unique-with-box').val([]);
                    $('#new-f-unique-with-div').removeClass('d-flex');
                    $('#new-f-unique-with-div').addClass('d-none');
                    $('#new-f-cross-reference-box').addClass('d-none');

                    $('#new-f-create-button').html('Create');
                    $('#new-f-modal').modal();
                });

                // EDIT TEMPLATE BUTTON
                $(`#${ct_div_prefix}-edit-template-button`).click(function (){
                    let template_name = $(`#${ct_div_prefix}-edit-template-selector`).val();
                    $('#template-ct-name').val(ct_name);
                    $('#template-is-new').val('no');
                    $('#template-name').val(template_name);

                    template_editor.setValue(corpus.content_types[ct_name].templates[template_name].template);
                    $('#template-mime-type').val(corpus.content_types[ct_name].templates[template_name].mime_type);

                    $('#template-modal').modal();
                });

                // NEW TEMPLATE BUTTON
                $(`#${ct_div_prefix}-new-template-button`).click(function (){
                    $('#template-ct-name').val(ct_name);
                    $('#template-is-new').val('yes');
                    $('#template-name').val('NewTemplate');

                    template_editor.setValue('');
                    $('#template-mime-type').val('text/html');

                    $('#template-modal').modal();
                });

                // FOCUS TEMPLATE EDITOR ON MODAL SHOWN EVENT
                $('#template-modal').on('shown.bs.modal', function() {
                    template_editor.focus();
                    template_editor.gotoLine(1);
                });

                // ADD FIELDS
                for (let f_index = 0; f_index < corpus.content_types[ct_name].fields.length; f_index++) {
                    if (f_index === 0) {
                        $(`#${ct_div_prefix}-f-table`).html('');
                    }
                    manage_field(ct_name, f_index);
                }
            }
        }

        function manage_field(ct_name, f_index) {
            let ct = corpus.content_types[ct_name];
            let f_table = $(`#tm-ct-${ct_name}-f-table`);
            let f_div_prefix = `tm-ct-${ct_name}-f-${f_index}`;
            let field_type_display = '';
            switch (ct.fields[f_index].type) {
                case 'cross_reference':
                    field_type_display = ct.fields[f_index].cross_reference_type;
                    break;
                case 'text':
                    field_type_display = 'Text';
                    let syn_file_key = ct.fields[f_index].synonym_file;
                    if (syn_file_key) {
                        field_type_display += ` (${corpus.available_synonyms[syn_file_key].label})`;
                    }
                    break;
                default:
                    field_type_display = FIELD_TYPE_LABELS[ct.fields[f_index].type];
                    break;
            }

            let indexed_display = ct.fields[f_index].indexed ? 'Y' : 'N';
            if (ct.fields[f_index].indexed_with.length > 0) {
                indexed_display += '['
                for (let x = 0; x < ct.fields[f_index].indexed_with.length; x++) {
                    indexed_display += ct.fields[f_index].indexed_with[x] + ', ';
                }
                indexed_display = indexed_display.slice(0, -2) + ']';
            }

            let unique_display = ct.fields[f_index].unique ? 'Y' : 'N';
            if (ct.fields[f_index].unique_with.length > 0) {
                unique_display += '['
                for (let x = 0; x < ct.fields[f_index].unique_with.length; x++) {
                    unique_display += ct.fields[f_index].unique_with[x] + ', ';
                }
                unique_display = unique_display.slice(0, -2) + ']';
            }

            if ($(`#${f_div_prefix}-row`).length === 0) {
                // Clear "No fields defined message"
                if (ct.fields.length === 1) {
                    f_table.html('');
                }

                let delete_or_lock_button = `<button type="button" class="btn btn-sm btn-danger m-1" id="${f_div_prefix}-delete-button"><span class="fas fa-trash-alt"></span></button>`;
                if (ct.fields[f_index].inherited) {
                    delete_or_lock_button = `<button type="button" class="btn btn-sm btn-danger m-1" disabled><span class="fas fa-lock"></button>`;
                }

                f_table.append(`
                    <tr id="${f_div_prefix}-row">
                        <td id="${f_div_prefix}-name" class="font-weight-bold">${ct.fields[f_index].name}</td>
                        <td id="${f_div_prefix}-label">${ct.fields[f_index].label}</td>
                        <td id="${f_div_prefix}-type">${field_type_display}</td>
                        <td id="${f_div_prefix}-in-lists">${ct.fields[f_index].in_lists ? 'Y' : 'N'}</td>
                        <td id="${f_div_prefix}-indexed">${indexed_display}</td>
                        <td id="${f_div_prefix}-unique">${unique_display}</td>
                        <td id="${f_div_prefix}-multiple">${ct.fields[f_index].multiple ? 'Y' : 'N'}</td>
                        <td id="${f_div_prefix}-actions">
                            <div class="d-flex flex-wrap flex-row">
                                <button type="button" class="btn btn-sm btn-primary m-1" id="${f_div_prefix}-edit-button"><span class="fas fa-edit"></span></button>
                                ${delete_or_lock_button}
                                <button type="button" class="btn btn-sm btn-danger m-1" id="${f_div_prefix}-shift-up-button"><span class="fas fa-caret-up"></span></button>
                            </div>
                        </td>
                    </tr>
                `);

                // EDIT FIELD BUTTON CLICK
                $(`#${f_div_prefix}-edit-button`).click(function () {
                    $('#new-f-modal-label').html('Edit Field');
                    $('#new-f-ct-name').val(ct_name);
                    $('#new-f-f-id').val(f_index);
                    $('#new-f-action').val('edit');
                    $('#new-f-name-box').val(ct.fields[f_index].name);
                    $('#new-f-name-box').prop('disabled', true);
                    $('#new-f-label-box').val(ct.fields[f_index].label);
                    $('#new-f-type-box').val(ct.fields[f_index].type);

                    if (ct.fields[f_index].type === 'cross_reference') {
                        $('#new-f-cross-reference-box').removeClass('d-none');
                        $('#new-f-cross-reference-box').val(ct.fields[f_index].cross_reference_type);
                    } else {
                        $('#new-f-cross-reference-box').addClass('d-none');
                    }

                    $('#new-f-synonym-box').val(ct.fields[f_index].synonym_file == null ? 'None' : ct.fields[f_index].synonym_file);
                    if (['text', 'large_text', 'html'].includes(ct.fields[f_index].type)) {
                        $('#new-f-synonym-div').removeClass('d-none');
                    } else {
                        $('#new-f-synonym-div').addClass('d-none');
                    }

                    $('.f-with').html('');
                    for (let x = 0; x < ct.fields.length; x++) {
                        if (ct.fields[x].name !== ct.fields[f_index].name) {
                            $('.f-with').append(`
                                <option value='${ct.fields[x].name}'>${ct.fields[x].label}</option>
                            `);
                        }
                    }

                    $('#new-f-indexed-checkbox').prop('checked', ct.fields[f_index].indexed);
                    $('#new-f-indexed-with-box').val(ct.fields[f_index].indexed_with);
                    if (ct.fields[f_index].indexed) {
                        $('#new-f-indexed-with-div').addClass('d-flex');
                        $('#new-f-indexed-with-div').removeClass('d-none');
                    } else {
                        $('#new-f-indexed-with-div').removeClass('d-flex');
                        $('#new-f-indexed-with-div').addClass('d-none');
                    }

                    $('#new-f-unique-checkbox').prop('checked', ct.fields[f_index].unique);
                    $('#new-f-unique-with-box').val(ct.fields[f_index].unique_with);
                    if (ct.fields[f_index].unique) {
                        $('#new-f-unique-with-div').addClass('d-flex');
                        $('#new-f-unique-with-div').removeClass('d-none');
                    } else {
                        $('#new-f-unique-with-div').removeClass('d-flex');
                        $('#new-f-unique-with-div').addClass('d-none');
                    }

                    $('#new-f-in-lists-checkbox').prop('checked', ct.fields[f_index].in_lists);
                    $('#new-f-multiple-checkbox').prop('checked', ct.fields[f_index].multiple);
                    $('#new-f-create-button').html('Edit');

                    if (ct.fields[f_index].inherited) {
                        $('#new-f-type-box').attr('disabled', true);
                        $('#new-f-indexed-checkbox').attr('disabled', true);
                        $('#new-f-unique-checkbox').attr('disabled', true);
                        $('#new-f-multiple-checkbox').attr('disabled', true);
                    } else {
                        $('#new-f-type-box').attr('disabled', false);
                        $('#new-f-indexed-checkbox').attr('disabled', false);
                        $('#new-f-unique-checkbox').attr('disabled', false);
                        $('#new-f-multiple-checkbox').attr('disabled', false);
                    }

                    $('#new-f-modal').modal();
                });

                // FIELD DELETE BUTTON CLICK
                $(`#${f_div_prefix}-delete-button`).click(function () {
                    if (!ct.fields[f_index].inherited) {
                        $('#confirmation-ct-name').val(ct_name);
                        $('#confirmation-field-name').val(ct.fields[f_index].name);
                        $('#confirmation-action').val('delete');
                        $('#confirmation-confirm-button').attr('disabled', false);

                        let message = `You are attempting to delete the <b>${ct_name} -> ${ct.fields[f_index].name}</b> field.
                        Upon doing so, <b>all content stored in this field will be irreversibly deleted</b>. Some templates may also need to be
                        regenerated or manually adjusted. Are you sure you want to proceed?`;

                        if (ct.fields.length === 1) {
                            message = `You are attempting to delete the <b>${ct_name} -> ${ct.fields[f_index].name}</b> field.
                        This is currently not possible, as all content types must have at least one field. Please create another field for
                        this content type before deleting this field.`;
                            $('#confirmation-confirm-button').attr('disabled', true);
                        }

                        $('#confirmation-modal-message').html(message);
                        $('#confirmation-modal').modal();
                    }
                });

                // FIELD SHIFT UP BUTTON
                $(`#${f_div_prefix}-shift-up-button`).click(function () {
                    $('#confirmation-ct-name').val(ct_name);
                    $('#confirmation-field-name').val(ct.fields[f_index].name);
                    $('#confirmation-action').val('shift_up');
                    $('#confirmation-confirm-button').attr('disabled', false);

                    let message = `You are attempting to shift the <b>${ct_name} -> ${ct.fields[f_index].name}</b> field up
                    in position. This will affect the order in which fields appear in lists, views, etc. Are you sure you want to proceed?`;

                    if (f_index === 0) {
                        message = `You are attempting to shift the <b>${ct_name} -> ${ct.fields[f_index].name}</b> field up
                        in position. This is currently not possible, as that field already occupies the first position.`;
                        $('#confirmation-confirm-button').attr('disabled', true);
                    }

                    $('#confirmation-modal-message').html(message);
                    $('#confirmation-modal').modal();
                });
            } else {
                $(`#${f_div_prefix}-name`).html(ct.fields[f_index].name);
                $(`#${f_div_prefix}-label`).html(ct.fields[f_index].label);
                $(`#${f_div_prefix}-type`).html(field_type_display);
                $(`#${f_div_prefix}-indexed`).html(indexed_display);
                $(`#${f_div_prefix}-unique`).html(unique_display);
                $(`#${f_div_prefix}-in-lists`).html(ct.fields[f_index].in_lists ? 'Y' : 'N');
                $(`#${f_div_prefix}-multiple`).html(ct.fields[f_index].multiple ? 'Y' : 'N');
            }
        }

        // FILE UPLOAD FUNCTIONALITY
        $('#import-corpus-files-button').click(function() {
            upload_file();
        });

        function upload_file(path='', filter='', select='file') {
            corpora.get_corpus_files(corpus_id, path, filter, function (data) {
                file_upload_path = path;

                let url = `/api/corpus/${corpus_id}/files/`;

                import_corpus_file_pond.setOptions({
                    server: {
                        process: {
                            url: `${url}?path=${path}`,
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}'
                            }
                        },
                        fetch: null,
                        revert: null
                    }
                });
                import_corpus_file_pond.removeFiles();
                file_uploads = [];

                $('#file-upload-modal-table-body').html('');
                $('#file-upload-modal-table-header').html(path + '/');
                if (path) {
                    let up_directory = '/' + path.split('/').slice(1, -1).join('/');
                    if (up_directory === '/') { up_directory = ''; }
                    if (select === 'file') {
                        $('#file-upload-modal-table-header').append(`<a href="javascript:upload_file('${up_directory}');" style="color: white;"><span class="fas fa-level-up-alt float-right"></span></a>`);
                    } else {
                        $('#file-upload-modal-table-header').append(`<a href="javascript:upload_file('${up_directory}', '', 'dir');" style="color: white;"><span class="fas fa-level-up-alt float-right"></span></a>`);
                    }
                }
                for (let x = 0; x < data.length; x++) {
                    if(select === 'file') {
                        if (data[x].type === 'file') {
                            $('#file-upload-modal-table-body').append(`
                                <tr><td>${data[x].filename}</td></tr>
                            `);
                        } else {
                            $('#file-upload-modal-table-body').append(`
                                <tr><td><span class="fas fa-folder-open"></span> ${data[x].filename} <a class="btn btn-sm btn-primary text-white float-right" role="button" href="javascript:upload_file('${data[x].path}');">Browse</a></td></tr>
                            `);
                        }
                    } else {
                        if (data[x].type === 'dir') {
                            $('#file-upload-modal-table-body').append(`
                                <tr><td><span class="fas fa-folder-open"></span> <a href="javascript:handle_file_upload('${data[x].path}', '');">${data[x].filename}</a> <a class="btn btn-sm btn-primary text-white float-right" role="button" href="javascript:upload_file(file_upload_input_id, '${data[x].path}', '', 'dir');">Browse</a></td></tr>
                            `);
                        }
                    }
                }

                $('#file-upload-modal').modal();
            });
        }

        function handle_folder_creation() {
            let dirname = pep8_variable_format($('#file-upload-modal-new-folder-box').val());
            corpora.make_corpus_file_dir(corpus_id, file_upload_path, dirname, function() {
                $('#file-upload-modal-new-folder-box').val('');
                upload_file(path=file_upload_path);
            });
        }

        $('#file-upload-reset-button').click(function() {
            let import_button = $('#file-upload-import-button');

            import_files = [];
            import_button.html('Import');
            import_button.attr('disabled', true);
        });

        $('#file-upload-import-button').click(function() {
            $('#import-corpus-files').val(JSON.stringify(import_files));
            $('#import-corpus-files-form').submit();
        });

        // JOB FUNCTIONALITY
        function load_tasks(jobsite_id) {
            let task_selector = $('#task-selector');
            task_selector.html('');

            for (let js_index = 0; js_index < jobsites.length; js_index ++) {
                if (_id(jobsites[js_index]) === jobsite_id) {
                    let jobsite_type = jobsites[js_index].type;
                    let tasks_populated = 0;
                    for (let t_index = 0; t_index < tasks.length; t_index ++) {
                        if(tasks[t_index].jobsite_type === jobsite_type) {
                            task_selector.append(`
                                <option value="${_id(tasks[t_index])}">
                                    ${tasks[t_index]["name"]}
                                </option>
                            `);

                            if (tasks_populated === 0) {
                                load_task_parameters(tasks[t_index]);
                            }
                            tasks_populated += 1;
                        }
                    }

                    if (tasks_populated > 0) {
                        $(`#task-selector-div`).removeClass("d-none");
                        $(`#job-submit-button`).attr('disabled', false);
                    } else {
                        $(`#task-selector-div`).addClass("d-none");
                        $(`#job-submit-button`).attr('disabled', true);
                    }
                }
            }

            $('#task-selector').change(function() {
                let selected_task_id = $('#task-selector').val();
                for (let t_index = 0; t_index < tasks.length; t_index++) {
                    if (_id(tasks[t_index]) === selected_task_id) {
                        load_task_parameters(tasks[t_index]);
                    }
                }
            });
        }

        function load_task_parameters(task) {
            $('#task-parameters-div').html('');

            let parameters = task['configuration']['parameters'];
            for (let parameter in parameters) {
                if (parameters[parameter].hasOwnProperty('type')) {
                    let parameter_html = '';
                    let note_html = '';
                    if (parameters[parameter].hasOwnProperty('note')) {
                        note_html = `<span class='text-muted'>${parameters[parameter]['note']}</span>`;
                    }

                    if (parameters[parameter]['type'] === 'corpus_file') {
                        let select_options = '';
                        Object.keys(corpus.files).forEach(file_key => {
                            select_options += `<option value="${file_key}">${corpus.files[file_key].basename}</option>`;
                        });

                        parameter_html = `
                            <div class="form-group">
                                <label for="${parameter}-file-selector">${parameters[parameter]['label']}</label>
                                <select id="${parameter}-file-selector" class="form-control" name="${parameter}">
                                    ${select_options}
                                </select>
                                ${note_html}
                            </div>
                        `;
                    } else if (parameters[parameter]['type'] === 'content_type') {
                        let select_options = '';
                        Object.keys(corpus.content_types).forEach(ct => {
                            select_options += `<option value="${ct}">${corpus.content_types[ct].name}</option>`;
                        });

                        parameter_html = `
                            <div class="form-group">
                                <label for="${parameter}-ct-selector">${parameters[parameter]['label']}</label>
                                <select id="${parameter}-ct-selector" class="form-control" name="${parameter}">
                                    ${select_options}
                                </select>
                                ${note_html}
                            </div>
                        `;
                    } else if (parameters[parameter]['type'] === 'content_type_field') {
                        let select_options = '';
                        Object.keys(corpus.content_types).forEach(ct => {
                            corpus.content_types[ct].fields.map(f => {
                                select_options += `<option value="${ct}->${f.name}">${ct} -> ${f.label}</option>`;
                            });
                        });

                        parameter_html = `
                            <div class="form-group">
                                <label for="${parameter}-ct-field-selector">${parameters[parameter]['label']}</label>
                                <select id="${parameter}-ct-field-selector" class="form-control" name="${parameter}">
                                    ${select_options}
                                </select>
                                ${note_html}
                            </div>
                        `;
                    } else if (parameters[parameter]['type'] === 'boolean') {
                        let checked = parameters[parameter]['value'] ? 'checked' : '';

                        parameter_html = `
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="${parameter}-boolean-checkbox" name="${parameter}" ${checked}>
                                <label class="form-check-label" for="${parameter}-boolean-checkbox">${parameters[parameter]['label']}</label>
                            </div>
                        `;
                    } else if (parameters[parameter]['type'] === 'choice' && parameters[parameter].hasOwnProperty('choices')) {
                        let select_options = '';
                        parameters[parameter]['choices'].forEach(choice => {
                            select_options += `<option>${choice}</option>\n`;
                        });

                        parameter_html = `
                            <div class="form-group">
                                <label for="${parameter}-choice-selector">${parameters[parameter]['label']}</label>
                                <select id="${parameter}-choice-selector" class="form-control" name="${parameter}">
                                    ${select_options}
                                </select>
                                ${note_html}
                            </div>
                        `;
                    } else if (parameters[parameter]['type'] === 'pep8_text') {
                        parameter_html = `
                            <div class="form-group">
                                <label for="${parameter}-pep8-text-box">${parameters[parameter]['label']}</label>
                                <input type="text" class="form-control" id="${parameter}-pep8-text-box" name="${parameter}" />
                                ${note_html}
                            </div>
                        `;
                    } else if (parameters[parameter]['type'] === 'text') {
                        parameter_html = `
                            <div class="form-group">
                                <label for="${parameter}-text-box">${parameters[parameter]['label']}</label>
                                <input type="text" class="form-control" id="${parameter}-text-box" name="${parameter}" />
                                ${note_html}
                            </div>
                        `;
                    }

                    $('#task-parameters-div').append(parameter_html);

                    if (parameters[parameter]['type'] === 'pep8_text') {
                        $(`#${parameter}-pep8-text-box`).focusout(function () {
                            let pep8_box = $(`#${parameter}-pep8-text-box`);
                            pep8_box.val(pep8_variable_format(pep8_box.val()));
                        });
                    }
                }
            }
        }
    </script>
{% endblock %}