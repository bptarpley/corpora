{% extends 'base.html' %}
{% load static %}
{% load extras %}

{% block css %}
    <link href="{% static 'css/filepond.css' %}" rel="stylesheet">
    <style type="text/css">
        #settings-editor {
            /* Setting height is important, otherwise editor wont show up */
            height: 300px;
        }
    </style>
{% endblock %}

{% block modals %}
    <!-- UPLOAD CORPUS FILES MODAL -->
    <div class="modal fade" id="file-upload-modal" tabindex="-1" role="dialog" aria-labelledby="file-upload-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="file-upload-modal-label">Import Corpus File(s)</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="import-corpus-files-form" method="post">
                        {% csrf_token %}
                        <input type="hidden" id="import-corpus-files" name="import-corpus-files"/>
                    </form>
                    <div class="alert alert-light">
                        <table class="table table-striped">
                            <thead class="thead-dark">
                                <th scope="col">Path: <span id="file-upload-modal-table-header">/</span></th>
                            </thead>
                            <tbody id="file-upload-modal-table-body">
                                <tr><td>Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <input type="file" class="filepond" id="import-corpus-filepond">
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="input-group">
                                <input type="text" class="form-control" id="file-upload-modal-new-folder-box" aria-placeholder="New Folder" placeholder="New Folder">
                                <span class="input-group-btn ml-1"><a href="javascript:handle_folder_creation();" role="button" id="file-upload-modal-new-folder-button" class="btn btn-secondary">Go</a></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" id="file-upload-reset-button" class="btn btn-secondary">Reset</button>
                    <button type="button" id="file-upload-import-button" class="btn btn-primary" disabled>Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JOB MODAL -->
    <div class="modal fade" id="job-modal" tabindex="-1" role="dialog" aria-labelledby="job-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="job-form" method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="job-modal-label">Run a Job</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="jobsite-selector">Jobsite</label>
                            <select id="jobsite-selector" class="form-control" name="jobsite">
                            </select>
                        </div>
                        <div id="task-selector-div" class="form-group">
                            <label for="task-selector">Task</label>
                            <select id="task-selector" class="form-control" name="task">
                            </select>
                        </div>
                        <div id="task-parameters-div">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="job-submit-button" disabled>Run</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Job Finished Modal -->
    <div class="modal fade" id="job-finished-modal" tabindex="-1" role="dialog" aria-labelledby="job-finished-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="job-finished-modal-label">Job Completed</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        One or more jobs have completed for this document. Click the "Refresh" button below to view results.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="window.location = window.location.href;">Refresh</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENT TYPE MODAL -->
    <div class="modal fade" id="new-ct-modal" tabindex="-1" role="dialog" aria-labelledby="new-ct-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="new-ct-modal-label">Create New Content Type</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="new-ct-name-box">Name</label>
                        <input id="new-ct-name-box" type="text" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="new-ct-plural-name-box">Plural Name</label>
                        <input id="new-ct-plural-name-box" type="text" class="form-control">
                    </div>
                    <div class="form-check">
                        <input id="new-ct-nav-checkbox" type="checkbox" value="" class="form-check-input" checked>
                        <label for="new-ct-nav-checkbox">Include in Navigation?</label>
                    </div>
                    <div id="new-ct-proxy-field-div" class="form-group d-none">
                        <label for="new-ct-proxy-field-selector">Proxy For</label>
                        <select id="new-ct-proxy-field-selector" class="form-control"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="new-ct-create-button">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FIELD MODAL -->
    <div class="modal fade" id="new-f-modal" tabindex="-1" role="dialog" aria-labelledby="new-f-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="new-f-modal-label">Create New Field</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input id="new-f-ct-name" type="hidden" value="new">
                    <input id="new-f-f-id" type="hidden" value="new">
                    <input id="new-f-action" type="hidden" value="create">
                    <div class="form-group">
                        <label for="new-f-name-box">Name</label>
                        <input id="new-f-name-box" type="text" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="new-f-label-box">Label</label>
                        <input id="new-f-label-box" type="text" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="new-f-type-box">Type</label>
                        <select id="new-f-type-box">
                            <option value="text" selected>Text</option>
                            <option value="html">HTML</option>
                            <option value="number">Number</option>
                            <option value="date">Date</option>
                            <option value="link">Link</option>
                            <option value="file">File Upload</option>
                            <option value="cross_reference">Cross Reference</option>
                        </select>
                        <select id="new-f-cross-reference-box" class="d-none">
                            <option value="Document">Document</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input id="new-f-in-lists-checkbox" type="checkbox" value="" class="form-check-input">
                        <label for="new-f-in-lists-checkbox">Include in Lists?</label>
                    </div>
                    <div class="form-check">
                        <input id="new-f-indexed-checkbox" type="checkbox" value="" class="form-check-input">
                        <label for="new-f-indexed-checkbox">Indexed?</label>
                    </div>
                    <div id="new-f-indexed-with-div" class="form-group align-items-start d-none">
                        <label for="new-f-indexed-with-box">with:&nbsp;</label>
                        <select id="new-f-indexed-with-box" class="f-with w-50" multiple>
                            <!-- Populated via Javascript /-->
                        </select>
                    </div>
                    <div class="form-check">
                        <input id="new-f-unique-checkbox" type="checkbox" value="" class="form-check-input">
                        <label for="new-f-unique-checkbox">Unique?</label>
                    </div>
                    <div id="new-f-unique-with-div" class="form-group align-items-start d-none">
                        <label for="new-f-unique-with-box">with:&nbsp;</label>
                        <select id="new-f-unique-with-box" class="f-with w-50" multiple>
                            <!-- Populated via Javascript /-->
                        </select>
                    </div>
                    <div class="form-check">
                        <input id="new-f-multiple-checkbox" type="checkbox" value="" class="form-check-input">
                        <label for="new-f-multiple-checkbox">Multiple?</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="new-f-create-button">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TEMPLATE MODAL -->
    <div class="modal fade" id="template-modal" tabindex="-1" role="dialog" aria-labelledby="template-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="template-modal-label">Edit Template</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="template-ct-name" value="">

                    <div class="form-group">
                        <label for="template-name">Name:</label>
                        <input id="template-name" type="text" class="form-control">
                    </div>

                    <div id="template-editor" style="height: 400px;"></div>

                    <div class="form-group">
                        <label for="template-mime-type">MIME Type</label>
                        <select id="template-mime-type">
                            <option value="text/html">text/html</option>
                            <option value="text/xml">text/xml</option>
                            <option value="application/json">application/json</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="template-save-button">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCHEMA MODAL -->
    <div class="modal fade" id="import-modal" tabindex="-1" role="dialog" aria-labelledby="import-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="import-modal-label">Import Schema</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="import-editor" style="height: 400px;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="import-button">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CONFIRMATION MODAL -->
    <div class="modal fade" id="confirmation-modal" tabindex="-1" role="dialog" aria-labelledby="confirmation-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmation-modal-label">Confirm Deletion</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="confirmation-ct-name" name="content_type" value="">
                        <input type="hidden" id="confirmation-field-index" value="">
                        <input type="hidden" id="confirmation-field-name" name="field" value="">
                        <input type="hidden" id="confirmation-action" name="action" value="">
                        <div id="confirmation-modal-message" class="alert alert-danger"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="confirmation-confirm-button">Confirm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block main %}
        <div class="row mt-4">

            <!-- METADATA -->
            <div class="col-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h4>Metadata</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12">
                                <div id="corpus-metadata-div" class="list-group">
                                    <div class="list-group-item">
                                        <h5>Name</h5>
                                        <span id="corpus-name-span"></span>
                                    </div>
                                    <div class="list-group-item">
                                        <h5>Description</h5>
                                        <span id="corpus-desc-span"></span>
                                    </div>
                                    <div class="list-group-item">
                                        <h5>Path</h5>
                                        <span id="corpus-path-span"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="col-6">
                <!-- JOBS -->
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <h4>Jobs</h4>
                            {% if response.scholar.is_admin or role == 'Editor' %}
                                <button id="run-job-button" class="btn btn-primary rounded" type="button">Run Job</button>
                            {% else %}
                                <span>&nbsp;</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            There are currently no jobs running for this corpus.
                        </div>
                    </div>
                </div>

                <!-- FILES -->
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <h4>Corpus Files</h4>
                            {% if response.scholar.is_admin or role == 'Editor' %}
                                <button id="import-corpus-files-button" class="btn btn-primary rounded" type="button">Import</button>
                            {% else %}
                                <span>&nbsp;</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body" id="corpus-files-div">
                        <div class="alert alert-info">
                            There are currently no files for this corpus.
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div id="content-types-div">

            <!-- CONTENT TYPES LISTED HERE -->

        </div>

        {% if response.scholar.is_admin or role == 'Editor' %}
        <div class="row">
            <!-- CONTENT TYPE MANAGER -->
            <div class="col">
                <div id="type-manager-div" class="card mt-4">
                    <div class="card-header">
                        <h4>Content Type Manager</h4>
                    </div>
                    <div class="card-body">
                        <div class="list-group" id="tm-ct-group">
                            <div class="alert alert-info">No Content Types have been defined.</div>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                        <span>
                            <button type="button" class="btn btn-primary mr-2" id="new-ct-button">New Content Type</button>
                            <button type="button" title="Import Schema" class="btn btn-secondary" id="show-import-modal-button"><span class="fas fa-file-import"></span></button>
                            <a role="button" title="Export Schema" class="btn btn-secondary" href="/corpus/{{ corpus_id }}/?export=schema" download="schema"><span class="fas fa-file-export"></span></a>
                            <button type="button" class="btn btn-secondary ml-2" id="manage-template-formats-button">Manage Template Formats</button>
                        </span>
                        <span>
                            <button type="button" class="btn btn-primary" id="save-content-type-schema-button">Save Changes</button>
                        </span>
                    </div>
                </div>
            </div>
            <form id="ct-schema-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="schema" id="ct-schema" value="">
            </form>
        </div>
        {% endif %}

    {% if response.scholar.is_admin %}
        <div class="row">
            <div class="col">
                <div id="type-manager-div" class="card mt-4">
                    <div class="card-header">
                        <h4>Corpus Management</h4>
                    </div>
                    <div class="card-body">
                        <button type="button" class="btn btn-danger" id="corpus-show-delete-confirmation-button">Delete Corpus</button>
                        <div id="corpus-deletion-confirmation-div" class="alert alert-danger mt-3 d-none">
                            <strong>Warning:</strong> Should you delete this corpus, all data and linkages comprising it
                            will be deleted, and it will only be recoverable via backups. Depending on the size of your corpus,
                            deletion could take some time. <strong>If you are certain you'd like to delete this corpus,
                            type its name (<span id="corpus-deletion-name-span"></span>) in the box below and click the
                            "Delete" button</strong>:

                            <form id="corpus-deletion-form" method="post">
                                {% csrf_token %}
                                <div class="form-group mt-3">
                                    <label for="corpus-deletion-confirmation-box" class="sr-only">Corpus Name</label>
                                    <input type="text" class="form-control" id="corpus-deletion-confirmation-box" name="corpus-deletion-name" placeholder="Corpus Name">
                                </div>
                                <button type="button" class="btn btn-danger" id="corpus-delete-button">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block js %}
    <script src="{% static 'js/filepond.js' %}"></script>
    <script src="{% static 'js/ace/ace.js' %}"></script>
    <script src={% static 'js/beautify/beautify.js' %}></script>
    <script src={% static 'js/beautify/beautify-css.js' %}></script>
    <script src={% static 'js/beautify/beautify-html.js' %}></script>
    <script type="application/javascript">
        var corpus_id = "{{ corpus_id }}";
        var role = "{{ role }}";
        var corpus = null;
        var template_formats = null;
        var jobsites = [];
        var local_jobsite_id = null;
        var tasks = [];
        var check_jobs_timer = null;
        var check_jobs_interval = 10;
        var ct_search = {};
        var selected_content = [];
        var import_editor;
        var template_editor;

        // VARS FOR FILE UPLOADS/IMPORTS
        var file_upload_path = '';
        var file_uploads = [];
        var import_files = [];

        // CREATE FILE POND FOR IMPORT CORPUS FILES MODAL
        const import_corpus_file_pond = FilePond.create(document.querySelector('#import-corpus-filepond'), {
            allowMultiple: true,
            allowRevert: false
        });
        import_corpus_file_pond.on('addfile', (error, file) => {
            if(!error) {
                file_uploads.push(file.filename);
            }
        });
        import_corpus_file_pond.on('processfile', (error, file) => {
            if(!error) {
                import_files.push(`${file_upload_path}/${file.filename}`);
                let import_button = $('#file-upload-import-button');
                import_button.html(`Import ${import_files.length} File(s)`);
                import_button.attr('disabled', false);
                let index = file_uploads.indexOf(file.filename);
                if (index !== -1) { file_uploads.splice(index, 1); }
                if (file_uploads.length === 0) {
                    upload_file(file_upload_path);
                }
            }
        });
        
        const FIELD_TYPE_LABELS = {
            text: 'Text',
            keyword: 'Keyword',
            html: 'HTML',
            choice: 'Choice',
            number: 'Number',
            date: 'Date',
            file: 'File',
            link: 'Link',
            cross_reference: 'Cross Reference',
            embedded: 'Embedded'
        };

        // fires once HTML DOM has loaded
        $(document).ready(function() {
            // query corpora api for corpus data
            corpora.get_corpus(corpus_id, function(corpus_data) {
                corpus = corpus_data;

                // core metadata
                $('#corpus-name-span').html(corpus.name);
                $('#corpus-desc-span').html(corpus.description);
                $('#corpus-path-span').html(corpus.path);

                // user metadata
                let corpus_metadata_div = $('#corpus-metadata-div');
                for (let key in corpus.kvp) {
                    if (!key.startsWith("_") && (typeof(corpus.kvp[key]) == "string" || typeof(corpus.kvp[key]) == "boolean")) {
                        corpus_metadata_div.append(`
                            <div class="list-group-item">
                                <h5>${key}</h5>
                                ${corpus.kvp[key]}
                            </div>
                        `);
                    }
                }

                // load corpus files
                let corpus_files_div = $('#corpus-files-div');
                if (Object.keys(corpus.files).length > 0) {
                    corpus_files_div.html(`
                        <table class="table table-striped">
                            <thead class="thead-dark">
                                <th scope="col">
                                    File
                                </th>
                                <th scope="col">
                                    Description
                                </th>
                                <th scope="col">
                                    Extension
                                </th>
                                <th scope="col">
                                    Size (bytes)
                                </th>
                            </thead>
                            <tbody id="corpus-files-table-body">
                            </tbody>
                        </table>
                    `);

                    let corpus_files_tbody = $('#corpus-files-table-body');
                    for (let file_key in corpus.files) {
                        let file = corpus.files[file_key];

                        let file_url = corpora.file_url(file.uri);
                        if (file.is_image) {
                            file_url = corpora.image_url(file.uri);
                        }

                        let open_mode = 'target="_blank"';
                        if (file.extension === 'zip') {
                            open_mode = `download="${file.basename}"`;
                        }

                        corpus_files_tbody.append(`
                            <tr>
                                <td>
                                    <a href="${file_url}" target="_blank">${file.basename}</a>
                                </td>
                                <td>
                                    ${file.description}
                                </td>
                                <td>
                                    ${file.extension}
                                </td>
                                <td>
                                    ${file.byte_size}
                                </td>
                            </tr>
                        `);
                    }
                }

                if (role === 'Editor' || role === 'Admin') {
                    // setup the editor for importing a content type schema
                    import_editor = ace.edit("import-editor");
                    import_editor.setTheme("ace/theme/monokai");
                    import_editor.getSession().setMode("ace/mode/json");

                    // setup the editor for editing template
                    template_editor = ace.edit("template-editor");
                    template_editor.setTheme("ace/theme/monokai");
                    template_editor.getSession().setMode("ace/mode/django");

                    // setup event for showing schema import modal
                    $('#show-import-modal-button').click(function () {
                        import_editor.setValue('');
                        $('#import-modal-label').html('Import Schema');
                        $('#import-button').removeClass('d-none');
                        $('#import-modal').modal();
                    });

                    // setup event for clicking "Import" button on schema import modal
                    $('#import-button').click(function () {
                        let import_schema = JSON.parse(import_editor.getValue());
                        for (let x = 0; x < import_schema.length; x++) {
                            if (!corpus.content_types.hasOwnProperty(import_schema[x].name)) {
                                corpus.content_types[import_schema[x].name] = import_schema[x];
                                manage_content_type(import_schema[x].name);
                            }
                        }

                        $('#import-modal').modal('hide');
                    });

                    // setup event for saving the content type schema
                    $('#save-content-type-schema-button').click(function () {
                        $('#save-content-type-schema-button').attr('disabled', true);
                        let ct_schema = [];
                        for (let ct_name in corpus.content_types) {
                            ct_schema.push(corpus.content_types[ct_name]);
                        }
                        $('#ct-schema').val(JSON.stringify(ct_schema));
                        $('#ct-schema-form').submit();
                    });

                    // PEP8 CLASS FORMAT CONTENT TYPE NAME
                    $('#new-ct-name-box').focusout(function () {
                        $('#new-ct-name-box').val(pep8_class_format(pep8_variable_format($('#new-ct-name-box').val())));
                    });

                    // PEP8 VARIABLE FORMAT FIELD NAME
                    $('#new-f-name-box').focusout(function () {
                        $('#new-f-name-box').val(pep8_variable_format($('#new-f-name-box').val()));
                    });

                    // NEW CONTENT TYPE BUTTON CLICK
                    $('#new-ct-button').click(function () {
                        $('#new-ct-modal-label').html('Create Content Type');
                        $('#new-ct-index').val('new');
                        $('#new-ct-name-box').prop('disabled', false);
                        $('#new-ct-name-box').val('');
                        $('#new-ct-plural-name-box').val('');
                        $('#new-ct-nav-checkbox').prop('checked', true);
                        $('#new-ct-proxy-field-selector').val('');
                        $('#new-ct-proxy-field-div').addClass('d-none');
                        $('#new-ct-modal').modal();
                    });

                    // CREATE/EDIT CONTENT TYPE BUTTON CLICK
                    $('#new-ct-create-button').click(function () {
                        let ct_name = $('#new-ct-name-box').val();
                        if (!corpus.content_types.hasOwnProperty(ct_name)) {
                            corpus.content_types[ct_name] = {
                                id: '',
                                name: ct_name,
                                plural_name: $('#new-ct-plural-name-box').val(),
                                show_in_nav: $('#new-ct-nav-checkbox').is(':checked'),
                                proxy_field: '',
                                fields: [],
                                is_new: true,
                                templates: {
                                    Label: {
                                        template: {% verbatim %}`${ct_name} {{ ${ct_name}.id }}`{% endverbatim %},
                                        mime_type: "text/html"
                                    }
                                }
                            };
                        } else {
                            corpus.content_types[ct_name].plural_name = $('#new-ct-plural-name-box').val();
                            corpus.content_types[ct_name].show_in_nav = $('#new-ct-nav-checkbox').is(':checked');
                            corpus.content_types[ct_name].proxy_field = $('#new-ct-proxy-field-selector').val();
                        }

                        $('#new-ct-modal').modal('hide');
                        manage_content_type(ct_name);
                    });

                    // FIELD TYPE SELECTION CHANGE
                    $('#new-f-type-box').change(function () {
                        let selection = $(this).val();

                        if (selection == 'cross_reference') {
                            $('#new-f-cross-reference-box').removeClass('d-none');
                        } else {
                            $('#new-f-cross-reference-box').addClass('d-none');
                        }
                    });

                    // FIELD INDEXED CHECK CHANGE
                    $('#new-f-indexed-checkbox').change(function () {
                        if ($(this).is(':checked') && $('#new-f-indexed-with-box option').length > 0) {
                            $('#new-f-indexed-with-div').removeClass('d-none');
                            $('#new-f-indexed-with-div').addClass('d-flex');
                        } else {
                            $('#new-f-indexed-with-div').removeClass('d-flex');
                            $('#new-f-indexed-with-div').addClass('d-none');
                        }
                    });

                    // FIELD UNIQUE CHECK CHANGE
                    $('#new-f-unique-checkbox').change(function () {
                        if ($(this).is(':checked') && $('#new-f-unique-with-box option').length > 0) {
                            $('#new-f-unique-with-div').removeClass('d-none');
                            $('#new-f-unique-with-div').addClass('d-flex');
                        } else {
                            $('#new-f-unique-with-div').removeClass('d-flex');
                            $('#new-f-unique-with-div').addClass('d-none');
                        }
                    });

                    // CREATE FIELD BUTTON CLICK
                    $('#new-f-create-button').click(function () {
                        let cross_reference_type = '';
                        if ($('#new-f-type-box').val() == 'cross_reference') {
                            cross_reference_type = $('#new-f-cross-reference-box').val();
                        }

                        let field = {
                            name: $('#new-f-name-box').val(),
                            label: $('#new-f-label-box').val(),
                            in_lists: $('#new-f-in-lists-checkbox').is(':checked'),
                            indexed: $('#new-f-indexed-checkbox').is(':checked'),
                            indexed_with: $('#new-f-indexed-with-box').val(),
                            unique: $('#new-f-unique-checkbox').is(':checked'),
                            unique_with: $('#new-f-unique-with-box').val(),
                            multiple: $('#new-f-multiple-checkbox').is(':checked'),
                            cross_reference_type: cross_reference_type,
                            type: $('#new-f-type-box').val(),
                        };

                        let ct_name = $('#new-f-ct-name').val();
                        let f_index = $('#new-f-f-id').val();
                        let action = $('#new-f-action').val();

                        if (action === 'create' && f_index === 'new') {
                            corpus.content_types[ct_name].fields.push(field);
                            manage_field(ct_name, corpus.content_types[ct_name].fields.length - 1);
                        } else {
                            f_index = parseInt(f_index);
                            corpus.content_types[ct_name].fields[f_index] = field;
                            manage_field(ct_name, f_index);
                        }

                        $('#new-f-modal').modal('hide');
                    });

                    // TEMPLATE SAVE BUTTON
                    $(`#template-save-button`).click(function () {
                        let ct_name = $('#template-ct-name').val();
                        let template_name = $('#template-name').val();

                        corpus.content_types[ct_name].templates[template_name].template = template_editor.getValue();
                        corpus.content_types[ct_name].templates[template_name].mime_type = $('#template-mime-type').val();

                        $('#template-modal').modal('hide');
                    });

                    // BUILD CONTENT TABLES AND SETUP CONTENT TYPE MANAGER
                    if (corpus.content_types) {
                        $('#tm-ct-group').html('');
                    }

                    // HANDLE CORPUS DELETION EVENTS
                    $('#corpus-show-delete-confirmation-button').click(function () {
                        $('#corpus-deletion-name-span').html(corpus.name);
                        if ($(this).html() === "Delete Corpus") {
                            $('#corpus-deletion-confirmation-div').removeClass('d-none');
                            $(this).html("Cancel Corpus Deletion");
                        } else {
                            $('#corpus-deletion-confirmation-div').addClass('d-none');
                            $(this).html("Delete Corpus");
                        }
                    });

                    $('#corpus-delete-button').click(function () {
                        $('#corpus-deletion-form').submit();
                    });
                }

                for (let ct_name in corpus.content_types) {
                    build_content_table(ct_name);

                    if (role === 'Editor' || role === 'Admin') {
                        manage_content_type(ct_name);
                    }
                }

                // SETUP JOBS
                corpora.get_jobsites(function(jobsites_data) {
                    jobsites = jobsites_data;

                    if (role === 'Editor' || role === 'Admin') {
                        let jobsite_selector = $('#jobsite-selector');

                        for (let x = 0; x < jobsites.length; x++) {
                            jobsite_selector.append(`
                                <option value="${_id(jobsites[x])}" class="${jobsites[x]["type"]}">
                                    ${jobsites[x]["name"]}
                                </option>
                            `);
                            if (jobsites[x].name === 'Local') {
                                local_jobsite_id = _id(jobsites[x]);
                            }
                        }
                    }

                    corpora.get_tasks('Corpus', function(tasks_data) {
                        tasks = tasks_data.filter(function(value, index, arr) { return value.track_provenance; });

                        if (role === 'Editor' || role === 'Admin') {
                            load_tasks(local_jobsite_id);
                            $("#jobsite-selector").on("change", function () {
                                load_tasks($('#jobsite-selector :selected').val());
                            });

                            $('#run-job-button').click(function () {
                                $('#job-modal').modal();
                            });

                            $('#job-submit-button').click(function () {
                                $('#job-form').submit();
                            });
                        }

                        check_jobs();
                    });
                });

                let scroll_location = location.hash;
                location.hash = '';
                location.hash = scroll_location;
            });

            hide_loading_overlay();
        });

        function build_content_table(ct_name) {
            let ct_row = $("#content-types-div");
            let ct = corpus.content_types[ct_name];

            ct_row.append(`
                <div class="row">
                    <div class="col-12">
                        <a name="${ct.plural_name}"></a>
                        <div class="card mt-4">
                            <div class="card-header" style="padding: 0 !important;">
                                <div class="d-flex w-100 justify-content-between align-items-center text-nowrap" style="padding: 0.75rem 1.25rem;">
                                    <h4>${ct.plural_name}</h4>
                                    <div class="input-group ml-2 mr-2">
                                        <input type="text" class="form-control form-control" id="ct-${ct.name}-search-box" placeholder="Search" />
                                        <div class="input-group-append">
                                            <button id="ct-${ct.name}-search-setting-selection" class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">All Fields</button>
                                            <div id="ct-${ct.name}-search-settings-menu" class="dropdown-menu">
                                                <a class="dropdown-item ct-${ct.name}-search-setting" id="ct-${ct.name}-search-setting-default" href="#">All Fields</a>
                                            </div>
                                            <input type="hidden" id="ct-${ct.name}-search-setting-value" value="default" />
                                        </div>
                                    </div>

                                    <button id="ct-${ct.name}-search-clear-button" class="btn btn-primary rounded mr-2 d-none" type="button">Clear Search</button>
                                    ${ (role === 'Editor' || role === 'Admin') ? `<a role="button" id="ct-${ct.name}-new-button" href="/corpus/${corpus_id}/${ct.name}/" class="btn btn-primary rounded mr-2">New ${ct.name}</a>` : ''}

                                    <div class="form-inline mr-2">
                                        <select class="form-control btn-primary d-none" id="ct-${ct.name}-page-selector">
                                        </select>
                                    </div>

                                    <div class="form-inline mr-2">
                                        <select class="form-control btn-primary" id="ct-${ct.name}-per-page-selector">
                                            <option selected>5</option>
                                            <option>10</option>
                                            <option>20</option>
                                            <option>50</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="ct-${ct.name}-current-search-div" class="d-flex w-100 align-items-center p-2 pl-3 badge-secondary" style="padding-top: 12px !important;"></div>
                            </div>
                            <div class="card-body">
                                <table class="table table-striped">
                                    <thead class="thead-dark">
                                        <tr id="ct-${ct.name}-table-header-row">
                                        </tr>
                                    </thead>
                                    <tbody id="ct-${ct.name}-table-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `);

            // setup content type table headers
            let table_header_row = $(`#ct-${ct.name}-table-header-row`);
            table_header_row.append(`
                <th scope="col">
                </th>
            `);
            for (let x = 0; x < ct.fields.length; x++) {
                if (ct.fields[x].in_lists) {
                    table_header_row.append(`
                        <th scope="col">
                            <a href="javascript: ct_order_by('${ct.name}', '${ct.fields[x].type === 'cross_reference' ? ct.fields[x].name + '.label' : ct.fields[x].name}');"><h5>${ct.fields[x].label}</h5></a>
                        </th>
                    `);
                }
            }

            // setup content type search fields
            let search_settings_menu = $(`#ct-${ct.name}-search-settings-menu`);
            for (let x = 0; x < ct.fields.length; x++) {
                if (ct.fields[x].in_lists) {
                    search_settings_menu.append(`
                        <a class="dropdown-item ct-${ct.name}-search-setting" id="ct-${ct.name}-search-setting-${ct.fields[x].type === 'cross_reference' ? ct.fields[x].name + '.label' : ct.fields[x].name}" href="#">${ct.fields[x].label}</a>
                    `);
                }
            }
            $(`.ct-${ct.name}-search-setting`).click(function (event) {
                event.preventDefault();
                let field = event.target.id.replace(`ct-${ct.name}-search-setting-`, '');
                let label = $(this).text();

                $(`#ct-${ct.name}-search-setting-selection`).text(label);
                $(`#ct-${ct.name}-search-setting-value`).val(field);
            });

            // setup page selector events
            $(`#ct-${ct.name}-page-selector`).on("change", function () {
                ct_search[ct.name].page = parseInt($(`#ct-${ct.name}-page-selector`).val());
                corpora.list_content(corpus_id, ct.name, ct_search[ct.name], load_content);
            });

            $(`#ct-${ct.name}-per-page-selector`).on("change", function () {
                ct_search[ct.name]['page-size'] = parseInt($(`#ct-${ct.name}-per-page-selector`).val());
                corpora.list_content(corpus_id, ct.name, ct_search[ct.name], load_content);
            });

            // setup search events
            $(`#ct-${ct.name}-search-box`).keypress(function (e) {
                let key = e.which;
                if (key === 13) {
                    let query = $(`#ct-${ct.name}-search-box`).val();
                    let field = $(`#ct-${ct.name}-search-setting-value`).val();

                    if (field === 'default') {
                        ct_search[ct.name].q = query;
                    } else {
                        ct_search[ct.name]['q_' + field] = query;
                    }

                    $(`#ct-${ct.name}-search-clear-button`).removeClass('d-none');
                    corpora.list_content(corpus_id, ct.name, ct_search[ct.name], load_content);
                }
            });

            $(`#ct-${ct.name}-search-clear-button`).click(function (event) {
                $(`#ct-${ct.name}-search-box`).val('');
                for (let param in ct_search[ct.name]) {
                    if (ct_search[ct.name].hasOwnProperty(param)) {
                        if (param.startsWith("q")) {
                            delete ct_search[ct.name][param];
                        }
                    }
                }
                $(`#ct-${ct.name}-search-setting-selection`).text("All Fields");
                $(`#ct-${ct.name}-search-setting-value`).val('default');

                corpora.list_content(corpus_id, ct.name, ct_search[ct.name], load_content);
            });

            // default search settings
            ct_search[ct.name] = {
                'page': 1,
                'page-size': 5,
            };

            // perform initial query of content based on search settings
            corpora.list_content(corpus_id, ct.name, ct_search[ct.name], load_content);
        }

        // callback function for loading a page of content returned by corpora.list_content
        function load_content(content) {
            let ct = corpus.content_types[content.meta.content_type];
            $('#save-content-type-schema-button').attr('disabled', false);

            // instantiate some variables to keep track of elements
            let ct_table_body = $(`#ct-${ct.name}-table-body`); // <-- the table body for listing results
            let page_selector = $(`#ct-${ct.name}-page-selector`); // <-- the page select box
            let per_page_selector = $(`#ct-${ct.name}-per-page-selector`); // <-- the page size select box
            let current_search_div = $(`#ct-${ct.name}-current-search-div`); // <-- the search criteria div

            // clear the table body, page selector, and search criteria div
            ct_table_body.html('');
            page_selector.html('');
            current_search_div.html('');

            // add the total number of results to the search criteria div
            current_search_div.append(`
                <span class="badge badge-primary p-2 mr-2" style="font-size: 12px;">
                    Total: ${content.meta.total}
                </span>
            `);

            // add existing search criteria to the div
            let has_filtering_criteria = false;
            for (let search_setting in ct_search[ct.name]) {
                if (ct_search[ct.name].hasOwnProperty(search_setting) && (search_setting === 'q' || search_setting.startsWith('q_') || search_setting.startsWith('s_'))) {
                    let setting_type = 'Searching';
                    let field = "";
                    let field_name = "";
                    let search_value = `"${ct_search[ct.name][search_setting]}"`;

                    if (search_setting !== 'q') {
                        field = search_setting.substring(2);
                        if (field.includes('.')) { field = field.split('.')[0]; }

                        for (let x = 0; x < ct.fields.length; x++) {
                            if (ct.fields[x].name === field) {
                                field_name = ct.fields[x].label;
                            }
                        }

                        if (search_setting.startsWith('s_')) {
                            setting_type = 'Sorting';
                            search_value = "";

                        }
                    }

                    if (setting_type === 'Searching') { has_filtering_criteria = true; }

                    current_search_div.append(`
                        <span class="badge badge-primary p-2 mr-2" style="font-size: 12px;">
                            ${setting_type} ${field_name} ${search_value}
                            <a class="text-white" href="javascript: ct_remove_search_param('${ct.name}', '${search_setting}');"><i class="far fa-times-circle"></i></a>
                        </span>
                    `);
                }
            }

            // if there are no search results, show a default message
            if (content.records.length < 1) {
                let no_records_msg = `There are currently no ${ct.plural_name} in this corpus. Click the "New ${ct.name}" button above to create one.`;
                if (has_filtering_criteria) {
                    no_records_msg = `No ${ct.plural_name} in this corpus match your search criteria.`;
                }

                let num_cols = 1;
                for (let x = 0; x < ct.fields.length; x++) {
                    if (ct.fields[x].in_lists) {
                        num_cols += 1;
                    }
                }

                let row_html = `
                    <tr>
                        <td colspan="${num_cols}">
                            <div class="alert alert-warning">
                                ${no_records_msg}
                            </div>
                        </td>
                    </tr>
                `;
                ct_table_body.append(row_html);

                page_selector.addClass("d-none");
                per_page_selector.addClass("d-none");

            // records exist, so populate the content type table with a page of results
            } else {
                // setup the page selector based on total # of pages
                for (let x = 1; x <= content.meta.num_pages; x++) {
                    let option_html = `<option value="${x}">Page ${x}</option>`;
                    if (x === content.meta.page) {
                        option_html = option_html.replace('">', '" selected>');
                    }
                    page_selector.append(option_html);
                }
                page_selector.removeClass("d-none");
                per_page_selector.removeClass("d-none");
                per_page_selector.val(ct_search[ct.name]['page-size'].toString());

                // iterate through the records, adding a row for each one
                content.records.forEach(item => {
                    let row_html = `
                        <tr>
                            <td>
                                <a href="${item.uri}" target="_blank">
                                    <span class="fas fa-external-link-square-alt"></span>
                                </a>
                            </td>
                    `;

                    for (let x in ct.fields) {
                        let field = ct.fields[x];
                        if (field.in_lists) {
                            let value = '';
                            if (item.hasOwnProperty(field.name)) {
                                value = item[field.name]
                            }

                            if (field.cross_reference_type && value) {
                                if (field.multiple) {
                                    let multi_value = '';
                                    for (let y in value) {
                                        multi_value += `, <a href="${value[y].uri}" target="_blank">${value[y].label}</a>`;
                                    }
                                    if (multi_value) {
                                        multi_value = multi_value.substring(2);
                                    }
                                    value = multi_value;
                                } else {
                                    value = `<a href="${value.uri}" target="_blank">${value.label}</a>`;
                                }
                            } else if (field.multiple) {
                                if (field.type == 'text' || field.type == 'keyword') {
                                    value = value.join(' ');
                                }
                                else {
                                    let multi_value = '';
                                    for (let y in value) {
                                        multi_value += `, ${value[y]}`;
                                    }
                                    if (multi_value) {
                                        multi_value = multi_value.substring(2);
                                    }
                                    value = multi_value;
                                }
                            }

                            row_html += `
                                <td style="width: auto;">
                                    ${value}
                                </td>`;
                        }
                    }

                    row_html += "</tr>";
                    ct_table_body.append(row_html);
                });
            }
        }

        function ct_order_by(ct_name, field) {
            let key = "s_" + field;
            if (ct_search[ct_name].hasOwnProperty(key)) {
                if (ct_search[ct_name][key] === 'asc') {
                    ct_search[ct_name][key] = 'desc';
                } else {
                    ct_search[ct_name][key] = 'asc';
                }
            } else {
                ct_search[ct_name][key] = 'asc';
            }
            corpora.list_content(corpus_id, ct_name, ct_search[ct_name], load_content);
        }

        function ct_remove_search_param(ct_name, param) {
            if (ct_search[ct_name].hasOwnProperty(param)) {
                delete ct_search[ct_name][param];
                corpora.list_content(corpus_id, ct_name, ct_search[ct_name], load_content);
            }
        }

        function manage_content_type(ct_name) {
            let ct_div_prefix = `tm-ct-${ct_name}`;

            if ($(`#${ct_div_prefix}-container`).length === 0) {
                let delete_or_lock_button = `<button id="${ct_div_prefix}-delete-button" class="btn btn-sm btn-danger"><span class="fas fa-trash-alt"></span></button>`;
                if (corpus.content_types[ct_name].inherited) {
                    delete_or_lock_button = `<button class="btn btn-sm btn-danger" disabled><span class="fas fa-lock"></span></button>`;
                }

                $('#tm-ct-group').append(`
                    <div id="${ct_div_prefix}-container" class="list-group-item content-type">
                        <button id="${ct_div_prefix}-button" class="btn btn-sm btn-link" data-toggle="collapse" data-target="#${ct_div_prefix}" aria-expanded="false" aria-controls="${ct_div_prefix}">
                            <span id="${ct_div_prefix}-indicator" class="fas fa-caret-right"></span>
                            <h5 id="${ct_div_prefix}-name" style="display: inline;">${ct_name}</h5>
                        </button>
                        <span class="float-right">
                            <button id="${ct_div_prefix}-edit-button" class="btn btn-sm btn-primary"><span class="fas fa-edit"></span></button>
                            ${delete_or_lock_button}
                        </span>
                        <div id="${ct_div_prefix}" class="alert alert-info collapse p-3 mt-2" aria-labelledby="${ct_div_prefix}-container" data-parent="#tm-ct-group">
                            <h5 class="mb-2">Fields</h5>
                            <table class="table table-striped">
                                <thead class="thead-dark">
                                    <th scope="col">Name</th>
                                    <th scope="col">Label</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">In Lists?</th>
                                    <th scope="col">Indexed?</th>
                                    <th scope="col">Unique?</th>
                                    <th scope="col">Multiple?</th>
                                    <th scope="col"></th>
                                </thead>
                                <tbody id="${ct_div_prefix}-f-table">
                                    <tr><td colspan="8">No fields have been defined.</td></tr>
                                </tbody>
                            </table>
                            <button type="button" class="btn btn-primary" id="${ct_div_prefix}-new-f-button">New Field</button>
                            <span class="ml-2">
                                Edit Template: <select id="${ct_div_prefix}-edit-template-selector"></select>
                                <button type="button" class="btn btn-sm btn-secondary ml-2" id="${ct_div_prefix}-edit-template-button">Go</button>
                                <button type="button" class="btn btn-sm btn-secondary ml-2" id="${ct_div_prefix}-new-template-button">New Template</button>
                            </span>
                        </div>
                    </div>
                `);

                // SETUP TEMPLATE SELECTION FOR TEMPLATE EDITOR
                for (let template in corpus.content_types[ct_name].templates) {
                    $(`#${ct_div_prefix}-edit-template-selector`).append(`
                        <option value="${template}">${template}</option>
                    `);
                }

                // SETUP COLLAPSE ICONS
                $(`#${ct_div_prefix}`).on('show.bs.collapse', function (event) {
                    let indicator = $(`#${ct_div_prefix}-indicator`);
                    indicator.removeClass("fa-caret-right");
                    indicator.addClass("fa-caret-down");
                });
                $(`#${ct_div_prefix}`).on('hidden.bs.collapse', function (event) {
                    let indicator = $(`#${ct_div_prefix}-indicator`);
                    indicator.removeClass("fa-caret-down");
                    indicator.addClass("fa-caret-right");
                });

                // ADD CONTENT TYPE TO CROSS REFERENCE OPTIONS
                $('#new-f-cross-reference-box').append(`
                    <option value='${ct_name}'>${ct_name}</option>
                `);

                // EDIT CONTENT TYPE BUTTON
                $(`#${ct_div_prefix}-edit-button`).click(function() {
                    $('#new-ct-modal-label').html('Edit Content Type');

                    $('#new-ct-name').val(ct_name);
                    $('#new-ct-name-box').val(corpus.content_types[ct_name].name);
                    $('#new-ct-name-box').prop('disabled', true);
                    $('#new-ct-plural-name-box').val(corpus.content_types[ct_name].plural_name);
                    $('#new-ct-nav-checkbox').prop('checked', corpus.content_types[ct_name].show_in_nav);

                    let has_xrefs = false;
                    let proxy_field_selector = $('#new-ct-proxy-field-selector');
                    let proxy_field_div = $('#new-ct-proxy-field-div');
                    proxy_field_selector.html('');
                    proxy_field_selector.append(`
                        <option value=''>None</option>
                    `);
                    for (let x = 0; x < corpus.content_types[ct_name].fields.length; x++) {
                        if (corpus.content_types[ct_name].fields[x].type === 'cross_reference') {
                            has_xrefs = true;
                            proxy_field_selector.append(`
                                <option value='${corpus.content_types[ct_name].fields[x].name}'>${corpus.content_types[ct_name].fields[x].label}</option>
                            `);
                        }
                    }
                    proxy_field_selector.val(corpus.content_types[ct_name].proxy_field);
                    if (has_xrefs) { proxy_field_div.removeClass('d-none'); } else { proxy_field_div.addClass('d-none'); }

                    $('#new-ct-modal').modal();
                });

                // DELETE CONTENT TYPE BUTTON
                $(`#${ct_div_prefix}-delete-button`).click(function() {
                    if (!corpus.content_types[ct_name].inherited) {
                        if (!corpus.content_types[ct_name].hasOwnProperty('is_new')) {
                            $(`#${ct_div_prefix}-delete-button`).click(function () {
                                $('#confirmation-ct-name').val(ct_name);
                                $('#confirmation-field-index').val('');
                                $('#confirmation-field-name').val('');
                                $('#confirmation-action').val('delete');
                                $('#confirmation-confirm-button').attr('disabled', false);

                                let message = `You are attempting to delete the <b>${ct_name}</b> content type.
                                Upon doing so, <b>all content of this type will be irreversibly deleted</b>. Some templates may also need to be
                                regenerated or manually adjusted. Are you sure you want to proceed?`;

                                let referencing_fields = [];
                                for (let x in corpus.content_types) {
                                    for (let y = 0; y < corpus.content_types[x].fields.length; y++) {
                                        if (corpus.content_types[x].fields[y].cross_reference_type === ct_name) {
                                            referencing_fields.push(`${x} -> ${corpus.content_types[x].fields[y].name}`);
                                        }
                                    }
                                }

                                if (referencing_fields.length > 0) {
                                    message = `
                                        You are attempting to delete the ${ct_name} content type.
                                        This is currently not possible, as the following fields reference this content type:<ul class="mt-2">
                                    `;
                                    referencing_fields.map(x => message += `<li>${x}</li>`);
                                    message += `
                                        </ul>If you still wish to delete the ${ct_name} content type,
                                        you must first delete the above fields.
                                    `;
                                    $('#confirmation-confirm-button').attr('disabled', true);
                                }

                                $('#confirmation-modal-message').html(message);
                                $('#confirmation-modal').modal();
                            });
                        } else {
                            delete corpus.content_types[ct_name];
                            $(`#${ct_div_prefix}-container`).remove();
                        }
                    }
                });

                // NEW FIELD BUTTON
                $(`#${ct_div_prefix}-new-f-button`).click(function (){
                    $('#new-f-modal-label').html('Create New Field');
                    $('#new-f-ct-name').val(ct_name);
                    $('#new-f-f-id').val('new');
                    $('#new-f-action').val('create');
                    $('#new-f-name-box').val('');
                    $('#new-f-name-box').prop('disabled', false);
                    $('#new-f-label-box').val('');
                    $('#new-f-type-box').val('text');
                    $('#new-f-in-lists-checkbox').prop('checked', true);
                    $('#new-f-indexed-checkbox').prop('checked', false);
                    $('#new-f-unique-checkbox').prop('checked', false);
                    $('#new-f-multiple-checkbox').prop('checked', false);
                    $('#new-f-create-button').html('Create');

                    $('.f-with').html('');
                    for (let x = 0; x < corpus.content_types[ct_name].fields.length; x++) {
                        $('.f-with').append(`
                            <option value='${corpus.content_types[ct_name].fields[x].name}'>${corpus.content_types[ct_name].fields[x].label}</option>
                        `);
                    }

                    $('#new-f-indexed-with-box').val([]);
                    $('#new-f-indexed-with-div').removeClass('d-flex');
                    $('#new-f-indexed-with-div').addClass('d-none');
                    $('#new-f-unique-with-box').val([]);
                    $('#new-f-unique-with-div').removeClass('d-flex');
                    $('#new-f-unique-with-div').addClass('d-none');
                    $('#new-f-cross-reference-box').addClass('d-none');

                    $('#new-f-create-button').html('Create');
                    $('#new-f-modal').modal();
                });

                // EDIT TEMPLATE BUTTON
                $(`#${ct_div_prefix}-edit-template-button`).click(function (){
                    let template_name = $(`#${ct_div_prefix}-edit-template-selector`).val();
                    $('#template-ct-name').val(ct_name);
                    $('#template-name').val(template_name);

                    template_editor.setValue(corpus.content_types[ct_name].templates[template_name].template);
                    $('#template-mime-type').val(corpus.content_types[ct_name].templates[template_name].mime_type);

                    $('#template-modal').modal();
                });

                // FOCUS TEMPLATE EDITOR ON MODAL SHOWN EVENT
                $('#template-modal').on('shown.bs.modal', function() {
                    template_editor.focus();
                    template_editor.gotoLine(1);
                });

                // NEW TEMPLATE BUTTON
                $(`#${ct_div_prefix}-new-template-button`).click(function() {
                    $('#template-name').val('');
                    template_editor.setValue('');
                    $('#template-mime-type').val('text/html');
                });

                // ADD FIELDS
                for (let f_index = 0; f_index < corpus.content_types[ct_name].fields.length; f_index++) {
                    if (f_index === 0) {
                        $(`#${ct_div_prefix}-f-table`).html('');
                    }
                    manage_field(ct_name, f_index);
                }
            }
        }

        function manage_field(ct_name, f_index) {
            let ct = corpus.content_types[ct_name];
            let f_table = $(`#tm-ct-${ct_name}-f-table`);
            let f_div_prefix = `tm-ct-${ct_name}-f-${f_index}`;
            let field_type_display = '';
            switch (ct.fields[f_index].type) {
                case 'cross_reference':
                    field_type_display = ct.fields[f_index].cross_reference_type;
                    break;
                default:
                    field_type_display = FIELD_TYPE_LABELS[ct.fields[f_index].type];
                    break;
            }

            let indexed_display = ct.fields[f_index].indexed ? 'Y' : 'N';
            if (ct.fields[f_index].indexed_with.length > 0) {
                indexed_display += '['
                for (let x = 0; x < ct.fields[f_index].indexed_with.length; x++) {
                    indexed_display += ct.fields[f_index].indexed_with[x] + ', ';
                }
                indexed_display = indexed_display.slice(0, -2) + ']';
            }

            let unique_display = ct.fields[f_index].unique ? 'Y' : 'N';
            if (ct.fields[f_index].unique_with.length > 0) {
                unique_display += '['
                for (let x = 0; x < ct.fields[f_index].unique_with.length; x++) {
                    unique_display += ct.fields[f_index].unique_with[x] + ', ';
                }
                unique_display = unique_display.slice(0, -2) + ']';
            }

            if ($(`#${f_div_prefix}-row`).length === 0) {
                // Clear "No fields defined message"
                if (ct.fields.length === 1) {
                    f_table.html('');
                }

                let delete_or_lock_button = `<button type="button" class="btn btn-sm btn-danger m-1" id="${f_div_prefix}-delete-button"><span class="fas fa-trash-alt"></span></button>`;
                if (ct.fields[f_index].inherited) {
                    delete_or_lock_button = `<button type="button" class="btn btn-sm btn-danger m-1" disabled><span class="fas fa-lock"></button>`;
                }

                f_table.append(`
                    <tr id="${f_div_prefix}-row">
                        <td id="${f_div_prefix}-name" class="font-weight-bold">${ct.fields[f_index].name}</td>
                        <td id="${f_div_prefix}-label">${ct.fields[f_index].label}</td>
                        <td id="${f_div_prefix}-type">${field_type_display}</td>
                        <td id="${f_div_prefix}-in-lists">${ct.fields[f_index].in_lists ? 'Y' : 'N'}</td>
                        <td id="${f_div_prefix}-indexed">${indexed_display}</td>
                        <td id="${f_div_prefix}-unique">${unique_display}</td>
                        <td id="${f_div_prefix}-multiple">${ct.fields[f_index].multiple ? 'Y' : 'N'}</td>
                        <td id="${f_div_prefix}-actions">
                            <div class="d-flex flex-wrap flex-row">
                                <button type="button" class="btn btn-sm btn-primary m-1" id="${f_div_prefix}-edit-button"><span class="fas fa-edit"></span></button>
                                ${delete_or_lock_button}
                                <button type="button" class="btn btn-sm btn-danger m-1" id="${f_div_prefix}-shift-up-button"><span class="fas fa-caret-up"></span></button>
                            </div>
                        </td>
                    </tr>
                `);

                // EDIT FIELD BUTTON CLICK
                $(`#${f_div_prefix}-edit-button`).click(function () {
                    $('#new-f-modal-label').html('Edit Field');
                    $('#new-f-ct-name').val(ct_name);
                    $('#new-f-f-id').val(f_index);
                    $('#new-f-action').val('edit');
                    $('#new-f-name-box').val(ct.fields[f_index].name);
                    $('#new-f-name-box').prop('disabled', true);
                    $('#new-f-label-box').val(ct.fields[f_index].label);
                    $('#new-f-type-box').val(ct.fields[f_index].type);
                    if (ct.fields[f_index].type === 'cross_reference') {
                        $('#new-f-cross-reference-box').removeClass('d-none');
                        $('#new-f-cross-reference-box').val(ct.fields[f_index].cross_reference_type);
                    } else {
                        $('#new-f-cross-reference-box').addClass('d-none');
                    }

                    $('.f-with').html('');
                    for (let x = 0; x < ct.fields.length; x++) {
                        if (ct.fields[x].name !== ct.fields[f_index].name) {
                            $('.f-with').append(`
                                <option value='${ct.fields[x].name}'>${ct.fields[x].label}</option>
                            `);
                        }
                    }

                    $('#new-f-indexed-checkbox').prop('checked', ct.fields[f_index].indexed);
                    $('#new-f-indexed-with-box').val(ct.fields[f_index].indexed_with);
                    if (ct.fields[f_index].indexed) {
                        $('#new-f-indexed-with-div').addClass('d-flex');
                        $('#new-f-indexed-with-div').removeClass('d-none');
                    } else {
                        $('#new-f-indexed-with-div').removeClass('d-flex');
                        $('#new-f-indexed-with-div').addClass('d-none');
                    }

                    $('#new-f-unique-checkbox').prop('checked', ct.fields[f_index].unique);
                    $('#new-f-unique-with-box').val(ct.fields[f_index].unique_with);
                    if (ct.fields[f_index].unique) {
                        $('#new-f-unique-with-div').addClass('d-flex');
                        $('#new-f-unique-with-div').removeClass('d-none');
                    } else {
                        $('#new-f-unique-with-div').removeClass('d-flex');
                        $('#new-f-unique-with-div').addClass('d-none');
                    }

                    $('#new-f-in-lists-checkbox').prop('checked', ct.fields[f_index].in_lists);
                    $('#new-f-multiple-checkbox').prop('checked', ct.fields[f_index].multiple);
                    $('#new-f-create-button').html('Edit');

                    if (ct.fields[f_index].inherited) {
                        $('#new-f-type-box').attr('disabled', true);
                        $('#new-f-indexed-checkbox').attr('disabled', true);
                        $('#new-f-unique-checkbox').attr('disabled', true);
                        $('#new-f-multiple-checkbox').attr('disabled', true);
                    } else {
                        $('#new-f-type-box').attr('disabled', false);
                        $('#new-f-indexed-checkbox').attr('disabled', false);
                        $('#new-f-unique-checkbox').attr('disabled', false);
                        $('#new-f-multiple-checkbox').attr('disabled', false);
                    }

                    $('#new-f-modal').modal();
                });

                // FIELD DELETE BUTTON CLICK
                if (!ct.fields[f_index].inherited) {
                    $(`#${f_div_prefix}-delete-button`).click(function () {
                        $('#confirmation-ct-index').val(sender.index);
                        $('#confirmation-ct-name').val(sender.name);
                        $('#confirmation-field-index').val(f_index);
                        $('#confirmation-field-name').val(ct.fields[f_index].name);
                        $('#confirmation-action').val('delete');
                        $('#confirmation-confirm-button').attr('disabled', false);

                        let message = `You are attempting to delete the <b>${sender.name} -> ${ct.fields[f_index].name}</b> field.
                    Upon doing so, <b>all content stored in this field will be irreversibly deleted</b>. Some templates may also need to be
                    regenerated or manually adjusted. Are you sure you want to proceed?`;

                        if (ct.fields.length === 1) {
                            message = `You are attempting to delete the <b>${sender.name} -> ${ct.fields[f_index].name}</b> field.
                        This is currently not possible, as all content types must have at least one field. Please create another field for
                        this content type before deleting this field.`;
                            $('#confirmation-confirm-button').attr('disabled', true);
                        }

                        $('#confirmation-modal-message').html(message);
                        $('#confirmation-modal').modal();
                    });
                }

                // FIELD SHIFT UP BUTTON
                $(`#${f_div_prefix}-shift-up-button`).click(function () {
                    $('#confirmation-ct-index').val(sender.index);
                    $('#confirmation-ct-name').val(sender.name);
                    $('#confirmation-field-index').val(f_index);
                    $('#confirmation-field-name').val(ct.fields[f_index].name);
                    $('#confirmation-action').val('shift_up');
                    $('#confirmation-confirm-button').attr('disabled', false);

                    let message = `You are attempting to shift the <b>${sender.name} -> ${ct.fields[f_index].name}</b> field up
                    in position. This will affect the order in which fields appear in lists, views, etc. Are you sure you want to proceed?`;

                    if (f_index === 0) {
                        message = `You are attempting to shift the <b>${sender.name} -> ${ct.fields[f_index].name}</b> field up
                        in position. This is currently not possible, as that field already occupies the first position.`;
                        $('#confirmation-confirm-button').attr('disabled', true);
                    }

                    $('#confirmation-modal-message').html(message);
                    $('#confirmation-modal').modal();
                });
            } else {
                $(`#${f_div_prefix}-name`).html(ct.fields[f_index].name);
                $(`#${f_div_prefix}-label`).html(ct.fields[f_index].label);
                $(`#${f_div_prefix}-type`).html(field_type_display);
                $(`#${f_div_prefix}-indexed`).html(indexed_display);
                $(`#${f_div_prefix}-unique`).html(unique_display);
                $(`#${f_div_prefix}-in-lists`).html(ct.fields[f_index].in_lists ? 'Y' : 'N');
                $(`#${f_div_prefix}-multiple`).html(ct.fields[f_index].multiple ? 'Y' : 'N');
            }
        }

        // FILE UPLOAD FUNCTIONALITY
        $('#import-corpus-files-button').click(function() {
            upload_file();
        });

        function upload_file(path='', filter='', select='file') {
            corpora.get_corpus_files(corpus_id, path, filter, function (data) {
                file_upload_path = path;

                let url = `/api/corpus/${corpus_id}/files/`;

                import_corpus_file_pond.setOptions({
                    server: {
                        process: {
                            url: `${url}?path=${path}`,
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}'
                            }
                        },
                        fetch: null,
                        revert: null
                    }
                });
                import_corpus_file_pond.removeFiles();
                file_uploads = [];

                $('#file-upload-modal-table-body').html('');
                $('#file-upload-modal-table-header').html(path + '/');
                if (path) {
                    let up_directory = '/' + path.split('/').slice(1, -1).join('/');
                    if (up_directory === '/') { up_directory = ''; }
                    if (select === 'file') {
                        $('#file-upload-modal-table-header').append(`<a href="javascript:upload_file('${up_directory}');" style="color: white;"><span class="fas fa-level-up-alt float-right"></span></a>`);
                    } else {
                        $('#file-upload-modal-table-header').append(`<a href="javascript:upload_file('${up_directory}', '', 'dir');" style="color: white;"><span class="fas fa-level-up-alt float-right"></span></a>`);
                    }
                }
                for (let x = 0; x < data.length; x++) {
                    if(select === 'file') {
                        if (data[x].type === 'file') {
                            $('#file-upload-modal-table-body').append(`
                                <tr><td>${data[x].filename}</td></tr>
                            `);
                        } else {
                            $('#file-upload-modal-table-body').append(`
                                <tr><td><span class="fas fa-folder-open"></span> ${data[x].filename} <a class="btn btn-sm btn-primary text-white float-right" role="button" href="javascript:upload_file('${data[x].path}');">Browse</a></td></tr>
                            `);
                        }
                    } else {
                        if (data[x].type === 'dir') {
                            $('#file-upload-modal-table-body').append(`
                                <tr><td><span class="fas fa-folder-open"></span> <a href="javascript:handle_file_upload('${data[x].path}', '');">${data[x].filename}</a> <a class="btn btn-sm btn-primary text-white float-right" role="button" href="javascript:upload_file(file_upload_input_id, '${data[x].path}', '', 'dir');">Browse</a></td></tr>
                            `);
                        }
                    }
                }

                $('#file-upload-modal').modal();
            });
        }

        function handle_folder_creation() {
            let dirname = pep8_variable_format($('#file-upload-modal-new-folder-box').val());
            corpora.make_corpus_file_dir(corpus_id, file_upload_path, dirname, function() {
                $('#file-upload-modal-new-folder-box').val('');
                upload_file(path=file_upload_path);
            });
        }

        $('#file-upload-reset-button').click(function() {
            let import_button = $('#file-upload-import-button');

            import_files = [];
            import_button.html('Import');
            import_button.attr('disabled', true);
        });

        $('#file-upload-import-button').click(function() {
            $('#import-corpus-files').val(JSON.stringify(import_files));
            $('#import-corpus-files-form').submit();
        });

        // JOB FUNCTIONALITY
        function load_tasks(jobsite_id) {
            let task_selector = $('#task-selector');
            task_selector.html('');

            for (let js_index = 0; js_index < jobsites.length; js_index ++) {
                if (_id(jobsites[js_index]) === jobsite_id) {
                    let jobsite_type = jobsites[js_index].type;
                    let tasks_populated = 0;
                    for (let t_index = 0; t_index < tasks.length; t_index ++) {
                        if(tasks[t_index].jobsite_type === jobsite_type) {
                            task_selector.append(`
                                <option value="${_id(tasks[t_index])}">
                                    ${tasks[t_index]["name"]}
                                </option>
                            `);

                            if (tasks_populated === 0) {
                                load_task_parameters(tasks[t_index]);
                            }
                            tasks_populated += 1;
                        }
                    }

                    if (tasks_populated > 0) {
                        $(`#task-selector-div`).removeClass("d-none");
                        $(`#job-submit-button`).attr('disabled', false);
                    } else {
                        $(`#task-selector-div`).addClass("d-none");
                        $(`#job-submit-button`).attr('disabled', true);
                    }
                }
            }
        }

        function load_task_parameters(task) {
            $('#task-parameters-div').html('');

            let parameters = task['configuration']['parameters'];
            for (let parameter in parameters) {
                if (parameters[parameter].hasOwnProperty('type')) {
                    console.log('handling parameter ' + parameter);
                    let parameter_html = '';
                    let note_html = '';
                    if (parameters[parameter].hasOwnProperty('note')) {
                        note_html = `<span class='text-muted'>${parameters[parameter]['note']}</span>`;
                    }

                    if (parameters[parameter]['type'] === 'corpus_file') {
                        let select_options = '';
                        Object.keys(corpus.files).forEach(file_key => {
                            select_options += `<option value="${file_key}">${corpus.files[file_key].basename}</option>`;
                        });

                        parameter_html = `
                            <div class="form-group">
                                <label for="corpus-file-selector">${parameters[parameter]['label']}</label>
                                <select id="corpus-file-selector" class="form-control" name="${parameter}">
                                    ${select_options}
                                </select>
                                ${note_html}
                            </div>
                        `;
                    } else if (parameters[parameter]['type'] === 'choice' && parameters[parameter].hasOwnProperty('choices')) {
                        let select_options = '';
                        parameters[parameter]['choices'].forEach(choice => {
                            select_options += `<option>${choice}</option>\n`;
                        });

                        parameter_html = `
                            <div class="form-group">
                                <label for="${parameter}-choice-selector">${parameters[parameter]['label']}</label>
                                <select id="${parameter}-choice-selector" class="form-control" name="${parameter}">
                                    ${select_options}
                                </select>
                                ${note_html}
                            </div>
                        `;
                    } else if (parameters[parameter]['type'] === 'text') {
                        parameter_html = `
                            <div class="form-group">
                                <label for="${parameter}-text-box">${parameters[parameter]['label']}</label>
                                <input type="text" class="form-control" id="${parameter}-text-box" name="${parameter}" />
                                ${note_html}
                            </div>
                        `;
                    }

                    $('#task-parameters-div').append(parameter_html);
                }
            }
        }

        function check_jobs() {
            corpora.get_corpus_jobs(corpus_id, function(jobs) {
                let has_running = false;
                let has_completed = false;
                let stale_jobs = [];
                $('.running-job').each(function(index, item) {
                    stale_jobs.push($(item).attr('id').replace('running-job-', '').replace('-div', ''));
                });

                for (let x = 0; x < jobs.length; x++) {
                    if (jobs[x].status == 'running' || jobs[x].status == 'preparing') {
                        let task_name = "";
                        for (let task_index = 0; task_index < tasks.length; task_index++) {
                            if (_id(tasks[task_index]) === jobs[x].task_id) {
                                task_name = tasks[task_index].name;
                                break;
                            }
                        }

                        if (!has_running) {
                            $('#running-jobs-div').html('');
                            has_running = true;
                        }

                        let job_id = jobs[x].id;
                        let progress_value = jobs[x].percent_complete;
                        if (jobs[x].status == 'preparing') {
                            progress_value = 0;
                        }
                        let label = `${progress_value}%`;
                        if (progress_value < 4) {
                            label = "";
                        }

                        if ($(`#running-job-${job_id}-div`).length) {
                            $(`#running-job-${job_id}-progress-bar`).css("width", progress_value);
                            $(`#running-job-${job_id}-progress-bar`).attr("aria-valuenow", progress_value);
                            $(`#running-job-${job_id}-progress-bar`).html(progress_value);
                        } else {
                            let job_html = `
                                <div id="running-job-${job_id}-div" class="alert alert-info running-job">
                                    Task: <b>${task_name}</b>
                                    <div class="progress">
                                        <div id="running-job-${job_id}-progress-bar"
                                             class="progress-bar progress-bar-striped bg-success progress-bar-animated"
                                             role="progressbar"
                                             aria-valuenow="${progress_value}"
                                             aria-valuemin="0"
                                             aria-valuemax="100"
                                             style="width: ${progress_value}%">
                                            ${label}
                                        </div>
                                    </div>
                                </div>
                            `;

                            $('#running-jobs-div').append(job_html);
                            stale_jobs = stale_jobs.filter(function (value, index, arr) {
                                return value != job_id;
                            });
                        }
                    }
                }

                for (let x = 0; x < stale_jobs.length; x++) {
                    $(`#running-job-${stale_jobs[x]}-div`).remove();
                    $('#job-finished-modal').modal();
                }

                if (!has_running && !$('#no-running-jobs-div').length) {
                    $('#running-jobs-div').append(`
                        <div id="no-running-jobs-div" class="alert alert-info">
                            There are currently no jobs running for this document.
                        </div>
                    `);
                }
            });

            check_jobs_timer = setTimeout(function() {
                check_jobs();
            }, check_jobs_interval * 1000);
        }
    </script>
{% endblock %}